<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="../build/css/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../build/css/ui-box.css">
    <link rel="stylesheet" href="../build/css/ui-base.css">
    <link rel="stylesheet" href="../build/css/ui-color.css">
    <link rel="stylesheet" href="../build/css/appcan.icon.css">
    <link rel="stylesheet" href="../build/css/appcan.control.css">
    <link rel="stylesheet" href="./css/intention.css">
    <style>
        .area-price {
            width: 20%;
        }
        .bc-bg {
            background-color: #fff;
        }
    </style>
</head>

<body class="um-vp bc-bg" ontouchstart>

    <div id="" class="listbox">
        <div id="listdetail" class="detail bc-border"></div>
        <div id="more"></div>
    </div>
    <div class="" id="pullstatus"></div>
    <!--footer-->
    <div id="footer" class="ub ubt bc-border uf tab-foot">
        <div id="" class="ub uw-a">
            <div id="" class="ub ub-pc ub-ac uw-1">
                <div id="" class="umar-l">
                    <div class="m-check" name="" id="checkall"></div>
                </div>
                <div id="" class="umar-l">
                    <span class="mf-size2">全选</span>
                </div>
            </div>

            <div id="sum_price" class="uw-2 ub ub-pe area-price">
                <span class="umar-r">
                    <span class="mf-size2 gray-font"></span>
                    <span class="mf-color">
                        <span id="heji"></span>
                    </span>
                </span>
            </div>

            <div id="confirmYXD" class="uw-3 ub ub-ac ub-pc sec-btn1" style="margin-right: 0.2em">
                审核通过
            </div>
            <div id="faliedYXD" class="uw-3 ub ub-ac ub-pc sec-btn1">
                审核不通过
            </div>
        </div>
    </div>
</body>

<script src="../build/js/appcan.js"></script>
<script src="../build/js/appcan.control.js"></script>
<script src="../common/common.js"></script>
<script type="text/javascript" charset="utf-8" src="../common/template-web.js"></script>
<script src="../common/jquery.min.js"></script>

<script id="Allorder_list" type="text/html">

    {{each list}}

    <div id="list{{$index}}" class='list-content bc-bg'>
        <div id='orderlist" + i + "'>

            <div id="isOrderCode{{$index}}" class='ub ub-ac umar-a m-row3'>
                <!-- 单选框 -->
                <div id="check{{$index}}" data-num="{{$index}}" class="checkBox bw0 ub ub-ac " onclick="cellbtnClick(this)">
                    <div id="{{$index}}" class="m-check singleSelection"></div>
                </div>
                <span class="gray-font ulev0">
                    &nbsp;订单编号
                </span>
                <span id="ordersaleCode">{{$value.ordersaleCode}}</span>
            </div>

            <div id='' class='ub ub-ac umar-a m-row3'>

                <div id='' class='ub ub-ac t-col1'>
                    <!-- 油品名称 -->

                    {{$value.oilinfoName}}

                    <input type="hidden" name="orderId" class="orderId" data-state={{$value.state}} data-orderId={{$value.orderId}} data-cusId={{$value.cusId}} data-oilAmot={{$value.oilAmot}}
                        data-gyfgs={{$value.gyfgs}} data-youhui={{$value.youhui}} data-orgType1={{$value.orgType1}} />

                </div>
                <div id='' class='ub ub-ac ub-pc t-col2'>
                    <span class='umar-r mf-color umar-r'>
                        <span class='mf-size2'>￥</span>
                        <!-- 油品价格 -->

                        {{if $value.oilPrice
                        <=0}} -- {{else}} {{$value.oilPrice | changeMoney}} {{/if}} <span class='gray-font mf-size2'>/吨</span>
                    </span>
                    <span class='umar-l'>
                        <!-- 油品数量-->
                        x {{if $value.oilNumber
                        <=0}} -- {{else}} {{$value.oilNumber}} {{/if}} </span>
                </div>
                <div id='type' class='ub ub-ac  ub-pc t-col4'>
                    <span class='s-state delivery'>
                        <!-- 配送方式 -->
                        {{$value.extractTypeName}}
                    </span>
                </div>
            </div>
        </div>

        <div id='pay' class='ub ub-ac umar-l umar-r m-row3'>
            <div id='' class='col-left'>
                <span class='gray-font'>客户名称&nbsp;&nbsp;</span>
                <span>
                    {{$value.cusCompany}}
                </span>
            </div>
            <div id='total' class='col-right'>
                <span class='gray-font'>总金额&nbsp;&nbsp;

                </span>
                <span class='mf-color AllPrice'>
                    {{if $value.oilAmot
                    <=0}} -- {{else}} {{$value.oilAmot | changeMoney}} {{/if}} </span>
            </div>

        </div>
        <div id='pay' class='ub ub-ac umar-l umar-r m-row3'>
            <div id='' class='col-left'>
                <span class='gray-font'>状态&nbsp;&nbsp;</span>
                <span>

                    {{if $value.state=='0'}} 未审核 {{else if $value.state == '1'}} 分公司审核通过{{else if $value.state == '2'}}分公司审核未通过 {{else if $value.state
                    == '3'}}审核通过 {{else if $value.state == '4'}}审核未通过 {{/if}}

                </span>
            </div>

            <div id='total' class='col-right'>
                <span class='gray-font'>按出库量结算&nbsp;&nbsp;</span>
                <span>{{$value.chukuliang}}</span>
            </div>
        </div>
        <div id='pay' class='ub ub-ac umar-l umar-r m-row3'>
            <div id='' class='col-left'>
                <span class='gray-font'>油库地点&nbsp;&nbsp;</span>
                <span>
                    {{$value.ykdd}}
                </span>
            </div>
            <div id='total' class='col-right'>
                <span class='gray-font'>运输方式&nbsp;&nbsp;

                </span>
                <span class='AllPrice'>
                    {{$value.transportTypeName}} </span>
            </div>

        </div>

        <!-- 油库地点 -->
        <div id='company' class='ub ub-ac umar-l umar-r m-row3'>

            <span class='gray-font'>创建时间 </span>
            <span class='AllPrice'>
                {{$value.createDate}}
            </span>

        </div>
        <div id="position{{$index}}"></div>
        <div class="gap" id="idx{{$index}}"></div>
    </div>

    {{/each}}
</script>
<script>
    var listData = {},
        listNum = 0,
        totalRows = 0,
        ISPAGE = false,
        dataLength = null,
        PASS_DATA = null,
        NOT_PASSED_DATA = null,
        trueSearchData = null; // 通过查询查询到的订单数据


    template.defaults.imports.changeMoney = function (value) {
        return fmoney(value)
    }
    // 当所有组件准备好后执行内部回调方法
    appcan.ready(function () {
        uexWindow.setWindowScrollbarVisible('false');

        appcan.frame.setBounce(1, function (type) {
            $("#pullstatus").html("");
        }, function (type) {
            $("#pullstatus").html("");
        }, function (type) {
            $("#pullstatus").html("松手了,产生事件了,开始更新数据！");
            // 下拉事件发生
            appcan.frame.resetBounce(1);
            // 当前总条数
            var num = Number(pageNo) * limit;


            $("#pullstatus").html("");
            // alert("totalRows=" + totalRows)

            if (Number(totalRows) <= num) {
                appcan.window.openToast({
                    msg: '没有更多',
                    duration: 1000,
                    position: 5,
                    type: 0
                });
                return;
            }

            newPageNo = Number(pageNo) + 1;

            alert('准备加载第' + newPageNo + '页')

            Order.queryOrderList(newPageNo);
        });
        Order.init();

    });
    //获取数据

    var Order = {
        init: function () {
            var y = this;
            y.queryOrderList();
        },
        queryOrderList: function (newPageNo) {

            // cusCompany 订单审核、结算单审核、配送自提审核，资金审核均增加查询 按客户查询；
            // cusCompany作为key值，传入客户名称进行模糊查询在原本的接口上
            var y = this;

            // 先判断searchData是否有数据
            var isSearchData = getVal("searchData");
            if (isSearchData != undefined && isSearchData != "0") {
                var result = JSON.parse(isSearchData);
                if (result.type === "toAudit") {
                    listData = result.data;
                    listNum = listData.length;
                    var html = template('Allorder_list', {
                        list: listData
                    })

                    $('#listdetail').append(html);

                    return;
                }
            } else if (isSearchData === "0") {
                nodata('listdetail', '您没有查询到未审核的订单！');
                return;
            }
            var pageNo = newPageNo || 1;
            var url = URL + "/app/oil/order/queryOrderList";
            var orgTypeText = getVal("companyType") === "总部" ? 'zongbu' : "";
            var paramJsonStr = "&pageNo=" + pageNo + "&pageSize=" + pageSize + "&orgId=" + getVal("orgId") +
                "&orgtype=" + orgTypeText + "&state=0";
            var func = y.getOrderListCallback.bind(y);
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('加载中...', '0', '5', '1');
        },
        getOrderListCallback: function (data) {
            appcan.window.closeToast();
            if (data === "") {
                nodata('listdetail', '您没有未审核的订单！');
                return;
            }
            if (typeof data === "string" && data != "") {
                var data = JSON.parse(data);
            }
            var totalCount = data.rows;
            listNum += totalCount.length;
            listData = data.rows;
            dataLength = listNum;

            // 处理过滤数据 默认显示未审核的的订单，已审核的不显示；

            if (totalCount.length == 0) {
                nodata('listdetail', '您没有未审核的订单！');
                return;
            } else {
                var html = template('Allorder_list', {
                    list: data.rows
                })

                $('#listdetail').append(html);

                // 分页器bug修改
                if (ISPAGE) {
                    var checkArr =$$('.checkBox');
                    var myCheckArr =$$('.singleSelection');
                    dataLength = checkArr.length;
                    checkArr.forEach(function (v, i) {
                        v.dataset.num = i;
                        myCheckArr[i].id=i;
                    })

                    if ($("#checkall")[0].className === "m-check m-check-active") {
                        CheckAll(); // 全选
                        $("#checkall")[0].className === "m-check m-check-active"
                    }

                }
                if (totalCount.length<pageSize || (dataLength <15 &&!getId("btn-load-more"))) {
                    document.querySelector(" .list-content:last-child .gap").style.height = "5em";
                }

                loadMore.init({
                    ele: "more",
                    data: listData,
                    totalNum: data["pager.totalRows"],
                    limit: 15,
                    clickFn: pager
                });

            }
        }

    }


    function pager(current_page, max_page, totalNum) {
        var y = this;
        $('#loadMore').remove();
        alert("正在加载第" + current_page + "页， 共" + max_page + "页 " + totalNum + "条数据")
        ISPAGE = true;
        Order.queryOrderList(current_page);
        appcan.window.openToast('数据加载中...', '0', '5', '1');
    }

    //单个，多个审核  通过
    appcan.button("#confirmYXD", "ani-act", function () {

        var oillist = [];
        var orderIdArr = [],
            cusIds = [],
            b2s = [],
            gyfgss = [],
            youhui = [],
            orgType = [];
        var youhuiNum=0; // 计算 stateYesZhong 的个数，订单全部为 stateYesZhong 状态时多个审批，否则单个审批
       
        for (var i = 0; i < listNum; i++) {
            if (getId(i).className == "m-check singleSelection m-check-active") {
                var element = $$('.orderId')[i];
                var itemData = element.dataset;
                if (itemData.orderid && itemData.state != 0) {
                    uexWindow.alert("提示", "只能审核状态为未审核的，请重新选择！", "确定");
                    return;
                }
                // TODO: stateYesZhong 需要考虑提价总公司进行审批
                // TODO:测试 stateYes
                if(itemData.youhui === "stateYesZhong"){
                 youhuiNum++;
                }
                orderIdArr.push(itemData.orderid);
                cusIds.push(itemData.cusid);
                b2s.push(itemData.oilamot);
                gyfgss.push(itemData.gyfgs);
                youhui.push(itemData.youhui);
                orgType.push(itemData.orgtype1);
            }
        }
        if (orderIdArr.length == 0) {
            uexWindow.alert("提示", "您没有需要提交的意向单！", "确定");
            return;
        }

        var url = URL + "/app/oil/order/updateBatchOrderByNotERP";
        var dataType = "text";
        // 当前提交意向单的选定个数
        var selectNum =  getSelectNum();
        var isInFGS = true; // 区分是否进入分公司多个审批
        // 是否选中单个
        if(selectNum === 1 && youhuiNum === 1){
          // TODO:是否提交总公司审批？
          isInFGS = false;
          twoAlert("是否提交总公司审批?","是", "否", yesZong, falseZong)
          // 单个审批
        }else if(selectNum >1 && youhuiNum >0){
            if(youhuiNum<selectNum){
                isInFGS = false;
                oneAlert("包含权限不足的单据！");
					return;
				}
				if(youhuiNum==selectNum){
                isInFGS = false;
				oneAlert("请单条逐个审批！");
					return;
				}
        }
       
        // 提交总公司审批？
           // - 是，提交总公司审批
        function yesZong(){
            var paramJsonStr = "orderIds=" + orderIdArr.join(",") + "&cusIds=" + cusIds.join(",") + "&b2s=" + b2s.join(
            ",") + "&gyfgss=" + gyfgss.join(',') + "&youhui=" + youhui.join(',') + "&orgType=" + orgType.join(
            ",") + "&state" + "=1"; // 分公司审批通过
       
        ajaxPostQuery(url, paramJsonStr,okOrderCallback, dataType);
        appcan.window.openToast('加载中...', '0', '5', '1');
        }
          // 否，不提交总公司审批
        function falseZong(){
            var paramJsonStr = "orderIds=" + orderIdArr.join(",") + "&cusIds=" + cusIds.join(",") + "&b2s=" + b2s.join(
            ",") + "&gyfgss=" + gyfgss.join(',') + "&youhui=" + youhui.join(',') + "&orgType=" + orgType.join(
            ",") + "&state" + "=4"; // 审批未通过
       
        ajaxPostQuery(url, paramJsonStr,failedOrderCallback, dataType);
        appcan.window.openToast('加载中...', '0', '5', '1');
        }
         if(isInFGS){
         // 分公司多个审批通过
         twoAlert("确定审核通过?","是","否",function(){
            var paramJsonStr = "orderIds=" + orderIdArr.join(",") + "&cusIds=" + cusIds.join(",") + "&b2s=" + b2s.join(
            ",") + "&gyfgss=" + gyfgss.join(',') + "&youhui=" + youhui.join(',') + "&orgType=" + orgType.join(
            ",") + "&state" + "=3"; //一级审批，合资直接审核通过
        ajaxPostQuery(url, paramJsonStr,okOrderCallback, dataType);
        appcan.window.openToast('加载中...', '0', '5', '1');
        },function(){})
         }

    })

    // TODO:获取当前选中的意向单个数
    function getSelectNum(){
        var selectCheckArr = $$(".m-check-active");
        var isCheckAll = $("#checkall").hasClass("m-check-active");
        var len = isCheckAll ? selectCheckArr.length -1 :selectCheckArr.length;
        return len;
    }

    //多个审核 不通过
    appcan.button("#faliedYXD", "ani-act", function () {

        var oillist = [];
        var orderIdArr = [],
            cusIds = [],
            b2s = [],
            gyfgss = [],
            youhui = [],
            orgType = [];

        for (var i = 0; i < listNum; i++) {

            if (getId(i).className == "m-check singleSelection m-check-active") {
                var element = $$('.orderId')[i];
                var itemData = element.dataset;
                var orderID = itemData.orderid;
                if (orderID && itemData.state != 0) {
                    uexWindow.alert("提示", "只能审核状态为未审核的，请重新选择！", "确定");
                    return;
                }
               
                orderIdArr.push(orderID);
            }
        }

        if (orderIdArr.length == 0) {
            appcan.window.openToast('请选择要提交的订单', '1000', '5', '0');
            return;
        }

        if (orderIdArr.length == 0) {
            uexWindow.alert("提示", "请选择要提交的订单", "确定");
            return;
        }

        var url = URL + "/app/oil/order/updateBatchOrder";
        var paramJsonStr = "orderIds=" + orderIdArr.join(",") + "&state" + "=2";
        var func = failedOrderCallback;
        var dataType = "text";
        ajaxPostQuery(url, paramJsonStr, func, dataType);
        appcan.window.openToast('加载中...', '0', '5', '1');

    })

    function okOrderCallback(data) {

        appcan.window.closeToast();
        if (data === "1") {
            oneAlert("订单全部审核通过!")

        } else if (data === "0") {
            oneAlert("部分订单审核未通过，账户余额不足!")
        } else {
            oneAlert("订单已审核通过!")
        }
        uexWindow.reload();
        return;
    }

    function failedOrderCallback(data) {

        appcan.window.closeToast();
        if (data === "1") {
            oneAlert("订单全部审核不通过!")
        } else if (data === "0") {
            oneAlert("部分订单审核失败!")
        } else {
            oneAlert("订单已审核不通过!")
        }
        uexWindow.reload();
        return;
    }
</script>

</html>