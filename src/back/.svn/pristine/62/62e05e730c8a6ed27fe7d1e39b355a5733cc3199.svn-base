//线上
// var URL = "http://egou.cnpc.com.cn:8080/SHXS";
// var PICURL = "http://egou.cnpc.com.cn:8080";

//测试
var URL = "http://10.88.113.96:8080/SHXS";
var PICURL = "http://10.88.113.96:8080";



var offset = "1";
//从第几条开始
var limit = 15;
//每页显示行数

var pageNo = 1;
//从第几条开始
var pageSize = 15;
//每页显示行数

//扩展对象
var _extend = function (option, opt) {
	if (typeof (opt) != 'object' || !opt) {
		return option;
	}
	for (var property in opt) {
		option[property] = opt[property];
	}
	return option;
};
function ajaxPostQuery(url, paramJsonStr, func, dataType) {
	var dataType = dataType || "json";
	var url = url || queryUrl;
	var sid = appcan.locStorage.getVal("sid");
	$.ajax({
		type: "POST",
		url: url,
		data: paramJsonStr + "&sid=" + sid,
		headers: {
			accept: "*/*"
		},
		//contentType:"application/x-www-form-urlencoded",
		dataType: dataType,
		timeout: 0,
		error: function (XMLHttpRequest, textStatus, errorThrown) {
			appcan.window.alert("提示", "网络暂时不可用", "确定");
		},
		success: function (data) {
			var errorData;
			if (typeof data == "string") {
				try {
					errorData = eval("(" + data + ")");

					if (errorData.error == "-1") {
						relogin();
						ajaxPostQuery(url, paramJsonStr, func, dataType);
					} else {
						func(data);
					}
				} catch (e) {
					func(data);
				}
			}
		}
	});
}


function ajaxPostQueryDNnotVerifySid(url, paramJsonStr, func, dataType) {
	var dataType = dataType || "json";
	var url = url || queryUrl;
	var sid = appcan.locStorage.getVal("sid");
	var username = appcan.locStorage.getVal("username");


	$.ajax({
		type: "POST",
		url: url,
		data: paramJsonStr + "&sid=" + sid,
		headers: {
			accept: "*/*"
		},
		//contentType:"application/x-www-form-urlencoded",
		dataType: dataType,
		timeout: 0,
		error: function (XMLHttpRequest, textStatus, errorThrown) {
			appcan.window.alert("提示", "网络暂时不可用", "确定");
		},
		success: function (data) {

			var errorData;
			if (typeof data == "string") {
				try {
					errorData = eval("(" + data + ")");

					if (errorData.error == "-1") {
						//alert(url);
						relogin(url);
					} else {

						func(data);
					}
				} catch (e) {
					func(data);
				}
			}
		}
	});
}

function relogin() {
	var username = appcan.locStorage.getVal("username");
	var password = appcan.locStorage.getVal("password");

	if ((username == null || username == "") && (password == null || password == "")) {
		return;
	} else {
		$.ajax({
			type: "POST", //用POST方式传输
			dataType: "text",
			headers: {
				accept: "*/*"
			},
			url: URL + '/app/admin/login',
			data: "loginName=" + username + "&loginPassword=" + password,
			error: function (XMLHttpRequest, textStatus, errorThrown) {
			},
			success: function (data) {
				appcan.window.closeToast();
				if (typeof data == "string") {
					data = eval("(" + data + ")");
				}
				var sid = data.sid;
				var retMsg = data.retMsg;
				if (retMsg == 0) {
					var orgInfo = {
						empId: data.empId,
						empName: data.empName,
						orgName: data.orgName
					}
					appcan.locStorage.setVal("orgInfo", orgInfo);
					appcan.locStorage.setVal("username", username);
					appcan.locStorage.setVal("password", password);
					appcan.locStorage.setVal("sid", sid);
					appcan.window.publish("afterLogin", data.empId);
					//appcan.window.open("manager", "manager/manager.html", 10);
				} else {
					uexWindow.alert("提示", retMsg, "确定");
				}
			}
		})
	}
}

Date.prototype.formate = function (format) {
	var o = {
		"M+": this.getMonth() + 1, // month
		"d+": this.getDate(), // day
		"h+": this.getHours(), // hour
		"m+": this.getMinutes(), // minute
		"s+": this.getSeconds(), // second
		"q+": Math.floor((this.getMonth() + 3) / 3), // quarter
		"S": this.getMilliseconds()
		// millisecond
	}

	if (/(y+)/.test(format)) {
		format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	}

	for (var k in o) {
		if (new RegExp("(" + k + ")").test(format)) {
			format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
		}
	}
	return format;
}
function getMonth() {
	var date = new Date().formate("yyyy-MM-dd"),
		y = date.split("-")[0],
		m = Number(date.split("-")[1]);

	if (m < 10) {
		m = '0' + m;
	}
	return y + '-' + m;
}


// 获取对应月份的天数
function mGetDate(year, month) {
	var d = new Date(year, month, 0);
	return d.getDate();
}
//无数据提示统一格式
function noDataMsg(tip) {

	var msg = "<div id='time' class='ub ub-pc tip-wrapper'>" + "<span class='mf-size2 tip'>" + tip + "</span>" + "</div>";

	return msg;
}

//price = fmoney(price,2);
function fmoney(s, n) {

	n = n > 0 && n <= 20 ? n : 2;
	s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";
	var l = s.split(".")[0].split("").reverse(),
		r = s.split(".")[1];
	t = "";
	for (j = 0; j < l.length; j++) {
		t += l[j] + ((j + 1) % 3 == 0 && (j + 1) != l.length ? "," : "");
	}
	return t.split("").reverse().join("") + "." + r;
}

function rmoney(s) {
	return parseFloat(s.replace(/[^\d\.-]/g, ""));
}

var yesNo = 0;

//全选
if (document.getElementById('checkall')) {
	document.getElementById('checkall').onclick = function () {
		if ($("#checkall")[0].className == "m-check") {

			$("#checkall")[0].className = "m-check m-check-active";

			for (var i = 0; i < listData.length; i++) {
				if ($("#" + i)[0]) {
					$("#" + i)[0].className = "m-check m-check-active";
				}
			}

		} else {
			$("#checkall")[0].className = "m-check";
			for (var i = 0; i < listData.length; i++) {
				if ($("#" + i)[0]) {
					$("#" + i)[0].className = "m-check";
				}
			}
		}

		yesNo = 0;
	}
}

// 单选
function cellbtnClick(id) {

	if ($("#" + id)[0].className == "m-check") {
		$("#" + id)[0].className = "m-check m-check-active";
		yesNo++;

		;
	} else {
		$("#" + id)[0].className = "m-check";
		yesNo--;

	}

	if (yesNo == listData.length) {
		$("#checkall")[0].className = "m-check m-check-active";
	} else {
		$("#checkall")[0].className = "m-check";
	}
}

function $(selector, el) {
	if (!el) {
		el = document;
	}
	return el.querySelector(selector);
}
function $$(selector, el) {
	if (!el) {
		el = document;
	}
	return el.querySelectorAll(selector);
	// Note: the returned object is a NodeList.
	// If you'd like to convert it to a Array for convenience, use this instead:
	// return Array.prototype.slice.call(el.querySelectorAll(selector));
}

// 将NodeList转为数组
function convertToArray(nodeList) {
	var array = null
	try {
		// IE8-NodeList是COM对象
		array = Array.prototype.slice.call(nodeList, 0)
	} catch (err) {
		array = []
		for (var i = 0, len = nodeList.length; i < len; i++) {
			array.push(nodeList[i])
		}
	}
	return array
}
function nodata(id, text) {
	var ele = document.getElementById(id);
	ele.innerHTML = '';
	var listhtml = "<div id='nodata' class='ub ub-pc' style='margin: 0.8em 0;'>" + "<span class='mf-size2 nodata'>" + text + "</span></div>";
	ele.innerHTML = listhtml;
}

function addEvent(a, b, c, d) {
	a.addEventListener ? a.addEventListener(b, c, d) : a.attachEvent("on" + b, c)
}



function lsSetItems(obj) {
	for (var i in obj) {
		appcan.locStorage.setVal(i, obj[i])
	}

}

function lsrmItems(arr) {
	arr.forEach(function (i) {
		appcan.locStorage.remove(arr[i])
	});

}
function openToast(text) {
	var text = text || "加载中...";
	appcan.window.openToast(text, '0', '5', '1');
	appcan.initBounce();
}
function closeToast() {
	appcan.window.closeToast();
}

var CURRENT_PAGE = 1;
var CURRENT_DATA = null;
var SHENGYU_DATA = null;
var DATA = null;

var loadMore = {
	init: function (options) {
		var y = this;
		var defaultOptions = {
			limit: 10,
			CURRENT_PAGE: 1,
			MAX_PAGE: null
		}
		y.options = _extend(defaultOptions, options);
		if (y.checkOptions()) {
			y.checkOptions().appendById(y.options.ele).bind();
			var splitNum = y.options.limit;
			DATA = y.options.data;
			SHENGYU_DATA = DATA.slice(splitNum);
		}

	},
	checkOptions: function () {
		if (!this.options.hasOwnProperty("ele") || !document.getElementById(this.options.ele)) {
			throw new Error("ele必须为getElementById可获取的dom元素,用于存放loadmore组件");
		}
		if (!this.options.hasOwnProperty('data') || !this.options.data.length || !Array.isArray(this.options.data)) {
			throw new Error('传入的分页数据不是数组格式');
		}
		if (!this.options.hasOwnProperty('totalNum') || !(typeof (this.options.totalNum) === 'number')) {
			throw new Error('分页器的总页数必须指定,且为Number类型')
		}
		if (!this.options.hasOwnProperty('clickFn') || !(typeof (this.options.clickFn) === 'function')) {
			throw new Error('请为分页器指定点击回调函数')
		}
		MAX_PAGE = Math.ceil(this.options.totalNum / Number(this.options.limit));
		this.options.MAX_PAGE = MAX_PAGE;

		if (CURRENT_PAGE === MAX_PAGE) {
			console.log('分页器完成工作任务，消失...')
			return null;
		}
		return this;
	},
	makeBtnLayout: function () {
		var box = document.createElement("div");
		box.id = "loadMore";
		box.className = "text-center";
		box.innerHTML = '<ul class="pager">'
			+ '<li id="btn-load-more" class="">'
			+ '<a href="javascript:;">点击载入更多</a></li>'

			+ '<li id="btn-loading" class="hidden">'
			+ '<a href="javascript:;">'
			+ '<i class="fa fa-spinner fa-spin" aria-hidden="true"></i> 载入中</a> </li>'
			+ '</ul>';

		return box;
	},
	appendById: function (id) {
		var y = this;
		var box = y.makeBtnLayout();
		document.getElementById(id).appendChild(box);
		return y;
	},
	bind: function () {
		var y = this;
		var loadMore = document.getElementById("btn-load-more");
		var loading = document.getElementById("btn-loading");

		loadMore.onclick = function () {

			this.classList.add("hidden");
			loading.classList.remove("hidden");
			CURRENT_PAGE++;

			console.log('CURRENT_PAGE :' + CURRENT_PAGE)

			if (!y.options.frontendPager) {
				y.options.clickFn.call(null, CURRENT_PAGE, y.options.MAX_PAGE, y.options.totalNum)

			} else {
				// 前端分页

				if (SHENGYU_DATA.length > 0 && CURRENT_PAGE - 1 < MAX_PAGE) {

					CURRENT_DATA = SHENGYU_DATA.splice(0, y.options.limit);
					y.options.clickFn.call(null, CURRENT_PAGE, CURRENT_DATA, y.options.MAX_PAGE, y.options.totalNum)

					if (CURRENT_PAGE === MAX_PAGE) {
						document.getElementById('loadMore').remove();
						console.log('分页完毕');
						return;
					}
					y.loadingGoOn();

				}
			}
		}

	},
	loadingGoOn: function () {
		var loading = document.getElementById("btn-loading");
		var loadMore = document.getElementById("btn-load-more");
		setTimeout(function () {
			loading.classList.add("hidden");
			loadMore.classList.remove("hidden");
		}, 1000);
	}
}
