<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

<head>
	<title></title>
	<meta charset="utf-8">
	<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="build/css/fonts/font-awesome.min.css">
	<link rel="stylesheet" href="build/css/ui-box.css">
	<link rel="stylesheet" href="build/css/ui-base.css">
	<link rel="stylesheet" href="build/css/ui-color.css">
	<link rel="stylesheet" href="build/css/appcan.icon.css">
	<link rel="stylesheet" href="build/css/appcan.control.css">
	<style type="text/css">
		.m-logo {
			margin-top: 2em;
			margin-bottom: 2em;
		}

		.m-logo img {
			width: 12em;
		}

		.uinput input:focus {
			outline: none !important;
		}

		.btn-vcode {
			font-size: 0.8em;
			margin-top: 0.7em;
			height: 2.4em;
			padding: 0 0.6em;
			color: #ffffff;
			border: none !important;
		}

		.uw-reg {
			min-width: 4em;
		}
	</style>

</head>

<body class="um-vp bc-bg white-bg" ontouchstart onload="useInfoLoad()">
	<div id="" class="ub ub-ver">
		<div id="img" class="ub ub-ac ub-pc ub-img m-logo">
			<img src="build/imgs/logo2.png" />
		</div>

		<div id="login" class="ub-login umar-a">
			<div class="uba bc-border c-wh">
				<div class="ub ub-ac ubb umh5 bc-border uinput ub-f1">
					<div class="uinn fa fa-user sc-text"></div>
					<input placeholder="登录名称" type="text" class="ub-f1" id="username">
				</div>
				<div class="ub ub-ac umh5 uinput">
					<div class="uinn fa fa-key sc-text"></div>
					<input placeholder="密码" type="password" class="umw4 ub-f1" id="password">
				</div>
			</div>
			<div class="ub bc-border" style="height:3em;margin-top:0.6em">
				<div class="ub ub-ac uw-reg">
					<span class="sc-text-warn"> </span>
					验证码
				</div>
				<div class="ub ub-ac  ub-f1">
					<div class="uinput ub ub-f1">
						<input placeholder="请输入验证码" type="text" class="ub-f1" id="code" name="code">
					</div>
				</div>
				<button type="button" class="ub ub-ac mp-btn2 btn-vcode" id="message"> 获取验证码 </button>
			</div>

		</div>

		<div id="btnarea" class="">
			<div class="ub ub-ver">
				<div id="" class="ub ub-ac ub-pe umar-a">
					<div class="mf-size1 gray-font" id="forgetPwd">
						忘记密码?
					</div>
				</div>
				<div class="uinn-at1 umar-a" style="margin-top:1em;">
					<div class="btn ub ub-ac ub-pc bc-text-head bc-btn uc-a1 mp-btn" id="submit">
						登录
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="build/js/appcan.js"></script>
	<script src="build/js/appcan.control.js"></script>
	<script src="common/common.js"></script>
	<script src="common/jquery.min.js" type="text/javascript" charset="utf-8">
	</script>
</body>
<script>
	appcan.ready(function () {
		LoginCtrl.init();
	})
	var TIME = 180,
		timeoutID = null,
		clickNum = 0;

	var LoginCtrl = {
		options: function () {
			var options = {
				"VerificationCode": null
			}
			this.options = options;
			return this;

		},
		init: function () {
			var y = this;
			y.options().bind();
		},
		bind: function () {
			var y = this;

			appcan.button("#message", "ani-act", function () {
				y.getVerificationCode();
			})

			appcan.button("#submit", "ani-act", function () {
				y.submitLogin();
			})
			appcan.button("#nav-left", "ani-act", function () {
				appcan.window.close(-1);
			})

			appcan.button("#forgetPwd", "btn-act", function () {
				appcan.window.open("pwdForget", "./manager/pwdForget.html", 10);
			})

			appcan.button("#right", "btn-act", function () {
				appcan.window.open("vip_right", "../vipzone/vip_right.html", 10);
			})
		},
		// 获取验证码
		getVerificationCode: function () {

			var username = document.getElementById("username").value.trim();
			var pswd = document.getElementById("password").value.trim();
			if (!username) {
				uexWindow.alert("提示", "请输入登录账号", "确定");
				return;
			}

			clickNum++;

			// 计时器执行时，节省短信条数
			if (clickNum != 1 && TIME != 180) {
				uexWindow.alert("提示", "验证码有效时间为3分钟，请输入有效期内的验证码！", "确定");
				return;
			}

			$.ajax({
				type: "POST", //用POST方式传输
				url: URL + '/app/admin/login1',
				data: "loginName=" + username + "&loginPassword=" + pswd,
				success: function (data) {
					if (typeof data == "string") {
						data = JSON.parse(data);
					}
					console.dir(data)


					uexWindow.alert("提示", data.retStr, "确定");
					//计时器
					if (data.hasOwnProperty("sid")) {

						lsSetItems({
							"sid": data.sid,
						})

						timeoutID = window.setInterval(function () {
							var btn = document.querySelector('#message');
							if (TIME > 0 && btn) {
								TIME--;
								btn.innerHTML = '已发送(' + TIME + ')';
							} else {
								btn.innerHTML = '重新获取';
								TIME = 180;
								window.clearTimeout(timeoutID);
							}

						}, '1000')
					}

				}
			})
		},
		submitLogin: function () {
			// useInfoLoad(); // 存储中读取可能有的用户名密码
			var username = document.getElementById("username").value.trim();
			var pswd = document.getElementById("password").value.trim();
			var VerificationCode = document.getElementById("code").value.trim();
			var sid = appcan.locStorage.getVal("sid");
			if (username == "" || pswd == "") {
				uexWindow.alert("提示", "请输入用户名和密码！", "确定");
				return;
			} else if (!VerificationCode) {
				uexWindow.alert("提示", "请输入验证码！", "确定");

			} else {
				if (username != "" && pswd != "") {
					appcan.window.openToast('登录中...', '0', '5', '1');
					//向后台发送数据
					$.ajax({
						type: "POST", //用POST方式传输
						dataType: "text",
						headers: {
							accept: "*/*"
						},
						url: URL + '/app/admin/login',
						data: "loginName=" + username + "&loginPassword=" + pswd + "&vCode=" +
							VerificationCode + "&loginType=" + 0,
						error: function (XMLHttpRequest, textStatus, errorThrown) {},
						success: function (data) {
							appcan.window.closeToast();
							if (typeof data == "string") {
								data = eval("(" + data + ")");
							}
							appcan.window.publish("afterLogin", data.empId);
							var retMsg = data.retMsg;
							var companyType = data.companyType;
							if (retMsg === "0") {
								var orgInfo = {
									empId: data.empId,
									empName: data.empName,
									orgName: data.orgName
								}
								//分公司1 总公司0

								lsSetItems({
									"orgInfo": orgInfo,
									"username": username,
									"password": pswd,
									"sid": data.sid,
									"orgId": data.orgId,
									"orgType": data.orgType,
									"userList":data.userList

								})

								// 合资，全资,总部
								appcan.locStorage.setVal("companyType", companyType);

								appcan.window.open("manager", "manager/manager.html", 10);
								return;
							} else {
								var text = retMsg === "" ? "验证码错误！" : retMsg;
								uexWindow.alert("提示", text, "确定");
							}
						}
					})
				}

			}
		}

	}

	//打开页面时加载本地存储的用户信息
	function useInfoLoad() {
		var username = appcan.locStorage.getVal("username");
		var password = appcan.locStorage.getVal("password");
		if (username != null && password != null) {
			document.getElementById("username").value = username;
			document.getElementById("password").value = password;
		} else {
			document.getElementById("username").value = null;
			document.getElementById("password").value = null;
		}
	}
</script>

</html>