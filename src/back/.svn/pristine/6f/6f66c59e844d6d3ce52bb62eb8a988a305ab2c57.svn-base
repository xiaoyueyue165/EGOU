<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

<head>
  <title></title>
  <meta charset="utf-8">
  <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" href="../build/css/fonts/font-awesome.min.css">
  <link rel="stylesheet" href="../build/css/ui-box.css">
  <link rel="stylesheet" href="../build/css/ui-base.css">
  <link rel="stylesheet" href="../build/css/ui-color.css">
  <link rel="stylesheet" href="../build/css/appcan.icon.css">
  <link rel="stylesheet" href="../build/css/appcan.control.css">
  <link rel="stylesheet" href="../intention/css/intention.css">
</head>

<body class="um-vp bc-bg" ontouchstart>

  <div id="" class="listbox">
    <div id="listdetail" class="detail bc-border"></div>
  </div>
  <div class="" id="pullstatus"></div>

  <script src="../build/js/appcan.js"></script>
  <script src="../build/js/appcan.control.js"></script>
  <script src="../common/common.js"></script>
  <script type="text/javascript" charset="utf-8" src="../common/template-web.js"></script>
  <script src="../common/jquery.min.js"></script>
</body>

<script id="Allorder_list" type="text/html">

  {{each list}}

  <div id="list{{$index}}" class='list-content'>
    <div id='orderlist" + i + "'>
      <div id='pay' class='ub ub-ac umar-l umar-r m-row3'>

        <span class='gray-font'>客户名称&nbsp;&nbsp;
        </span>
        <span class='AllPrice'>
          {{$value.CUS_COMPANY}}
        </span>

      </div>
      <div id='pay' class='ub ub-ac umar-l umar-r m-row3'>
        <div id='' class='col-left'>
          <span class='gray-font'>收款单位&nbsp;&nbsp;</span>
          <span>
            {{$value.GYFGS}}


          </span>
        </div>

        <div id='total' class='col-right'>

          <span class='gray-font'>订单编号&nbsp;&nbsp;</span>
          <span>
            {{$value.ORDERSALE_CODE}}
          </span>

        </div>
      </div>

      <div id='pay' class='ub ub-ac umar-l umar-r m-row3'>
        <div id='' class='col-left'>
          <span class='gray-font'>业务流水号&nbsp;&nbsp;</span>
          <span>
            {{$value.FUNDSUB_TRAN}}

          </span>
        </div>

        <div id='total' class='col-right'>

          <span class='gray-font'>资金流向&nbsp;&nbsp;</span>
          <span>
            {{if $value.OPE_TYPE == '0'}}
            <span>
              收入
            </span>

            {{else if $value.OPE_TYPE == '1'}}
            <span id="">
              支出
            </span>
            {{else if $value.OPE_TYPE == '2'}}
            <span id="">
              冻结
            </span>

            {{else if $value.OPE_TYPE == '3'}}
            <span id="">
              授信
            </span>
            {{else if $value.OPE_TYPE == '4'}}
            <span id="">
              解冻
            </span>
            {{else if $value.OPE_TYPE == '5'}}
            <span id="">
              退款
            </span>
            {{else if $value.OPE_TYPE == '6'}}
            <span id="">
              返还
            </span>
            {{else if $value.OPE_TYPE == '7'}}
            <span id="">
              授信还款
            </span>
            {{else}} -- {{/if}}
          </span>

        </div>
      </div>
      <div id='pay' class='ub ub-ac umar-l umar-r m-row3'>
        <div id='' class='col-left'>
          <span class='gray-font'>流动资金&nbsp;&nbsp;</span>
          <span>

            {{$value.OPE_MONEY}}
          </span>
        </div>

        <div id='total' class='col-right'>

          <span class='gray-font'>账户可用余额&nbsp;&nbsp;</span>
          <span>
            {{$value.TOTLE_MONEY}}
          </span>

        </div>
      </div>

      <!-- 创建时间 -->
      <div id='company' class='ub ub-ac umar-l umar-r m-row3'>
        <div id='' class=''>
          <span class='gray-font'>审核状态 </span>
          <span class='AllPrice'>
            {{if $value.REMARK ==='0'}} 未审核 {{else if $value.REMARK ==='1'}} 已审核 {{else if $value.REMARK === '2'}} 审核未通过 {{else}} --
            {{/if}}
          </span>

        </div>

      </div>
      {{if ($value.OPE_TYPE == '0'|| $value.OPE_TYPE == '3'|| $value.OPE_TYPE == '5' || $value.OPE_TYPE == '7') && $value.REMARK=='0'}}

      <div id="position{{$index}}">
        <div id='" + orderList[i]["orderId"] + "' class='ub ub-ac ub-pe m-row4'>

          <span class='y-font umar-l' data-FUND_ID={{$value.FUND_ID}} data-FUNDSUB_ID={{$value.FUNDSUB_ID}} data-OPE_MONEY={{$value.OPE_MONEY}}
            data-REMARK={{$value.REMARK}} data-OPE_TYPE={{$value.OPE_TYPE}} onclick="onPass(this.dataset)">通过</span>

          <span class='y-font umar-l' data-FUND_ID={{$value.FUND_ID}} data-FUNDSUB_ID={{$value.FUNDSUB_ID}} data-OPE_MONEY={{$value.OPE_MONEY}}
            data-REMARK={{$value.REMARK}} data-OPE_TYPE={{$value.OPE_TYPE}} onclick='onNotPass(this.dataset)'>不通过</span>
        </div>

      </div>
      {{else}} {{/if}}
      <div id='pay' class='ub ub-ac umar-l umar-r m-row3'>

        <span class='gray-font'>记账时间&nbsp;&nbsp;
        </span>
        <span class='AllPrice'>
          {{$value.CREATE_DATE}}
        </span>

      </div>
      <div class='gap' id="idx{{$index}}"></div>

    </div>
  </div>

  {{/each}}
</script>
<script>
  getNoOkOrder();
  //获取数据
  function getNoOkOrder() {

    var cusId = getVal("data-cusId");
    var cusOrgLinkid = getVal("data-cusOrgLinkid");
    var fundId = getVal("data-fundId");

    var url = URL + "/backgrd/cus/cusMng/queryAllFundSub";
    var paramJsonStr = "&pager.pageNo=" + pageNo + "&pager.pageSize=" + pageSize + "&cusOrgLinkid=" + cusOrgLinkid +
      "&cusId=" + cusId;
    var func = getNoOkOrderCallback;
    var dataType = "text";
    ajaxPostQuery(url, paramJsonStr, func, dataType);
    appcan.window.openToast('加载中...', '0', '5', '1');
  }

  //展示数据
  function getNoOkOrderCallback(data) {
    appcan.window.closeToast();
    if (typeof (data) === 'string' && data != "") {
      var data = JSON.parse(data);
    }
    if (data == "") {
      nodata('listdetail', '您没有符合条件的付油通知单')
      return;
    }
    var totalCount = data.rows;
    listNum = totalCount.length;
    listData = data.rows;

    if (listData.length == 0) {
      nodata('listdetail', '您没有符合条件的付油通知单');
      return;
    }
    //
    var html = template('Allorder_list', {
      list: data.rows
    })

    $('#listdetail').html(html);
    if (document.querySelector(" .list-content:last-child .gap")) {
      document.querySelector(" .list-content:last-child .gap").style.height = "5em"

    }
  }
  // 审核通过
  function onPass(data) {
    if (data.remark != 0) {
      oneAlert("只能操作未审核的，请重新选择！");
      return;
    } else {
      var fundsubTran = prompt("请输入业务流水号：");

      if (fundsubTran.length == 0 || fundsubTran == null || fundsubTran == undefined) {
        oneAlert("业务流水号不能为空！");
        return;
      }
      var oprType = data.ope_type;
      var paramJsonStr = "fundId=" + data.fund_id + "&fundsubId=" + data.fundsub_id + "&fundsubTran=" + fundsubTran +
        "&tuikuan=" + data.ope_money +
        "&temp=" + data.ope_type;
      if (oprType == "5") { //退款时
        ajaxPostQuery(URL + "/backgrd/cus/cusMng/tuikuanCustomerFund", paramJsonStr, function (result) {
          if (result == "0") {
            oneAlert("退款成功！");

          } else if (result == "1") {
            oneAlert("可用余额不足！");

          } else if (result == "2") {
            oneAlert("余额不足！");
          }
          uexWindow.reload();
        });
      } else if (oprType == "7") { //授信还款时
        ajaxPostQuery(URL + "/backgrd/cus/cusMng/shouxinCustomerFund", paramJsonStr, function (result) {
          if (result == "1") {
            oneAlert("还款金额大于授信余额！");
          }
          uexWindow.reload();
        });
      } else {
        ajaxPostQuery(URL + "/backgrd/cus/cusMng/addCustomerFund", paramJsonStr, function (result) {
          if (result == "1") {
            oneAlert("审核通过!");
          } else if (result == "0") {
            oneAlert("未审核成功！");
          }
          uexWindow.reload();
        });
      }
    }

    console.log(data);

  }

  function onNotPass(data) {
    if (data.remark != 0) {
      oneAlert("只能操作未审核的，请重新选择！");
      return;
    } else {
      var paramJsonStr = "fundsubId=" + data.fundsub_id;
      ajaxPostQuery(URL + "/backgrd/cus/cusMng/addCustomerFundNot", paramJsonStr, function (result) {
        if (result == "1") {
          oneAlert("审核通过!");
        } else if (result == "0") {
          oneAlert("未审核成功！");
        }
        uexWindow.reload();
      });
    }
  }
</script>

</html>