<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../build/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../build/css/ui-box.css">
        <link rel="stylesheet" href="../build/css/ui-base.css">
        <link rel="stylesheet" href="../build/css/ui-color.css">
        <link rel="stylesheet" href="../build/css/appcan.icon.css">
        <link rel="stylesheet" href="../build/css/appcan.control.css">
        <link rel="stylesheet" href="./css/intention.css">
    </head>
    <body class="um-vp white-bg" ontouchstart>

        <div id="" class="listbox">
            <div id="listdetail" class="detail white-bg bc-border"></div>
        </div>
        <div class="" id="pullstatus"></div>
        <!--footer-->
        <div id="footer" class="ub ubt bc-border uf tab-foot">
            <div id="" class="ub uw-a">
                <div id="" class="ub ub-pc ub-ac uw-1">
                    <div id="" class="umar-l">
                        <div class="m-check" name="" id="checkall"></div>
                    </div>
                    <div id="" class="umar-l">
                        <span class="mf-size2">全选</span>
                    </div>
                </div>

                <div id="sum_price" class="uw-2 ub ub-pe area-price">
                    <span class="umar-r"><span class="mf-size2 gray-font"></span><span class="mf-color"><span id="heji"></span></span></span>
                </div>

                <div id="confirmYXD" class="uw-3 ub ub-ac ub-pc sec-btn1">
                    确认通过
                </div>
            </div>
        </div>

        <script src="../build/js/appcan.js"></script>
        <script src="../build/js/appcan.control.js"></script>
        <script src="../common/common.js"></script>
        <script type="text/javascript" charset="utf-8" src="../common/template-web.js"></script>
        <script src="../common/jquery.min.js"></script>
    </body>

    <script id="Allorder_list" type="text/html">

        {{each list}}

        <div id="list{{$index}}" class='list-content white-bg' ><div id='orderlist" + i + "'>

        <div id='' class='ub ub-ac umar-a m-row3'>
        <!-- 单选框 -->
        <div id="check{{$index}}" class="bw0 ub ub-ac " onclick="cellbtnClick({{$index}})"><div id="{{$index}}" class="m-check"></div></div>
        <span class="gray-font ulev0">
        &nbsp;ERP订单编号
        </span><span id="ordersaleCode">{{$value.ordersaleCode}}</span>
        </div>

        <div id='' class='ub ub-ac umar-a m-row3'>

        <div id='' class='ub ub-ac t-col1'>
        <!-- 油品名称 -->

        {{$value.oilinfoName}}

        <input type="hidden" name="orderId" class="orderId" value="{{$value.orderId}}" />

        </div><div id='' class='ub ub-ac ub-pc t-col2'><span class='umar-r mf-color umar-r'><span class='mf-size2'>￥</span>
        <!-- 油品价格 -->

        {{if $value.oilPrice <=0}}
        --
        {{else}}
        {{$value.oilPrice | changeMoney}}
        {{/if}}

        <span class='gray-font mf-size2'>/吨</span></span><span class='umar-l'>
        <!-- 油品数量-->
        x
        {{if $value.oilNumber <=0}}
        --
        {{else}}
        {{$value.oilNumber}}
        {{/if}}
        
        </span></div><div id='type' class='ub ub-ac  ub-pc t-col4'><span class='s-state delivery'>
        <!-- 配送方式 -->
        {{$value.extractTypeName}}
        </span></div></div>

        <div id='pay' class='ub ub-ac umar-l umar-r m-row3'><div id='' class='col-left'><span class='gray-font'>客户名称&nbsp;&nbsp;</span><span>
        {{$value.empOrgName}}
        </span></div><div id='total' class='col-right'><span class='gray-font'>总金额&nbsp;&nbsp;

        </span><span class='mf-color AllPrice'>
      {{if $value.oilAmot <=0}}
        --
        {{else}}
        {{$value.oilAmot | changeMoney}}
        {{/if}}
        </span></div>

        </div>
        <div id='pay' class='ub ub-ac umar-l umar-r m-row3'><div id='' class='col-left'><span class='gray-font'>状态&nbsp;&nbsp;</span><span>

        {{if $value.state=='0'}}
        未审核                 {{else if $value.state == '1'}}
        分公司审核通过{{else if $value.state == '2'}}分公司审核未通过
        {{else if $value.state == '3'}}总公司审核通过
        {{else if $value.state == '4'}}总公司审核未通过
        {{/if}}

        </span></div>

        <div id='total' class='col-right'>
        
        </div></div>

        <!-- 油库地点 -->
        <div id='company' class='ub ub-ac umar-l umar-r m-row3'>

        <span class='gray-font'>创建时间 </span><span class='AllPrice'>
        {{$value.createDate}}
        </span>

        </div>
        <div></div> <div id="position{{$index}}">

        </div>
        <div class='gap' id='idx{{$index}}'></div>

        </div></div>

        {{/each}}
    </script>
    <script>
         
        var listData = {},
            sumPrice = 0.00,
            listNum = 0,
            totalRows = 0;

    template.defaults.imports.changeMoney = function (value) {
    return fmoney(value)
  }
       // 当所有组件准备好后执行内部回调方法
        appcan.ready(function () {

        uexWindow.setWindowScrollbarVisible('false');

        appcan.frame.setBounce(1, function (type) {
        $("#pullstatus").html("");
        }, function (type) {
        $("#pullstatus").html("");
        }, function (type) {
        $("#pullstatus").html("松手了,产生事件了,开始更新数据！");
        // 下拉事件发生
        appcan.frame.resetBounce(1);
        // 当前总条数
        var num = Number(pageNo) * limit;


        $("#pullstatus").html("");
        // alert("totalRows=" + totalRows)

        if (Number(totalRows) <= num) {
            appcan.window.openToast({
            msg: '没有更多',
            duration: 1000,
            position: 5,
            type: 0
            });
            return;
        }

        newPageNo = Number(pageNo) + 1;

        alert('准备加载第' + newPageNo + '页')

        Order.queryOrderList(newPageNo);
        });
        Order.init();

        });
        //获取数据
        
        var Order = {
            init:function(){
                var y = this;
                y.queryOrderList();
            },
            queryOrderList:function(newPageNo){
                var y = this;
                var pageNo = newPageNo?newPageNo:1;
                var url = URL + "/app/oil/order/queryOrderList";
                var paramJsonStr = "&pageNo=" + pageNo + "&pageSize=" + pageSize;
                var func = y.getOrderListCallback.bind(y);
                var dataType = "text";
                ajaxPostQuery(url, paramJsonStr, func, dataType);
                appcan.window.openToast('加载中...', '0', '5', '1');
            },
            getOrderListCallback:function(data){
                appcan.window.closeToast();
                var data = JSON.parse(data);
                var totalCount = data.rows;
                listNum = totalCount.length;
                listData = data.rows;

                if (data.length == 0) {
                    var listhtml = "<div id='time' class='ub ub-pc' style='margin: 0.8em 0;'>" + "<span class='mf-size2 time'>您没有符合条件的付邮通知单!</span>" + "</div>";
                    // $("#fuyou").html("");
                    $("#listdetail").append(listhtml);
                    return;
                }
                //
                var html = template('Allorder_list', {
                    list : data.rows
                })

                $('#listdetail').append(html)
                document.querySelector(" .list-content:last-child .gap").style.height = "5em"
                var orderList = data.rows;
                var listHtml = "";
                var sumprice = 0.00;

                for (var i = 0; i < orderList.length; i++) {

                    var orderId = orderList[i].orderId;
                    var state = orderList[i].state;

                    var oilinfoId = orderList[i].oilinfoId;
                    var oilinfoName = orderList[i].oilinfoName;
                    var extractType = orderList[i].extractType;

                    var oilNumber = orderList[i].oilNumber ? orderList[i].oilNumber : 000;
                    var oilPrice = orderList[i].oilPrice;
                    // sumprice += oilAmot;
                    //分公司审核 state=0
                    //总公司审核 state=1
                    var orgType = appcan.locStorage.getVal("orgType");

                    //分公司审核
                    //成功生成ERP编码

                    if (state == '3' && orgType == '1') {

                        //不存在ERP编码
                        if (!orderList[i]["ordersaleCode"]) {
                            var appendHtml = "<div id='" + orderList[i]["orderId"] + "' class='ub ub-ac ub-pe m-row4'><span class='y-font umar-l' onclick='confirmIntention(id,\"" + orderList[i].oilAmot + "\",\"" + orderList[i].cusId + "\",\"" + orderList[i].gyfgs + "\",\"" + orderList[i].orderId + "\")'>审核通过</span></div>";

                            $("#position" + i)[0].innerHTML = appendHtml;
                        }

                    }
                    // id," + orderList[i]["oilNumber"] + "," + orderList[i]["oilPrice"] + ",\"" + orderList[i].orderId + "\"," + orderList[i].payType + "

                    //总公司审核
                    else if (state == '1' && orgType == '0') {

                        var appendHtml = "<div id='" + orderList[i]["orderId"] + "' class='ub ub-ac ub-pe m-row4'><span class='y-font umar-l' onclick='confirmIntention(id,\"" + orderList[i].oilAmot + "\",\"" + orderList[i].cusId + "\",\"" + orderList[i].gyfgs + "\",\"" + orderList[i].orderId + "\")'>审核通过</span></div>";

                        // id," + orderList[i]["oilAmot"] + "," + orderList[i]["gyfgs"] + ",\","+orderList[i].orderId +"

                        $("#position" + i)[0].innerHTML = appendHtml;
                    }

                }
                }
        }
    

      

        //确认审核(单)
        function confirmIntention(id, oilAmot, cusId, gyfgs, orderId) {

            //分公司确认
            var url = URL + "/app/oil/order/updateBatchOrderByNotERP";
            var stateStr = appcan.locStorage.getVal('orgType');

            var state = stateStr == '1' ? 1 : 2;
            // alert(state)
            //分 1 总2
            var paramJsonStr = "orderIds=" + orderId;
            var func = okOrderCallback;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('审批中...', '0', '5', '1');

        }

        function okOrderCallback(data) {

            appcan.window.closeToast();

            uexWindow.alert("提示", "刷新表单中！", "确定");
            //重新加载页面
            getNoOkOrder();

        }

        function checkCusFundByOrder(oilAmot, cusId, gyfgs, orderId) {
            var url = URL + "/app/oil/order/checkCusFundByOrder";

            var paramJsonStr = "cusId=" + cusId + "&oilAmot=" + oilAmot + "&orderId=" + orderId + "&gyfgs=" + gyfgs;
            $.ajax({
                type : 'post',
                url : url,
                data : paramJsonStr,
                async : false,
                success : function(data) {
                    // alert('data' + data);
                    appcan.locStorage.setVal('checkSp', data);
                }
            })

        }

        //提交审核(多个审核通过)
        appcan.button("#confirmYXD", "ani-act", function() {

            var oillist = [];

            for (var i = 0; i < listNum; i++) {

                if ($("#"+i)[0].className == "m-check m-check-active") {
                    var intentionId = $("#list" + i).find($('.orderId'))[0].value;

                    //var intentionIds=$("#intentionIds" + i)[0].innerText;
                    var intentionIds = intentionId;
                    //alert(intentionIds);

                    oillist.push(intentionIds);
                }
            }

            if (oillist.length == 0) {
                appcan.window.openToast('请选择要提交的意向单', '1000', '5', '0');
                return;
            }

            var oils = oillist.join(',');

            if (oillist.length == 0) {
                uexWindow.alert("提示", "您没有需要提交的意向单！", "确定");
                return;
            }

            var url = URL + "/app/oil/order/updateBatchOrderByNotERP";
            var paramJsonStr = "orderIds=" + oils + "&state" + "=1";
            var func = okOrderCallback;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('加载中...', '0', '5', '1');

        })


        var yesNo = 0;

        //全选
        appcan.button("#checkall", "ani-act", function() {
            if ($("#checkall")[0].className == "m-check") {

                $("#checkall")[0].className = "m-check m-check-active";

                for (var i = 0; i < listData.length; i++) {
                    if ($("#" + i)[0]) {
                        $("#" + i)[0].className = "m-check m-check-active";
                    }
                }

            } else {
                $("#checkall")[0].className = "m-check";
                for (var i = 0; i < listData.length; i++) {
                    if ($("#" + i)[0]) {
                        $("#" + i)[0].className = "m-check";
                    }
                }
            }

            yesNo = 0;
        })
        //列表中单选
        function cellbtnClick(id) {

            // var index = id.substring(id.length - 1, id.length);

            if ($("#"+id)[0].className == "m-check") {
                $("#"+id)[0].className = "m-check m-check-active";
                yesNo++;

                //alert(yesNo);
            } else {
                $("#"+id)[0].className = "m-check";
                yesNo--;

                //alert(yesNo);
            }

            if (yesNo == listData.length) {
                $("#checkall")[0].className = "m-check m-check-active";
            } else {
                $("#checkall")[0].className = "m-check";
            }
        }

    </script>
</html>
