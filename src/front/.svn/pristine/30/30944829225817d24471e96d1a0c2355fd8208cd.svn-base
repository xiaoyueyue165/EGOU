<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
       <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../../build/css/ui-box.css">
        <link rel="stylesheet" href="../../build/css/ui-base.css">
        <link rel="stylesheet" href="../../build/css/ui-color.css">
        <link rel="stylesheet" href="../../build/css/appcan.icon.css">
        <link rel="stylesheet" href="../../build/css/appcan.control.css">
        <link rel="stylesheet" href="css/contact.css">
    </head>
    <body class="um-vp" ontouchstart>
        <div class="tx-c sc-bg-active" id="pullstatus"></div>
        <div id="ele_comment"></div>

        <script src="../../build/js/appcan.js"></script>
        <script src="../../build/js/appcan.control.js"></script>
        <script src="../../common/comm.js"></script>
    </body>
    <script>
        var historyTag = false;
        var now = new Date();
        var queryDate = now.formate("yyyy-MM-dd");
        var username = appcan.locStorage.getVal('username');
        appcan.ready(function() {
            appcan.frame.setBounce(0, function(type) {
                $("#pullstatus").html("下拉查看历史消息");
            }, function(type) {
            }, function(type) {
                appcan.frame.resetBounce(type);
                $("#pullstatus").html("");
                if (historyTag == true) {
                    $("#pullstatus").html("无更多历史记录");
                    return;
                }
                var historyDate = new Date();
                historyDate.setDate(historyDate.getDate() - 3);
                historyDate = historyDate.formate("yyyy-MM-dd");
                console.log(username)
               
                    queryLog(historyDate);
                    historyTag = true;
             
            })
            if(username){
                queryLog(queryDate);
            setInterval("queryMsg()", 10000);
            }
            
        })
        function queryLog(qDate) {
            var url = URL + "/app/logMng/queryLog";
            var paramJsonStr = "logTimeFrom=" + qDate + "&sort=logTime&direction=asc";
            var func = queryLogCallBack;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            
        }

        function queryLogCallBack(data) {
           
            data = JSON.parse(data);
            
            if (historyTag == true) {
                for (var i = data.length - 1; i >= 0; i--) {
                    var cusId = data[i].cusId;
                    var logFrom = data[i].logFrom;
                    var logTime = data[i].logTime;
                    queryDate = logTime;
                    var logContent = data[i].logContent;

                    showChatHtml(cusId, logFrom, logTime, logContent);
                };
                historyTag = false;
            } else {
                console.log(data)
                for (var i = 0; i < data.length; i++) {
                    var cusId = data[i].cusId;
                    var logFrom = data[i].logFrom;
                    var logTime = data[i].logTime;
                    queryDate = logTime;
                    var logContent = data[i].logContent;

                    showChatHtml(cusId, logFrom, logTime, logContent);
                };
            }

        }

        function showChatHtml(cusId, logFrom, logTime, logContent) {
            var htmlStr = "";
            if (cusId == logFrom) {
                htmlStr = appendHtml(true, logTime, logContent)
            } else {
                htmlStr = appendHtml(false, logTime, logContent)
            }
            if (historyTag == true) {
                $("#ele_comment")[0].innerHTML = htmlStr;
            } else {
                $("#ele_comment").append(htmlStr);
            }
        }

        function appendHtml(cus, logTime, logContent) {
            var msg = "";
            if (cus == true) {
                msg += '<div class="ub uinn-ebt">' + '<div class="ub-f1 ufl"><div class="msg-box white-font green-bg b-radius">' + '<div class="arrow right-arrow"></div><div class="date color1">' + logTime + '</div><div class="umar-b send-info">' + logContent + ' </div></div></div><div class="ub-img avatar send-avatar a-margin-l"></div></div>';
            } else {
                msg += '<div class="ub uinn-ebt"><div class="ub-img avatar m-avatar a-margin-r"></div>' + '<div class="ub-f1 ufl"><div class="white-bg b-radius msg-box2">' + '<div class="arrow left-arrow"></div><div class="date color2">' + logTime + '</div><div class="send-info">' + logContent + ' </div></div></div></div>';
            }

            return msg;
        }

        function sendMessage(msgData) {
            var url = URL + "/app/logMng/addLog";
            var paramJsonStr = "logContent=" + msgData;
            var func = addLogCallBack;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('消息正在发送...', '0', '5', '1');
            var tmpDate = new Date();
            var currentDate = tmpDate.formate("yyyy-MM-dd hh:mm:ss");

            showChatHtml("a", "a", currentDate, msgData)
        }

        function addLogCallBack(data) {
            appcan.window.closeToast();

        }

        function queryMsg() {
            var url = URL + "/app/logMng/queryLog";
            var paramJsonStr = "logTimeFrom=" + queryDate + "&&onlyTo=0&sort=logTime&direction=asc";
            var func = queryLogCallBack;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('数据加载中...', '0', '5', '1');
        }
    </script>
</html>
