<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="../build/css/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../build/css/ui-box.css">
    <link rel="stylesheet" href="../build/css/ui-base.css">
    <link rel="stylesheet" href="../build/css/ui-color.css">
    <link rel="stylesheet" href="../build/css/appcan.icon.css">
    <link rel="stylesheet" href="../build/css/appcan.control.css">
    <link rel="stylesheet" type="text/css" href="../ordermgmt/css/ordermgmt.css" />
    <link rel="stylesheet" type="text/css" href="css/delivery.css" />
</head>

<body id="nodata" class="bc-bg ub-f1 tx-l umar-t content-info" ontouchstart>
    <form id="formData" style="display: none;">
        <div class="top-show ub ub-ac ub-pc">
            <label for="cusName">查看方式：</label>
            <select id="searchType" name="queryAll" class="mySelect">
                <option value="" selected>可提油单据</option>
                <option value="queryAll">所有提油单数据</option>
            </select>
        </div>
    </form>

    <div id="content">

    </div>

</body>
<script type="text/html" charset="utf-8" id="putongCus">
    {{each list}}
    <div class="list">
        <div id="NOinfo" class="ub sc-bg ub-pj">
            <div id="NO" class="ub ub-ver margin-t" style="margin-left:1em;">
                <div id="fyNO" class="ub ub-ac">
                    <span class="gray-font">订单号：</span>{{$value.ordersaleCode}}
                </div>
                <div id="oil" class="ub ub-ac umar-t mf-size1">
                    <div id="oilname" class="">
                        {{$value.oilinfoName}}
                    </div>
                    <div id="depot" class="ub umar-a site">
                        {{if $value.extractType==1}} 自提 {{else}} 配送 {{/if}}
                    </div>
                    <span style="margin-left: 1em;" class="gary-font">{{$value.createDate}}</span>
                </div>
            </div>
        </div>

        <div id="oilInfo" class="sc-bg ub ub-ver">

            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    销售单位：
                    <span class="mf-color">{{$value.xsdwName}}</span>
                </div>

            </div>
            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    订单量：
                    <span class="mf-color mf-size">{{$value.orderNum | ThreeDecimal}}</span>
                    <span class="gray-font mf-size2 umar-l">吨</span>
                </div>

            </div>

            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    可申请量：
                    <span class="mf-color mf-size">{{ if $value.orderNum-$value.outNum-$value.yikaiweiti
                        <0 }} 0 {{else}} {{$value.orderNum-$value.outNum-$value.yikaiweiti}} {{/if}}</span>
                            <span class="gray-font mf-size2 umar-l">吨</span>
                </div>
                <div id="" class="ub-f1">
                    已开未提量：
                    <span class="mf-color mf-size">{{ if $value.yikaiweiti
                        <0}} 0 {{else}} {{$value.yikaiweiti | OneDecimal}} {{/if}} </span>
                            <span class="gray-font mf-size2 umar-l">吨</span>
                </div>
            </div>

            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    已出库量：
                    <span class="mf-color mf-size">{{$value.outNum}}</span>
                    <span class="gray-font mf-size2 umar-l">吨</span>
                </div>
                <div id="" class="ub-f1">
                    未出库量：
                    <span class="mf-color mf-size">{{$value.orderNum-$value.outNum | number}}</span>
                    <span class="gray-font mf-size2 umar-l">吨</span>
                </div>

            </div>
            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    运输方式：
                    <span> {{if $value.ysfs=='traffic_type_0'}} 公路 {{else if $value.ysfs=='traffic_type_1'}} 水运 {{/if}}</span>
                </div>
                <div id="" class="ub-f1">
                    油库地点：
                    <span>{{$value.depotName}}</span>
                </div>

            </div>

            <div class="ub ub-pe umar-r t-border padding-a">
                {{if $value.extractType==0}}
                <span id="配送#{{$value.noticeSubId}}" index={{$index}} value={{$value.orderNum-$value.outNum-$value.yikaiweiti}} class="m-act2 mf-size2 green-bg"
                    onclick="BtnClick(this)">配送</span>
                {{else}}
                <span id="预约#{{$value.noticeSubId}}" value={{$value.orderNum-$value.outNum-$value.yikaiweiti}} class="m-act2 mf-size2 orange-bg"
                    onclick="BtnClick(this)">自提</span>
                {{/if}}
            </div>
        </div>
    </div>
    {{/each}}
</script>

<script type="text/html" charset="utf-8" id="kongguCus">
    {{each list}}
    <div class="list">
        <div id="NOinfo" class="ub sc-bg ub-pj">
            <div id="NO" class="ub ub-ver margin-t" style="margin-left:1em;">
                <div id="fyNO" class="ub ub-ac">
                    <span class="gray-font">订单号：</span>{{$value.ordersaleCode}}
                </div>
                <div id="oil" class="ub ub-ac umar-t mf-size1">
                    <div id="oilname" class="">
                        {{$value.oilinfoName}}
                    </div>
                    <div id="depot" class="ub umar-a site">
                        {{if $value.extractType==1}} 自提 {{else}} 配送 {{/if}}
                    </div>
                    <span style="margin-left: 1em;" class="gary-font">{{$value.createDate}}</span>
                </div>
            </div>
        </div>

        <div id="oilInfo" class="sc-bg ub ub-ver">

            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    销售单位：
                    <span class="mf-color">{{$value.xsdwName}}</span>
                </div>

            </div>
            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    订单量：
                    <span class="mf-color mf-size">{{$value.orderNum | ThreeDecimal}}</span>
                    <span class="gray-font mf-size2 umar-l">吨</span>
                </div>

            </div>

            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    可申请量：
                    <span class="mf-color mf-size">
                        {{ if $value.orderNum-$value.outNum-$value.guanlianOutNum-$value.yikaiweiti-$value.guanlianyikaiweiti
                        <0}} 0 {{else}} {{$value.orderNum-$value.outNum-$value.guanlianOutNum-$value.yikaiweiti-$value.guanlianyikaiweiti}} {{/if}}
                            </span>
                            <span class="gray-font mf-size2 umar-l">吨</span>
                </div>
                <div id="" class="ub-f1">
                    已开未提量：
                    <span class="mf-color mf-size">{{ if $value.yikaiweiti+$value.guanlianyikaiweiti
                        <0}} 0 {{else}} {{ $value.yikaiweiti+$value.guanlianyikaiweiti | OneDecimal}} {{/if}} </span>
                            <span class="gray-font mf-size2 umar-l">吨</span>
                </div>
            </div>

            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    已出库量：
                    <span class="mf-color mf-size">{{$value.outNum+$value.guanlianOutNum}}</span>
                    <span class="gray-font mf-size2 umar-l">吨</span>
                </div>
                <div id="" class="ub-f1">
                    未出库量：
                    <span class="mf-color mf-size">{{$value.orderNum-$value.outNum-$value.guanlianOutNum| number}}</span>
                    <span class="gray-font mf-size2 umar-l">吨</span>
                </div>
            </div>
            <div id="stock" class="ub ub-ac order-info">
                <div id="" class="ub-f1">
                    运输方式：
                    <span> {{if $value.ysfs=='traffic_type_0'}} 公路 {{else if $value.ysfs=='traffic_type_1'}} 水运 {{/if}}</span>
                </div>
                <div id="" class="ub-f1">
                    油库地点：
                    <span>{{$value.depotName}}</span>
                </div>

            </div>

            <div class="ub ub-pe umar-r t-border padding-a">
                {{if $value.extractType==0}}
                <span id="配送#{{$value.noticeSubId}}" data-value={{$value.orderNum-$value.outNum-$value.guanlianOutNum-$value.yikaiweiti-$value.guanlianyikaiweiti}}
                    class="m-act2 mf-size2 green-bg" onclick="BtnClick(this)">配送</span>
                {{else}}
                <span id="预约#{{$value.noticeSubId}}" data-value={{$value.orderNum-$value.outNum-$value.guanlianOutNum-$value.yikaiweiti-$value.guanlianyikaiweiti}}
                    class="m-act2 mf-size2 orange-bg" onclick="BtnClick(this)">自提</span>
                {{/if}}
            </div>
        </div>
    </div>
    {{/each}}
</script>
<script src="../build/js/appcan.js"></script>
<script src="../build/js/appcan.control.js"></script>
<script src="../common/template-web.js" type="text/javascript" charset="utf-8"></script>
<script src="../common/comm.js"></script>
<script src="../common/jquery.min.js" type="text/javascript" charset="utf-8"></script>

<script>
    appcan.ready(function () {
        mentionOil.init();

        appcan.window.subscribe("peisongRefresh", function (param) {
            if (param == "true") {
                getNewAllNotice();
            }
        });
        appcan.window.subscribe("zitiRefresh", function (param) {
            if (param == "true") {
                getNewAllNotice();
            }
        });
    })

    template.defaults.imports.ThreeDecimal = function (number) {
        return number.toFixed(3);
    }
    template.defaults.imports.number = function (number) {
        var times = Math.pow(10, 3);
        var roundNum = Math.round(number * times) / times;
        return roundNum.toFixed(3);
    }
    template.defaults.imports.OneDecimal = function (number) {
        return number.toFixed(1);
    }

    var mentionOil = {
        init: function () {
            var yue = this;
            yue.queryMentOilOrder();
            document.getElementById("searchType").onchange = function () {
                getNewAllNotice();
            }
        },
        queryMentOilOrder: function () {
            var yue = this;
            var username = appcan.locStorage.getVal("username");
            if (!username) {
                nodata('content', '请先登录再查看提油记录')
                return;
            }
            var param = serialize(document.getElementById("formData"));
            var func = yue.showOrderCallback.bind(yue);

            ajaxPostQuery(URL + "/app/bill/getOilExtraction", param, func, "text");
            appcan.window.openToast('加载中...', '0', '5', '1');
            appcan.initBounce();

        },
        showOrderCallback: function (data) {
            appcan.window.closeToast();
            if (data === "") {
                nodata('content', '您没有符合条件的付油通知单');
                return;
            }
            if (typeof data == "string" && data != "") {
                data = JSON.parse(data)
            }

            if (!data.list || data.list.length == 0) {
                nodata('content', '您没有符合条件的付油通知单');

                return;
            } else {
                show(document.getElementById("formData"));
                var dataAll = data.list;
                for (var i = 0; i < dataAll.length; i++) {
                    dataAll[i].outNum ? dataAll[i].outNum : dataAll[i].outNum = 0;
                    dataAll[i].guanlianOutNum ? dataAll[i].guanlianOutNum : dataAll[i].guanlianOutNum = 0;
                    dataAll[i].yikaiweiti ? dataAll[i].yikaiweiti : dataAll[i].yikaiweiti = 0;
                    dataAll[i].guanlianyikaiweiti ? dataAll[i].guanlianyikaiweiti : dataAll[i].guanlianyikaiweiti =
                        0;

                }
            }

            var ahtml = null;
            if (data.cusType == "普通客户") {
                ahtml = template('putongCus', {
                    list: data.list
                });
            } else if (data.cusType == "控股公司") {
                ahtml = template('kongguCus', {
                    list: data.list
                });
            }

            document.getElementById('content').innerHTML = ahtml;
        }
    }


    function BtnClick(that) {
        // 校验可申请量为0的情况
        console.dir(that)

        var arr = that.id.split('#');
        var text = arr[0];
        var noticeSubId = arr[1];
        appcan.locStorage.setVal("yuyuenoticeId", noticeSubId);

        if (text === "配送") {
            appcan.window.open("delivery", "delivery.html", 10);

        } else if (text === "预约") {
            appcan.window.open("detail", "zitipage.html", 10);
        }
    }

    function getNewAllNotice() {
        document.getElementById('content').innerHTML = "";
        // 暂时没有分页 不删除
        if (document.getElementById('more')) {
            document.getElementById('more').innerHTML = "";
        }
        mentionOil.queryMentOilOrder();
    }
</script>

</html>