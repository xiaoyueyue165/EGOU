<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../../build/css/ui-box.css">
    <link rel="stylesheet" href="../../build/css/ui-base.css">
    <link rel="stylesheet" href="../../build/css/ui-color.css">
    <link rel="stylesheet" href="../../build/css/appcan.icon.css">
    <link rel="stylesheet" href="../../build/css/appcan.control.css">
    <link rel="stylesheet" href="./css/funds.css">
    <link rel="stylesheet" type="text/css" href="../../common/css/yue.css" />

    <style type="text/css">
        a {
            text-decoration: none;
            color: #000;
        }

        dl,
        dt,
        dd {
            margin: 0;
            padding: 0;
        }

        #content {
            padding: 1em;
        }

        #companyName,
        #threeState {
            width: 100%;
            height: 3em;
            line-height: 3em;
        }

        #content ul {
            width: 100%;
            height: inherit;
            line-height: inherit
        }

        #content ul li:first-child {
            line-height: inherit;
            width: 30%;
            height: 2.4em;
            float: left;
            text-align: center;
        }

        #content ul li:last-child {
            line-height: inherit;
            width: 60%;
            height: 3em;
            float: left;
            text-align: center;
        }

        #chooseWay {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 0.2em 0.4em 1.2em;
            z-index: 999;
            border-radius: 0.3em;
        }

        #chooseWay dd {
            height: 1.6em;
        }

        #chooseWay a {
            padding: 0.2em 0.2em;
            color: #333;
            line-height: 1.6em;
        }

        #chooseWay a:hover {
            cursor: pointer;
            background-color: #f5f5f5;
        }

        .select {
            height: 2.4em;
        }
    </style>
</head>

<body class="um-vp white-bg" ontouchstart onload="useInfoLoad();">
    <div id="page_0" class="up ub ub-ver white-bg" tabindex="0">
        <!--header开始-->
        <div class="uh bc-text-head ub bc-head" id="header">
            <div class="nav-btn" id="nav-left">
                <div class="t-btn-a1 ub-img uwh-tBtn fa fa-angle-left fa-2x"></div>
            </div>
            <h1 class="ut ub-f1 ulev-3 ut-s tx-c" tabindex="0">资金余额</h1>
            <div class="nav-btn" id="nav-right"></div>
        </div>
        <!--header结束-->
        <!-- 登录模块 -->
        <div id="login" style="height:12.888em;background:url(../../index/page3/myImg/head_bg.jpg);background-size:100%;">
            <input id="fundId" type="hidden" />
            <input id="gyfgs" type="hidden" />
            <input id="useAbleMoney" type="hidden" />

            <div id="avatar" class="">
                <div id="nameBar">
                    <div class="photo--small">

                    </div>
                    <h6 class="mf-size1 userName"></h6>
                </div>
                <div id="amount" class="">
                    <p>
                        账户余额(元)
                    </p>
                    <p id="funds" class="">
                        0.00
                    </p>
                    <div id="assets">
                        <p>
                            所属公司
                            <span id="myCompany" class="ulev-1"> </span>
                        </p>
                        <p>
                            可用余额
                            <span id="useAbleMoney1" class="ulev-1"> </span>
                            <span> 元</span>
                        </p>
                        <p>
                            授信余额
                            <span id="shouxinMoney" class="ulev-1"> </span>
                            <span> 元</span>
                        </p>
                    </div>

                </div>

            </div>

        </div>
        <!--content开始-->

        <div id="content">
            <div id="companyName">
                <ul>

                    <li>
                        付款单位
                    </li>
                    <li>

                        <div class="select uba bc-border bc-text">
                            <div class="text firstComp" style="padding: 0;white-space: nowrap; overflow: hidden; text-overflow: ellipsis;line-height: 2.4em;">

                            </div>
                            <div class="icon"></div>
                            <select id="companyList" selectedindex="0" onchange="changeCompany();">

                            </select>

                        </div>
                    </li>
                </ul>
            </div>
            <div id="threeState">
                <dl id="chooseWay" class="hide" style="position: absolute;top:3em;">

                    <dd>
                        <a title="充值金额">充值金额</a>
                    </dd>
                    <dd>
                        <a title="授信金额">授信金额</a>
                    </dd>
                    <dd>
                        <a title="申请退款">申请退款</a>
                    </dd>
                </dl>
                <ul>

                    <li>

                        <a href="#" id="fundValue">充值金额</a>
                    </li>
                    <li>
                            <div  class="ub ub-ac ubb umh5 bc-border uinput ub-f1 ">
                                    <input id="num" placeholder="请输入金额" type="text" class="ub-f1" />
                                </div>

                    </li>
                </ul>
            </div>
            <div id="btn-wrap">
                <input type="submit" class="font btn ub ub-ac bc-text-head ub-pc bc-btn green" name="" id="btn" value="充值" />
            </div>
        </div>

    </div>

</body>

<script type="text/javascript" charset="utf-8" src="../../build/js/appcan.js"></script>
<script type="text/javascript" charset="utf-8" src="../../build/js/appcan.control.js"></script>
<script src="../../common/comm.js"></script>
<script src="../../common/template-web.js"></script>
<script src="../../common/jquery.min.js"></script>
<script type="text/javascript" charset="utf-8" src="../../common/numeral.min.js"></script>
<script id="Company_tmpl" type="text/html">
    {{each list}}
    <option linkId={ {$value.linkId}} value={{$value.linkId+ '*'+$value.orgName}}>{{$value.orgName}}</option>

    {{/each}}
</script>

<script>
    var btn = document.getElementById('btn');
    document.getElementById('fundValue').onclick = function () {
        var chooseWay = document.getElementById('chooseWay');
        chooseWay.className = "";
        var Allbtn = document.querySelectorAll('#chooseWay dd');
        var btnArr = Array.prototype.slice.call(Allbtn);
        for (var i = 0; i < btnArr.length; i++) {
            addEvent(btnArr[i], 'click', function (e) {
                var text = e.target.innerText.trim();
                var btn = document.getElementById('btn');
                if (text == '申请退款') {
                    btn.style.backgroundColor = '#d9534f';
                } else if (text == '授信金额') {
                    btn.style.backgroundColor = '#ec971f';
                } else {
                    btn.style.backgroundColor = '#1AAD19';
                }
                btn.value = text;
                chooseWay.className = "hide";
            })
        }

    }

    appcan.ready(function () {
        queryCusBasOrg();
    });
    //打开页面时加载本地存储的用户信息
    function useInfoLoad() {
        var username = appcan.locStorage.getVal("username");
        var password = appcan.locStorage.getVal("password");
        var cusCompany = appcan.locStorage.getVal('cusCompany');

        if (cusCompany) {
            $('.userName').html(cusCompany);
            return;
        }
        $('.userName').html(username);

    }

    //公司列表
    function queryCusBasOrg() {
        var url = URL + "/app/cus/queryCusBasOrg";

        var paramJsonStr = "";
        var func = showCompanyCallback;
        var dataType = "text";
        ajaxPostQuery(url, paramJsonStr, func, dataType);
        appcan.window.openToast('正在加载...', '0', '5', '1');

    }

    function showCompanyCallback(data) {

        appcan.window.closeToast();

        if (typeof data == "string") {
            data = JSON.parse(data)
        };
        if (typeof data !== "object") {
            throw new Error('公司数据格式不正确')
            return;
        }
        //默认公司首个id
        var firstId = data[0].linkId;

        var html = template('Company_tmpl', {
            list: data
        });
        $('#companyList').html(html);

        //默认首个公司名显示
        var firstComp = $('#companyList').find('option').eq(0)[0].innerHTML;
        document.getElementsByClassName('firstComp')[0].innerHTML = firstComp;

        var earlyId = $('#companyList').find('option').eq(0)[0].getAttribute('linkId');

        $('#myCompany').html('&nbsp;' + firstComp);

        getBalanceById(earlyId);
    }

    //公司名改变
    function changeCompany() {

        var Text = $('#companyList')[0].value;
        var arr = Text.split('*');

        var linkId = arr[0];

        var CompanyName = arr[1];

        $('#myCompany').html('&nbsp;' + CompanyName);
        document.getElementsByClassName('text')[0].text = CompanyName;
        $('.text').html(CompanyName);

        getBalanceById(linkId);

    }

    function getBalanceById(ID) {
        var url = URL + "/app/cus/queryCusPayMoney";
        var func = showBalanceByIdCallback;
        var paramJsonStr = "&pager.pageNo=" + pageNo + "&pager.pageSize=" + pageSize + "&cusOrgLinkid=" + ID;
        var dataType = "text";
        ajaxPostQuery(url, paramJsonStr, func, dataType);
        appcan.window.openToast('正在加载...', '0', '5', '1');
    }

    function showBalanceByIdCallback(data) {
        appcan.window.closeToast();

        if (typeof data == "string") {
            data = JSON.parse(data)
        };

        if (data === 0) {
            $('#funds').html('0.00');
            document.getElementById('useAbleMoney1').innerHTML = " 0.00";
            document.getElementById('shouxinMoney').innerHTML = "&nbsp" + "0.00";
            return;
        }
        // 账户余额
        if (data) {
            var data = data.rows;
            var totleMoney = data[0].TOTLE_MONEY;
            var balance = totleMoney && totleMoney > 0 ? fmoney(totleMoney, 2) : '0.00';

            $('#funds').html(balance);
        }

        // 退款参数
        var fundId = data[0].FUND_ID;
        var useAble = data[0].USABLE_MONEY;
        var useAbleMoney = useAble && useAble > 0 ? fmoney(useAble, 2) : "0.00"

        document.getElementById('fundId').value = fundId;

        var gyfgs = data[0].GYFGS1;

        document.getElementById('gyfgs').value = gyfgs;

        document.getElementById('useAbleMoney').value = useAbleMoney
        // 可用余额
        document.getElementById('useAbleMoney1').innerHTML = "&nbsp" + useAbleMoney;

        // 授信金额

        var shouxinMoney = data[0].SHOUXIN_MONEY ? data[0].SHOUXIN_MONEY : "&nbsp" + "0.00"
        document.getElementById('shouxinMoney').innerHTML = "&nbsp" + shouxinMoney;

    }



    //充值
    appcan.button("#btn", "ani-act", function () {

        var str = $('#companyList')[0].value.split('*');

        var linkId = str[0];

        var CompanyName = str[1];

        var Cusfund = document.getElementById('num').value;
        var fundId = document.getElementById('fundId').value;
        var gyfgs = document.getElementById('gyfgs').value;

        var useAbleMoney = document.getElementById('useAbleMoney').value

        var BtnValue = document.getElementById('btn').value;
        var fundNumber = document.getElementById('num').value;

        // alert(fundValue)
        if (Cusfund == "") {
            appcan.window.alert({
                title: '提示',
                content: "请输入有效金额！",
                buttons: '确定'
            });
            return;
        }
        if (BtnValue === "充值金额" || BtnValue === "充值") {

            var totleMoney = document.getElementById('funds').value;

            Recharge(fundNumber, linkId)
        }
        if (BtnValue === "授信金额") {

            CreditRecharge(fundNumber, linkId)
        }
        if (BtnValue === "申请退款") {


            Refund(fundNumber, fundId, gyfgs, useAbleMoney, totleMoney)
        }

    })
    // 打款金额充值
    function Recharge(fundNumber, linkId) {
        var url = URL + "/app/cus/addCustomerFund";
        var paramJsonStr = "cusFund=" + fundNumber + "&linkId=" + linkId + "&cusOrgLinkid=" + linkId + "&opeType=" + 0;
        $.ajax({
            type: 'post',
            url: url,
            data: paramJsonStr,
            async: false,
            beforeSend: function () {
                appcan.window.openToast('正在加载...', '0', '5', '1');
            },
            success: function (data) {
                RechargeCallback(data);
            }
        })
    }

    // 授信金额充值
    function CreditRecharge(fundNumber, linkId) {
        var url = URL + "/app/cus/addCustomerFund";
        var paramJsonStr = "cusFund=" + fundNumber + "&linkId=" + linkId + "&cusOrgLinkid=" + linkId + "&opeType=" + 3;

        $.ajax({
            type: 'post',
            url: url,
            data: paramJsonStr,
            async: false,
            beforeSend: function () {
                appcan.window.openToast('正在加载...', '0', '5', '1');
            },
            success: function (data) {
                RechargeCallback(data);
            }
        })
    }

    // 退款金额申请
    function Refund(tkfund, fundId, gyfgs, useAbleMoney, totleMoney) {
        var url = URL + "/app/cus/tuikuanCustomerFund";
        var useAbleMoney = rmoney(useAbleMoney);
        var sid = appcan.locStorage.getVal("sid");
        var paramJsonStr = "tuikuan=" + tkfund + "&fundId=" + fundId + "&useAbleMoney=" + useAbleMoney + "&gyfgs=" +
            gyfgs + "&sid=" + sid;

        $.ajax({
            type: 'post',
            url: url,
            data: paramJsonStr,
            async: false,
            beforeSend: function () {
                appcan.window.openToast('正在加载...', '0', '5', '1');
            },
            success: function (data) {
                if (typeof data == 'string' && data == 0) {
                    appcan.window.closeToast();
                    $('#num')[0].value = "";
                    setTimeout(function () {
                        appcan.window.alert({
                            title: '提示',
                            content: "充值成功，请等待后台审核！",
                            buttons: '确定'
                        });
                    }, 300)
                } else {
                    appcan.window.closeToast();
                    setTimeout(function () {
                        appcan.window.alert({
                            title: '提示',
                            content: "充值失败，请重试！",
                            buttons: '确定'
                        });
                    }, 300)
                }
            }
        })

    }

    function RechargeCallback(data) {
        appcan.window.closeToast();

        if (typeof data == "string" && JSON.parse(data) == 1) {

            $('#num')[0].value = "";
            setTimeout(function () {
                appcan.window.alert({
                    title: '提示',
                    content: "申请退款成功，请等待后台审核！",
                    buttons: '确定'
                });
            }, 300)

        } else {
            setTimeout(function () {
                appcan.window.alert({
                    title: '提示',
                    content: "充值失败，请重试！",
                    buttons: '确定'
                });
            }, 300)

        }

    }


    appcan.button("#nav-left", "btn-act", function () {
        appcan.window.close(-1);
    })
</script>

</html>