// 194 内
// var URL = "http://11.11.153.194:8080/SHXSKH";
// var PICURL = "http://11.11.153.194:8080";

// 正式

// var URL = "http://egou.cnpc.com.cn:8080/SHXSKH";
// var PICURL = "http://egou.cnpc.com.cn:8080";


// 岩
var URL = "http://11.0.36.205:8080/SHXSKH";
var PICURL = "http://11.0.36.205:8080";


// 栋
// var URL = "http://10.88.113.96:8080/SHXSKH";
// var PICURL = "http://10.88.113.96:8080";

//从第几条开始

var CURRENT_PAGE = 1,
    offset = "1",
    limit = 15,
    //每页显示行数
    pageNo = 1,
    //从第几条开始
    pageSize = 10;
//每页显示行数

var defaultDate = getDate(1).split(" ")[0] + " 下午";


//当前设备信息
var u = navigator.userAgent,
    device = "";
if (u.indexOf('Android') > -1 || u.indexOf('Linux') > -1) {
    //安卓手机
    device = "Android";

} else if (u.indexOf('iPhone') > -1) { //苹果手机
    device = "iPhone";
}

// 错误监控
window.onerror = function (errMsg, scriptURI, lineNumber, columnNumber, errorObj) {
    setTimeout(function () {
        var rst = {
            "错误信息：": errMsg,
            "出错文件：": scriptURI,
            "出错行号：": lineNumber,
            "出错列号：": columnNumber,
            "错误详情：": errorObj
        };

        console.log(JSON.stringify(rst, null, 10));
    });
};

var _extend = function (option, opt) {
    if (typeof (opt) != 'object' || !opt) {
        return option;
    }
    for (var property in opt) {
        option[property] = opt[property];
    }
    return option;
};

// form表单序列化
function serialize(form) {
    var parts = [],
        field = null,
        i,
        len,
        j,
        optLen,
        option,
        optValue;

    for (i = 0, len = form.elements.length; i < len; i++) {
        field = form.elements[i];

        switch (field.type) {
            case "select-one":
            case "select-multiple":

                if (field.name.length) {
                    for (j = 0, optLen = field.options.length; j < optLen; j++) {
                        option = field.options[j];
                        if (option.selected) {
                            optValue = "";
                            if (option.hasAttribute) {
                                optValue = (option.hasAttribute("value") ? option.value : option.text);
                            } else {
                                optValue = (option.attributes["value"].specified ? option.value : option.text);
                            }
                            parts.push(encodeURIComponent(field.name) + "=" + encodeURIComponent(optValue));
                        }
                    }
                }
                break;

            case undefined: //fieldset
            case "file": //file input
            case "submit": //submit button
            case "reset": //reset button
            case "button": //custom button
                break;

            case "radio": //radio button
            case "checkbox": //checkbox
                if (!field.checked) {
                    break;
                }
                /* falls through */

            default:
                //don't include form fields without names
                if (field.name.length) {
                    parts.push(encodeURIComponent(field.name) + "=" + encodeURIComponent(field.value));
                }
        }
    }
    return parts.join("&");
}


function isLogin() {
    var isLogin = appcan.locStorage.getVal("isLogin");
    if (isLogin) {
        alert('登录成功');
    } else {
        alert("登录失效，请重新登录")
        lsrmItems(["sid", "cusId", "password", "userId", "username", "userType", "tag", "QRCode"]);
        appcan.locStorage.setVal("status", "out");

        appcan.window.publish("logout", "logout");
        appcan.window.open("index", "../index.html", 0);
    }

}

function oneAlert(text, button, callback) {
    var btn = button || "确定";

    appcan.window.alert({
        title: "提示",
        content: text,
        buttons: [btn],
        callback: function (err, data, dataType, optId) {
            if (data == '0') {
                if (callback && typeof callback === 'function') {
                    callback();
                }
            }
            if (data == '1') {}
            console.log(err, data, dataType, optId);
        }
    });
}

function twoAlert(text, button1, button2, func1, func2) {
    appcan.window.alert({
        title: "提示",
        content: text,
        buttons: [button1, button2],
        callback: function (err, data, dataType, optId) {
            if (data == '0') {
                // button1
                func1();
            }
            if (data == '1') {
                func2();
            }
            console.log(err, data, dataType, optId);
        }
    });
}

function getVal(str) {
    return appcan.locStorage.getVal(str);
}

function setVal(str, obj) {
    appcan.locStorage.setVal(str, obj);
}
function removeVal(str) {
    appcan.locStorage.remove(str);
}

function lsSetItems(obj) {
    for (var i in obj) {
        appcan.locStorage.setVal(i, obj[i])
    }

}

function lsrmItems(arr) {
    arr.forEach(function (i) {
        appcan.locStorage.remove(arr[i])
    });

}

function isContains(arr, current) {
    if (Array.prototype.includes) {
        return arr.includes(current);
    }
    for (i = 0; i < arr.length && arr[i] != current; i++);
    return !(i == arr.length);
}

function ajaxPostQuery(url, paramJsonStr, func, dataType) {
    var type = dataType || "json";
    var sid = appcan.locStorage.getVal("sid");
    var response = null;

    $.ajax({
        type: "POST",
        url: URL + '/app/user/validationSession',
        data: "&sid=" + sid,
        success: function (response) {

            response = JSON.parse(response).validation;
            if (response) {
                $.ajax({
                    type: "POST",
                    url: url,
                    data: paramJsonStr + "&sid=" + sid,
                    headers: {
                        accept: "*/*"
                    },
                    //contentType:"application/x-www-form-urlencoded",
                    dataType: type,
                    timeout: 0,
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        appcan.window.alert("提示", "网络暂时不可用", "确定");
                    },
                    success: function (data) {

                        var errorData;
                        if (typeof data == "string") {
                            try {
                                errorData = JSON.parse(data);
                                if (errorData.error == "-1") {} else {
                                    func(data);
                                }
                            } catch (e) {
                                func(data);
                            }
                        }
                    }
                });
            } else {
                oneAlert("您的登录认证已过期，请您重新登录...", "确定", function () {
                    lsrmItems(["sid", "cusId", "password", "userId", "username", "userType", "tag", "QRCode"]);

                    $.ajax({
                        type: "POST",
                        url: URL + "/comm/user/loginOut",
                        data: '',
                        dataType: 'text',
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            appcan.window.alert("提示", "网络暂时不可用", "确定");
                        },
                        success: function (data) {

                        }
                    })

                    appcan.locStorage.setVal("status", "out");

                    setTimeout(function () {
                        appcan.window.publish("logout", "logout");
                        appcan.window.open("index", "index.html", 0);
                    }, 1000);
                });
            }

        },
        error: function (error) {
            console.log(error)
        }
    })
}

function ajaxPostQueryDNnotVerifySid(url, paramJsonStr, func, dataType) {
    var type = dataType || "json";
    var sid = appcan.locStorage.getVal("sid");
    var username = appcan.locStorage.getVal("username");

    $.ajax({
        type: "POST",
        url: url,
        data: paramJsonStr + "&sid=" + sid,
        headers: {
            accept: "*/*"
        },
        //contentType:"application/x-www-form-urlencoded",
        dataType: type,
        timeout: 0,
        error: function (XMLHttpRequest, textStatus, errorThrown) {
            appcan.window.alert("提示", "网络暂时不可用", "确定");
        },
        success: function (data) {

            var errorData;
            if (typeof data == "string") {
                try {
                    errorData = JSON.parse(data);

                    if (errorData.error == "-1") {} else {
                        if (typeof func === 'function') {
                            func(data);
                        }
                    }
                } catch (e) {
                    if (typeof func === 'function') {
                        func(data);
                    }
                }
            }
        }
    });
}

/**
 * @param  {setting}
 */
function ajax(setting) {
    //设置参数的初始值
    var opts = {
        method: (setting.method || "POST").toUpperCase(), //请求方式
        url: setting.url || "", // 请求地址
        async: setting.async || true, // 是否异步
        dataType: setting.dataType || "json", // 解析方式
        data: setting.data || "", // 参数
        success: setting.success ||
            function () {}, // 请求成功回调
        error: setting.error ||
            function () {} // 请求失败回调

    }

    // 参数格式化
    function params_format(obj) {
        var str = ''
        for (var i in obj) {
            str += i + '=' + obj[i] + '&'
        }
        return str.split('').slice(0, -1).join('')
    }

    // 创建ajax对象
    var xhr = new XMLHttpRequest();

    // 连接服务器open(方法GET/POST，请求地址， 异步传输)
    if (opts.method == 'GET') {
        xhr.open(opts.method, opts.url + "?" + params_format(opts.data), opts.async);
        xhr.send();
    } else {
        xhr.open(opts.method, opts.url, opts.async);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.send(opts.data);
    }

    /*
     ** 每当readyState改变时，就会触发onreadystatechange事件
     ** readyState属性存储有XMLHttpRequest的状态信息
     ** 0 ：请求未初始化
     ** 1 ：服务器连接已建立
     ** 2 ：请求已接受
     ** 3 : 请求处理中
     ** 4 ：请求已完成，且相应就绪
     */
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && (xhr.status === 200 || xhr.status === 304)) {
            switch (opts.dataType) {
                case "json":
                    var json = JSON.parse(xhr.responseText);
                    opts.success(json);
                    break;
                case "xml":
                    opts.success(xhr.responseXML);
                    break;
                default:
                    opts.success(xhr.responseText);
                    break;
            }
        }
    }

    xhr.onerror = function (err) {
        opts.error(err);
    }
}

// 节流函数

function throttle(func, wait, options) {
    var timeout, context, args, result;
    var previous = 0;
    if (!options) options = {};

    var later = function () {
      previous = options.leading === false ? 0 : new Date().getTime();
      timeout = null;
      func.apply(context, args);
      if (!timeout) context = args = null;
    };

    var throttled = function () {
      var now = new Date().getTime();
      if (!previous && options.leading === false) previous = now;
      var remaining = wait - (now - previous);
      context = this;
      args = arguments;
      if (remaining <= 0 || remaining > wait) {
        if (timeout) {
          clearTimeout(timeout);
          timeout = null;
        }
        previous = now;
        func.apply(context, args);
        if (!timeout) context = args = null;
      } else if (!timeout && options.trailing !== false) {
        timeout = setTimeout(later, remaining);
      }
    };
    return throttled;
  }

Date.prototype.formate = function (format) {
    var o = {
        "M+": this.getMonth() + 1, // month
        "d+": this.getDate(), // day
        "h+": this.getHours(), // hour
        "m+": this.getMinutes(), // minute
        "s+": this.getSeconds(), // second
        "q+": Math.floor((this.getMonth() + 3) / 3), // quarter
        "S": this.getMilliseconds()
        // millisecond
    }

    if (/(y+)/.test(format)) {
        format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    }

    for (var k in o) {
        if (new RegExp("(" + k + ")").test(format)) {
            format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
        }
    }
    return format;
}

function openPopPage(pageName) {
    var s = window.getComputedStyle($('#page_0')[0], null);
    //var w = parseInt(s.width);
    //var h = parseInt(s.height);
    appcan.frame.open(pageName, "../common_page/" + pageName + ".html", 0);

}

function open2PopPage(pageName) {
    var s = window.getComputedStyle($('#page_0')[0], null);
    //var w = parseInt(s.width);
    //var h = parseInt(s.height);
    appcan.frame.open(pageName, "../../common_page/" + pageName + ".html", 0);

}

function addLoadEvent(func) {
    var oldonload = window.onload;
    if (typeof window.onload != 'function') {
        window.onload = func;
    } else {
        window.onload = function () {
            oldonload();
            func();
        };
    }
}

function isIncluded(element, array) {
    for (var i = 0,
            len = array.length; i < len; i++) {
        if (array[i] == element) {
            return true;
        }
    }
    return false;
}

//price = fmoney(price,2);
function fmoney(s, n) {
    //s:传入的float数字 ，n:希望返回小数点几位
    var n = n > 0 && n <= 20 ? n : 2,
        s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "",
        l = s.split(".")[0].split("").reverse(),
        r = s.split(".")[1],
        t = "";
    for (i = 0; i < l.length; i++) {
        t += l[i] + ((i + 1) % 3 == 0 && i + 1 != l.length ? "," : "");
    }
    return t.split("").reverse().join("") + "." + r;
}

function rmoney(s) {
    return parseFloat(s.replace(/[^\d\.-]/g, ""));
}
// 四舍五入 格式化数字
// toFix(8440.55,1) => 8440.6
function toFixed(number, fractionDigits) {
    var times = Math.pow(10, fractionDigits);
    var roundNum = Math.round(number * times) / times;
    return roundNum.toFixed(fractionDigits);
}


function timestamp(url) {
    //  var getTimestamp=Math.random();
    var getTimestamp = new Date().getTime();
    if (url.indexOf("?") > -1) {
        url = url + "&timestamp=" + getTimestamp;
    } else {
        url = url + "?timestamp=" + getTimestamp;
    }
    return url;
}

/**
 *
 * @desc   对象序列化
 * @param  {Object} obj
 * @return {String}
 */
function stringfyQueryString(obj) {
    if (!obj) {
        throw new Error("必须传入object类型的值调用");
    }

    var pairs = [];

    for (var key in obj) {
        var value = obj[key];

        if (value instanceof Array) {
            for (var i = 0; i < value.length; ++i) {
                pairs.push(encodeURIComponent(key + "[" + i + "]") + "=" + encodeURIComponent(value[i]));
            }

            continue;
        }
        pairs.push(encodeURIComponent(key) + "=" + encodeURIComponent(obj[key]));
    }

    return pairs.join("&");
}

function nodata(id, text) {
    var ele = document.getElementById(id);
    ele.innerHTML = '';
    var listhtml = "<div id='nodata' class='ub ub-pc' style='margin: 0.8em 0;'>" + "<span class='mf-size2 nodata'>" + text + "</span></div>";
    ele.innerHTML = listhtml;
}

function ListenEnter(func) {
    document.onkeydown = function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];
        if (e && e.keyCode == 13) { // enter 键

            func();
        }
    };

}

// 根据num选择当前时间之前或之后,默认选择当天，支持区间（-15,15）
function getDate(num) {
    var dt = new Date();
    var getMonthDays = function (year, month) {
        var d = new Date(year, month, 0);
        return d.getDate();
    };
    var year = dt.getFullYear();
    var month = dt.getMonth() + 1;
    var prevMonth = month - 1 || 12;
    var day = dt.getDate();

    var thisMonthDays = getMonthDays(year, month);
    var prevMonthDays = getMonthDays(year, prevMonth);
    if (day + num > 0) {
        day = day + num;
    } else if (day + num > thisMonthDays) {
        day = day + num - thisMonthDays;
        month++;
    } else if (day + num <= 0) {
        month--;
        day = prevMonthDays + day + num;
    }

    var date = [
        [year, month, day].join('-'), [dt.getHours(), dt.getMinutes(), dt.getSeconds()].join(
            ':')
    ].join(' ').replace(/(?=\b\d\b)/g, '0');
    // 正则补零 (略微改动)
    return date;
}



function tap(ele, touchFn) {

    var SupportsTouches = ("createTouch" in document), //判断是否支持触摸
        StartEvent = SupportsTouches ? "touchstart" : "mousedown", //支持触摸式使用相应的事件替代
        EndEvent = SupportsTouches ? "touchend" : "mouseup";

    var startTime = null,
        endTime = null;
    ele.addEventListener(StartEvent, function (e) {

        startTime = e.timeStamp;

    })
    ele.addEventListener(EndEvent, function (e) {
        var context = this;

        endTime = e.timeStamp;
        // console.log(EndEvent+'间距='+(endTime-startTime))
        if (endTime - startTime < 500) {
            console.dir('context' + context)
            touchFn();
        }

    })
}

function setStyle(e, a) {
    var i;
    for (i in a) {
        e.style[i] = a[i]
    }
}

function show(element) {
    setStyle(element, {
        "display": ""
    });
}

function hide(element) {
    setStyle(element, {
        "display": "none"
    });
}


function changeIcon(index) {
    var home = document.getElementsByClassName('iconhome_act')[0],
        server = document.getElementsByClassName('iconservice')[0],
        user = document.getElementsByClassName('iconuser')[0];

    switch (index) {
        case 0:

            setStyle(home, {
                backgroundImage: "url('index/myImg/t_icon_home_active.png')"
            })
            setStyle(user, {
                backgroundImage: "url('index/myImg/t_icon_user.png')"
            });
            // setStyle(server, {
            // backgroundImage : "url('index/myImg/t_icon_service.png')"
            // });

            break;

        case 1:
            setStyle(home, {
                backgroundImage: "url('index/myImg/t_icon_home.png')"
            })
            setStyle(user, {
                backgroundImage: "url('index/myImg/t_icon_user_active.png')"
            });
            // setStyle(server, {
            // backgroundImage : "url('index/myImg/t_icon_service.png')"
            // });

            break;

    }

}

// case 1:
// setStyle(home, {
// backgroundImage : "url('index/myImg/t_icon_home.png')"
// })
// setStyle(user, {
// backgroundImage : "url('index/myImg/t_icon_user.png')"
// });
// setStyle(server, {
// backgroundImage : "url('index/myImg/t_icon_service_active.png')"
// });
//
// break;

function addEvent(a, b, c, d) {
    a.addEventListener ? a.addEventListener(b, c, d) : a.attachEvent("on" + b, c)
}

// 获取对应月份的天数
function mGetDate(year, month) {
    var d = new Date(year, month, 0);
    return d.getDate();
}

//打开页面时加载本地存储的用户信息
function useInfoLoad() {
    var username = appcan.locStorage.getVal("username");
    var password = appcan.locStorage.getVal("password");
    if (username != null && password != null) {
        document.getElementById("username").value = username;
        document.getElementById("password").value = password;
    } else {
        document.getElementById("username").value = null;
        document.getElementById("password").value = null;
    }
}

function getStyle(ele, attr) {
    if (ele.currentStyle !== undefined) {
        return ele.currentStyle[attr];
    } else {
        return window.getComputedStyle(ele, null)[attr] ? window.getComputedStyle(ele, null)[attr] : ele.getAttribute(attr);
    }
}

function openBrower(url) {
    var value = uexWidgetOne.platformName;
    alert('浏览器类型为 ' + value)

    if (value == "android") {
        uexWidget.startApp("1", "android.intent.action.VIEW", '{"data":{"mimeType":"text/html","scheme":url}}');
    } else {
        uexWidget.loadApp(url, null, null);
    }
}

// 需要点击事件才可获取
function getAppVersion() {
    uexWidgetOne.getCurrentWidgetInfo();
    uexWidgetOne.cbGetCurrentWidgetInfo = function (opId, dataType, data) {
        var info = JSON.parse(data);
        // alert(JSON.stringify(info))
        var softVer = info.version;
        // alert('版本号为' + softVer)
        appcan.locStorage.setVal('AppVersion', softVer);
    }
}

function openToast(text) {
    var val = text || "加载中...";
    appcan.window.openToast(val, '0', '5', '1');
    appcan.initBounce();
}

function closeToast() {
    appcan.window.closeToast();
}

String.prototype.trim = function () {
    return this.replace(/(^\s*)|(\s*$)/g, "");
}
var CURRENT_PAGE = 1;
var CURRENT_DATA = null;
var SHENGYU_DATA = null;
var DATA = null;

var loadMore = {
    init: function (options) {
        var y = this;
        var defaultOptions = {
            limit: 10,
            CURRENT_PAGE: 1,
            MAX_PAGE: null
        }
        y.options = _extend(defaultOptions, options);
        if (y.checkOptions()) {
            y.checkOptions().appendById(y.options.ele).bind();
            var splitNum = y.options.limit;
            DATA = y.options.data;
            SHENGYU_DATA = DATA.slice(splitNum);
        }

    },
    checkOptions: function () {
        if (!this.options.hasOwnProperty("ele") || !document.getElementById(this.options.ele)) {
            throw new Error("ele必须为getElementById可获取的dom元素,用于存放loadmore组件");
        }
        if (!this.options.hasOwnProperty('data') || !this.options.data.length || !Array.isArray(this.options.data)) {
            throw new Error('传入的分页数据不是数组格式');
        }
        if (!this.options.hasOwnProperty('totalNum') || typeof this.options.totalNum != 'number') {
            throw new Error('分页器的总页数必须指定,且为Number类型');
        }
        if (!this.options.hasOwnProperty('clickFn') || typeof this.options.clickFn != 'function') {
            throw new Error('请为分页器指定点击回调函数');
        }
        MAX_PAGE = Math.ceil(this.options.totalNum / Number(this.options.limit));
        this.options.MAX_PAGE = MAX_PAGE;

        if (CURRENT_PAGE === MAX_PAGE) {
            console.log('分页器完成工作任务，消失...');
            return null;
        }
        return this;
    },
    makeBtnLayout: function () {
        var box = document.createElement("div");
        box.id = "loadMore";
        box.className = "text-center";
        box.innerHTML = '<ul class="pager">' + '<li id="btn-load-more" class="">' + '<a href="javascript:;">点击载入更多</a></li>' + '<li id="btn-loading" class="hidden">' + '<a href="javascript:;">' + '<i class="fa fa-spinner fa-spin" aria-hidden="true"></i> 载入中</a> </li>' + '</ul>';

        return box;
    },
    appendById: function (id) {
        var y = this;
        var box = y.makeBtnLayout();
        document.getElementById(id).appendChild(box);
        return y;
    },
    bind: function () {
        var y = this;
        var loadMore = document.getElementById("btn-load-more");
        var loading = document.getElementById("btn-loading");

        loadMore.onclick = function () {

            this.classList.add("hidden");
            loading.classList.remove("hidden");
            CURRENT_PAGE++;

            console.log('CURRENT_PAGE :' + CURRENT_PAGE)

            if (!y.options.frontendPager) {
                y.options.clickFn.call(null, CURRENT_PAGE, y.options.MAX_PAGE, y.options.totalNum)

            } else {
                // 前端分页

                if (SHENGYU_DATA.length > 0 && CURRENT_PAGE - 1 < MAX_PAGE) {

                    CURRENT_DATA = SHENGYU_DATA.splice(0, y.options.limit);
                    y.options.clickFn.call(null, CURRENT_PAGE, CURRENT_DATA, y.options.MAX_PAGE, y.options.totalNum)

                    if (CURRENT_PAGE === MAX_PAGE) {
                        document.getElementById('loadMore').remove();
                        console.log('分页完毕');
                        return;
                    }
                    y.loadingGoOn();

                }
            }
        }
    },
    loadingGoOn: function () {
        var loading = document.getElementById("btn-loading");
        var loadMore = document.getElementById("btn-load-more");
        setTimeout(function () {
            loading.classList.add("hidden");
            loadMore.classList.remove("hidden");
        }, 1000);
    }
}