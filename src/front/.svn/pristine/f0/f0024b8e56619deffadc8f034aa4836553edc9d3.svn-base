<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
         <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../../build/css/ui-box.css">
        <link rel="stylesheet" href="../../build/css/ui-base.css">
        <link rel="stylesheet" href="../../build/css/ui-color.css">
        <link rel="stylesheet" href="../../build/css/appcan.icon.css">
        <link rel="stylesheet" href="../../build/css/appcan.control.css">
        <link rel="stylesheet" href="css/intentionList.css">
        <style type="text/css">
            ::-webkit-scrollbar {
                width: 0px;
            }
            ::-webkit-scrollbar {
                display: none;/*隐藏滚轮*/
            }

        </style>
    </head>
    <body class="um-vp bc-bg" ontouchstart>
        <div id="" class="listbox">
            <div id="listdetail" class="detail bc-border"></div>
        </div>
        <div style="height:3em"></div>

        <!--footer-->
        <div id="footer" class="ub ubt bc-border uf tab-foot uhide">
            <div id="" class="ub uw-a">
                <div id="" class="ub ub-pc uw-1">
                    <div id="" class="umar-l">
                        <div class="m-check" name="" id="checkall"></div>
                    </div>
                    <div id="" class="umar-l">
                        全选
                    </div>
                </div>
                <div id="" class="uw-2 ub ub-pe"></div>
                <div class="uw-3 ub ub-ac ub-pc sec-btn1" onclick="deleteOrder()">
                    删除
                </div>
            </div>
        </div>

        <script src="../../build/js/appcan.js"></script>
        <script src="../../build/js/appcan.control.js"></script>
        <script src="../../common/comm.js"></script>
        <script src="../../common/jquery.min.js"></script>
    </body>
    <script>
        var listdata = [];
       
        appcan.ready(function() {
           
                 appcan.window.subscribe("cancelYXD", function(test) {

                if (test == "true") {
                    //window.location.reload();
                    reload();
                }
            })
            
            uexWindow.setWindowScrollbarVisible('false');
            getOrderCancel();

        }); (function() {
            var deleteStr = appcan.locStorage.getVal('deleteOrder');
            if (deleteStr) {
                reload();
            }
        })
        function reload() {
            $("#listdetail").html("");
            getOrderCancel();
        }

        function getOrderCancel() {
            var url = URL + "/app/bill/getOrder";
            var paramJsonStr = "state=4";
            var func = getOrderToFYCallBack;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
        }

        function getOrderToFYCallBack(data) {
            if ( typeof data == "string") {
                data = eval("(" + data + ")");
            }
            var orderList = data.list;
            listdata = orderList;
            var listHtml = "";
            if (orderList.length == 0) {
                var listhtml = "<div id='nodata' class='ub ub-pc' style='margin: 0.8em 0;'>" + "<span class='mf-size2 nodata'>您没有符合条件的订单!</span>" + "</div>";
                $("#fuyou").html("");
                $("#listdetail").append(listhtml);

                return;
            } else {
                $("#footer")[0].className = "ub ubt bc-border uf tab-foot";
                for (var i = 0; i < orderList.length; i++) {
                    var orderId = orderList[i].orderId;
                    var orderCode = orderList[i].orderCode;
                    var sumprice = 0.00;

                    var huodongName ="";
                   

                    var evaluateState = "<div id='judge" + i + "' class='y-font'  onclick=\"reInsertOrder('" + orderId + "')\">重新提交</div>";
                    listHtml += "<div id='list" + i + "' class='list-content white-bg'><div id='orderInfo" + i + "' class='ub ub-ac ub-pj umar-l umar-r m-row'><div id='checkdiv" + i + "' class='c-width ub ub-ac umar-l' onclick='cellbtnClick(id)'><div id='check" + i + "' class='m-check'></div><span class='umar-l'>选择</span></div><div class='y-font ub-f1'>" + huodongName + "</div>" + evaluateState + "</div><div id='orderlist'>";

                    var intentionList = orderList[i].orderSub;
                    for (var j = 0; j < intentionList.length; j++) {
                        var oilinfoId = intentionList[j].oilinfoId;
                        var oilinfoName = intentionList[j].oilinfoName;
                        var extractType = intentionList[j].extractType;
                        var oilAmot = intentionList[j].oilAmot;
                        var oilNumber = intentionList[j].oilNumber;
                        var oilPrice = intentionList[j].oilPrice;
                        sumprice += oilAmot;
                        var delivery = "配送";
                        if (extractType == '0') {
                            delivery = "配送";
                        } else {
                            delivery = "自提";
                        }

                        listHtml += "<div id='' class='ub ub-ac umar-a m-row3'><div id='' class='ub ub-ac t-col1'>" + oilinfoName + "</div><div id='' class='ub ub-ac ub-pc t-col2'><span class='umar-r mf-color umar-r'><span class='mf-size2'>￥</span>" + oilPrice + "<span class='gray-font mf-size2'>/吨</span></span><span class='umar-l'>x" + oilNumber + "</span></div><div id='type' class='ub ub-ac  ub-pc t-col4'><span class='s-state delivery'>" + delivery + "</span></div></div>";
                    }
                    var payType ="无";
                   
                    var remark = orderList[i].remark;
                    if ( typeof (remark) == "undefined") {
                        remark = "";
                    }
                    listHtml += "<div id='pay' class='ub ub-ac umar-l umar-r m-row3'><div id='' class='col-left'><span class='gray-font'>支付方式&nbsp;&nbsp;</span><span>" + payType + "</span></div><div id='total' class='col-right'><span class='gray-font'>合计&nbsp;&nbsp;</span><span class='mf-color'>" + "￥" + sumprice + "</span></div></div><div class='ub ub-ac umar-l umar-r m-row3'><span class='gray-font'> 备注信息&nbsp;&nbsp;</span><span id='remark" + orderList[i]["orderId"] + "'>" + remark + "</span></div>" + "<div class='ub ub-ac umar-l umar-r m-row3'><span class='gray-font'>取消理由&nbsp;&nbsp;</span><span id='cancelReason" + orderList[i]["orderId"] + "'>" + remark + "</span></div></div>";

                    if (i < orderList.length - 1) {
                        listHtml += "<div class='gap'></div></div>";
                    } else {
                        listHtml += "</div>";
                    }
                }
            }

            $("#listdetail").css("opacity", "0");
            //这句加在append前
            $("#listdetail").append(listHtml);
            $("#listdetail").animate({
                opacity : 1
            }, 500);
            //这句的作用是使DIV缓慢显示
        }

        var yesNo = 0;
        //全选
        appcan.button("#checkall", "ani-act", function() {
            if ($("#checkall")[0].className == "m-check") {
                $("#checkall")[0].className = "m-check m-check-active";
                for (var i = 0; i < listdata.length; i++) {
                    if ($("#check" + i)[0]) {
                        $("#check" + i)[0].className = "m-check m-check-active";
                    }
                    if ($("#price"+i)[0]) {
                        var p = $("#price"+i)[0].innerHTML.substring(1, $("#price"+i)[0].innerHTML.length);
                    }
                }
            } else {
                $("#checkall")[0].className = "m-check";
                for (var i = 0; i < listdata.length; i++) {
                    if ($("#check" + i)[0]) {
                        $("#check" + i)[0].className = "m-check";
                    }
                }
            }
            yesNo = 0;
        })
        //列表中单选
        function cellbtnClick(id) {
            var index = id.substring(id.length - 1, id.length);
            if ($("#check"+index)[0].className == "m-check") {
                $("#check"+index)[0].className = "m-check m-check-active";
                yesNo++;
            } else {
                $("#check"+index)[0].className = "m-check";
                yesNo--;
            }
            if (yesNo == listdata.length) {
                $("#checkall")[0].className = "m-check m-check-active";
            } else {
                $("#checkall")[0].className = "m-check";
            }
        }

        //重新提交
        function reInsertOrder(orderId) {
            var url = URL + "/app/bill/insertReOrder";
            var paramJsonStr = "orderId=" + orderId;
            var func = insertReOrderCallBack;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
        }

        function insertReOrderCallBack(data) {
            if (data == "ok") {
                appcan.window.openToast({
                    msg : '订单重新提交成功',
                    duration : 1000,
                    position : 5,
                    type : 0
                });
                // window.location.reload();
                reload();
            }
        }

        var ids = [];
        function deleteOrder() {
            var delList = [];
            for (var i = 0; i < listdata.length; i++) {
                if ($("#check" + i)[0] && $("#check"+i)[0].className == "m-check m-check-active") {
                    delList.push(listdata[i].orderId);
                    ids.push(i);
                }
            }
            var idstr = delList.join(',');
            //将数组元素连接起来以构建一个字符串

            var url = URL + "/app/bill/deleteOrder";
            var paramJsonStr = "orderId=" + idstr;
            var func = deleteOrderCallBack;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
        }

        function deleteOrderCallBack(data) {
            if (data == "ok") {
                //window.location.reload();
                //reload();

                for (var i = 0; i < ids.length; i++) {
                    $("#list" + ids[i]).slideUp(500, function() {
                        $("#list" + ids[i]).remove();
                    });

                }

                ids = [];

            } else {

            }
        }
    </script>
</html>