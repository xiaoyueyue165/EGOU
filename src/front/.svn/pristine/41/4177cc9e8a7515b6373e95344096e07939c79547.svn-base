<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../build/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../build/css/ui-box.css">
        <link rel="stylesheet" href="../build/css/ui-base.css">
        <link rel="stylesheet" href="../build/css/ui-color.css">
        <link rel="stylesheet" href="../build/css/appcan.icon.css">
        <link rel="stylesheet" href="../build/css/appcan.control.css">
        <link rel="stylesheet" href="css/infomgmt.css">
        <link rel="stylesheet" href="css/delivery.css">
        <script src="../common/comm.js"></script>
    </head>
    <body class="um-vp bc-bg" ontouchstart>
        <div class="user-info">
            <div class="ub ub-ver white-bg mf-size1 b-border" id="vehicleInfo"></div>
            <div class="white-bg  ub ub-ac b-border">
                <div  class="m-row2 gray-font label-width">
                    提油司机
                </div>
                <div class="ub ub-pe ub-f1">
                    <div id="driverlist" class="info-list"></div>
                </div>
            </div>

            <div class="white-bg  ub ub-ac b-border">
                <div  class="m-row2 gray-font label-width">
                    押运员
                </div>
                <div class="ub ub-pe ub-f1">
                    <div id="yayunlist" class="info-list"></div>
                </div>
            </div>

            <div class="umar-a margin-t-l">
                <div class="btn ub ub-ac bc-text-head ub-pc bc-btn mp-btn"  id="btn-save-vehicle">
                    提&nbsp; &nbsp;交
                </div>
            </div>
        </div>
        <script src="../build/js/appcan.js"></script>
        <script src="../build/js/appcan.control.js"></script>
        <script type="text/javascript" charset="utf-8" src="../build/js/appcan.listview.js"></script>
    </body>
    <script>
        var driverId = "";

        var yayunId = "1"
        var vehicleTypeName = "请选择"
        var vehicleTypeId = 0;
        var vehicleId = "";
        var vehicleInfo = "";
        var ifModify = false;

        var driverList = [];
        //押运
        var supercargoList = [];
        appcan.ready(function() {
            vehicleId = appcan.locStorage.getVal("vehicleId");
            vehicleInfo = appcan.locStorage.getVal("vehicleInfo");
            appcan.locStorage.remove("vehicleId");
            appcan.locStorage.remove("vehicleInfo");
            initVehicleInfo();
            queryCusDriver();
            queryCusYayun();

            appcan.window.subscribe('vehicleType', function(type) {
                vehicleType = type.split("@")[0];
                vehicleTypeId = type.split("@")[1];
                setListView(vehicleType);
            })
            //司机
            appcan.window.subscribe("driverParam", function(driverParam) {
                driverParam = eval("(" + driverParam + ")");
                driverId = driverParam.id;
                lv_driverlist.set([{
                    title : driverParam.title,
                }]);
            });
            //押运员
            appcan.window.subscribe("yayunParam", function(yayunParam) {
                // alert(yayunParam);
                yayunParam = JSON.parse(yayunParam);
                yayunId = yayunParam.id;
                lv_yayunlist.set([{
                    title : yayunParam.title,
                }]);
            });
        });

        function initVehicleInfo() {
            var vehicleName = "";
            var vehicleCode = "";
            var vehicleLoad = "";
            var vehicleTypeName = "";
            if (vehicleId == "" || vehicleId == null) {
                ifModify = false;
            } else {
                ifModify = true;
                if ( typeof vehicleInfo == "string") {
                    vehicleInfo = JSON.parse(vehicleInfo);
                }
                vehicleName = vehicleInfo.vehicleName;
                vehicleTypeName = vehicleInfo.vehicleTypeName;
                vehicleCode = vehicleInfo.vehicleCode;
                vehicleLoad = vehicleInfo.vehicleLoad;
                vehicleTypeId = vehicleInfo.vehicleTypeId;
            }
            var type = '<div class="ub m-row umar-l umar-r"><div class="ub ub-ac l-width"><span class="gray-font">车船类型</span>' + '</div><div class="ub ub-ac ub-f1"><div class="uinput ub ub-f1">' + '<select class="mySelect ub-f1" style="font-size:1.1em"><option>车辆</option><option>船舶</option></select>' + '</div></div></div>';
            var codeString = '<div class="ub m-row umar-l umar-r"><div class="ub ub-ac l-width"><span class="gray-font">车牌号</span>' + '</div><div class="ub ub-ac ub-f1"><div class="uinput ub ub-f1">' + '<input placeholder="" type="text" class="ub-f1" value="' + vehicleCode + '"></div></div></div>';
            var loadString = '<div class="ub m-row umar-l umar-r no-border-b">' + '<div class="ub ub-ac l-width"><span class="gray-font">载重（吨）</span>' + '</div><div class="ub ub-ac ub-f1">' + '<div class="uinput ub ub-f1"><input placeholder="" type="number" class="ub-f1" value="' + vehicleLoad + '"></div></div></div>';
            $("#vehicleInfo").append(type + codeString + loadString);
            // setListView(vehicleTypeName);
        }


        appcan.button("#btn-save-vehicle", "act-ani", function() {
            vehicleCode = $("input")[0].value;
            vehicleLoad = $("input")[1].value;
            var reg = /^[\u4e00-\u9fa5]{1}[A-Z]+\-{1}[A-Z_0-9]{5}$/;
            if (vehicleCode != "" && !reg.test(vehicleCode)) {
                uexWindow.alert("提示", "车牌不符合规范！示例：沪A-F1234", "确定");
                return;
            }
            if (vehicleLoad == "") {
                uexWindow.alert("提示", "请填写车辆载重", "确定");
                return;
            }
            var url = "";
            var paramJsonStr = "";
            // alert(driverId + '' + yayunId)
            if (ifModify) {//编辑
                url = URL + "/app/cus/vehicle/updateCusVehicle";
                paramJsonStr = "vehicleId=" + vehicleId + "&vehicleCode=" + vehicleCode + "&vehicleLoad=" + vehicleLoad;
            } else {//新增
                url = URL + "/app/cus/vehicle/addCusVehicle";
                paramJsonStr = "&vehicleCode=" + vehicleCode + "&vehicleLoad=" + vehicleLoad + "&driverId=" + driverId + "&suppercargoId=" + yayunId;

            }
            var func = updateVehCallback;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('正在提交数据...', '0', '5', '1');
        })
        function updateVehCallback(data) {
            appcan.window.closeToast();
            if (data == "0") {
                uexWindow.evaluateScript("vehicleAdd", 0, "addVehicleSuccess()");
            } else {
                appcan.window.alert({
                    title : '提示',
                    content : "保存失败，请重试！",
                    buttons : '确定'
                });
            }
        }

        //获取司机
        function queryCusDriver() {
            var url = URL + "/cus/driver/queryCusDriver",
                paramJsonStr = "pager.pageNo=1&pager.pageSize=10",

                func =
                queryCusDrivercallback,
                dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('正在提交数据...', '0', '5', '1');
        }

        function queryCusDrivercallback(data) {
            appcan.window.closeToast();
            var data = JSON.parse(data);

            driverList = data.rows;
        }

        //获取押运员
        function queryCusYayun() {

            var url = URL + "/cus/driver/queryCusDriver",
                paramJsonStr = "pager.pageNo=1&pager.pageSize=5&temp=0",

                func =
                queryCusYayuncallback,
                dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('正在提交数据...', '0', '5', '1');
        }

        function queryCusYayuncallback(data) {
            appcan.window.closeToast();
            var data = JSON.parse(data);
            supercargoList = data.rows;
        }

        var lv_carlist = appcan.listview({
            selector : "#carlist",
            type : "thinLine",
            hasAngle : true
        });
        lv_carlist.set([{
            title : "请选择",
        }])
        lv_carlist.on("click", function(ele, obj, curEle) {
            appcan.locStorage.setVal("carList", carList);
            appcan.window.open("carlist", "../mentionOil/carlist.html", 10);
        })
        var lv_driverlist = appcan.listview({
            selector : "#driverlist",
            type : "thinLine",
            hasAngle : true
        });
        lv_driverlist.set([{
            title : "请选择",
        }])
        lv_driverlist.on("click", function(ele, obj, curEle) {
            appcan.locStorage.setVal("driverList", driverList);
            appcan.window.open("driverlist", "../mentionOil/driverlist.html", 10);
        })
        //押运员
        var lv_yayunlist = appcan.listview({
            selector : "#yayunlist",
            type : "thinLine",
            hasAngle : true
        });
        lv_yayunlist.set([{
            title : "请选择",
        }])
        lv_yayunlist.on("click", function(ele, obj, curEle) {
            appcan.locStorage.setVal("yayunlist", supercargoList);
            appcan.window.open("supercargoList", "../mentionOil/yayun.html", 10);
        })
    </script>
</html>
