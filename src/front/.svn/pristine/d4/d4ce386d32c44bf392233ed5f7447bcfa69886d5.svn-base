<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../../build/css/ui-box.css">
        <link rel="stylesheet" href="../../build/css/ui-base.css">
        <link rel="stylesheet" href="../../build/css/ui-color.css">
        <link rel="stylesheet" href="../../build/css/appcan.icon.css">
        <link rel="stylesheet" href="../../build/css/appcan.control.css">
        <link rel="stylesheet" href="css/intentionList.css">
        <style type="text/css">
            table {
                width: 100%;
            }
            tr {
                width: 100%;
            }
            td {
                width: 50%;
                padding: 0.4em;
                text-align: center;
            }
            table td:last-child {
                text-align: left;
            }
            .layui-m-layerchild {
                padding: 0.4em;
            }
            .chuku {
                position: absolute;
                left: 5.2em;
                top: 0;
                line-height: 1.8em;
            }
            .um3 {
                margin-left: 3em;
            }

        </style>
    </head>
    <body class="um-vp bc-bg" ontouchstart>
        <div id="carlist" class="listbox">
            <div id="listdetail" class="detail bc-border white-bg"></div>
        </div>
        <div style="height:3em"></div>

        <!--footer-->
        <div id="footer" class="ub ubt bc-border uf tab-foot">
            <div id="" class="ub uw-a">
                <div id="" class="ub ub-pc ub-ac uw-1">
                    <div id="" class="umar-l">
                        <div class="m-check" name="" id="checkall"></div>
                    </div>
                    <div id="" class="umar-l">
                        <span class="mf-size2">全选</span>
                    </div>
                </div>

                <div id="sum_price" class="uw-2 ub ub-pe area-price">
                    <span class="umar-r"><span class="mf-size2 gray-font">合计：</span><span class="mf-color">￥<span id="heji"></span></span></span>
                </div>

                <div id="confirmYXD" class="uw-3 ub ub-ac ub-pc sec-btn1">
                    提交订单
                </div>
            </div>
        </div>

        <script type="text/html" charset="utf-8" id="orderList">
            {{each list}}
            <div id="detailbox{{$index}}" class="detailbox ubb bc-border">
            <div id="intentionIds{{$index}}" style="display:none"></div>
            <div id="intentionId{{$index}}" style="display:none">{{$value.intentionId}}</div>
            <div id="oilinfoId{{$index}}" style="display:none">{{$value.oilinfoId}} </div>
            <div id="oilinfoName{{$index}}" style="display:none">{{$value.oilinfoName}}</div>
            <div id="ykdd{{$index}}" style="display:none">{{$value.ykdd}}</div>
            <div id="ysfs{{$index}}" style="display:none">{{$value.ysfs}}</div>
            <div id="chukuliang{{$index}}" style="display:none">{{$value.chukuliang}}</div>
            <div id="gyfgs{{$index}}" style="display:none">{{$value.gyfgs}}</div>
            <div id="pickupDiscount{{$index}}" style="display:none">{{$value.pickupDiscount}}</div>
            <div id="check{{$index}}" class="bw0 ub ub-ac " onclick="cellbtnClick(id)"><div id={{$index}} class="m-check"></div></div>
            <div id="name{{$index}}" class="bw1 ub ub-ver"><div class="umar-a oil-name">{{$value.oilinfoName}}</div>
            <div class="umar-b"><span class="mf-color mf-size-s">￥</span> <span class="mf-color mf-size1" id="oilPrices{{$index}}"> {{$value.oilPrice}}</span><span class="mf-color2 mf-size-s">/吨</span> <span class="umar-l m-border1" id="pz{{$index}}">{{$value.transType}}</span></div></div>
            <div id="account{{$index}}" class="bw2 ub ub-ac ub-pc amount" >x{{$value.oilNumber}}</div>
            <div id="priceA{{$index}}" class="ub ub-ac bw3 ub-pc mf-color" onclick="showOrderDetail(id)">{{$value.oilAmot}}</div>
            </div>
            {{/each}}

        </script>

        <script src="../../build/js/appcan.js"></script>
        <script src="../../build/js/appcan.control.js"></script>
        <script src="../../build/js/appcan.tab.js"></script>
        <script src="../../build/js/appcan.listview.js"></script>
        <script type="text/javascript" src="../../common/comm.js"></script>
        <script src="../../common/jquery.min.js"></script>
        <script src="../../common/layer_mobile/layer.js" type="text/javascript" charset="utf-8"></script>
    </body>
    <script>
        var listData = {},
            sumPrice = 0.00,
            listNum = 0,
            lv_pay,
            remark = "",
            paytype = "账面余额支付",
            depotList = [],
            GYFGS = [];
        appcan.ready(function() {

            uexWindow.setWindowScrollbarVisible('false');

            appcan.window.subscribe("ifEdit", function(editTag) {
                if (editTag == "true") {
                    editIntention();
                } else if (editTag == "false") {
                    finishEditIntention();
                }
            })
            getNewBill();

        })
        function reload() {

            $("#listdetail")[0].innerHTML = "";
            getNewBill();
        }

        // 查询待提交意向单
        function getNewBill() {
            var url = URL + "/app/bill/newGetBill",
                paramJsonStr = "limit=" + limit + "&offset=" + offset,
                func =
                getNewBillCallBack,
                dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('加载中...', '0', '5', '1');
        }

        function getNewBillCallBack(data) {
            appcan.window.closeToast();
            if ( typeof data == "string") {
                data = JSON.parse(data)
            }
            var sum = 0;
            var pojoList = data.pojo;
            listNum = pojoList.length;
            listdata = pojoList;
            if (pojoList.length > 0) {
                for (var i = 0; i < pojoList.length; i++) {
                    var intentionId = pojoList[i].intentionId,
                        oilinfoId = pojoList[i].oilinfoId,
                        oilinfoName = pojoList[i].oilinfoName?pojoList[i].oilinfoName:0,
                        oilPrice = pojoList[i].oilPrice?fmoney(pojoList[i].oilPrice):"",
                         extractType = pojoList[i].extractType?pojoList[i].extractType:0,
                        // extractType = pojoList[i].extractType?pojoList[i].extractType?"",
                        oilNumber = pojoList[i].oilNumber,
                        oilAmot = pojoList[i].oilAmot?fmoney(pojoList[i].oilAmot):0,
                        oilinfoSpec = pojoList[i].oilinfoSpec,

                    //加字段 分公司
                        gyfgs = pojoList[i].gyfgs,
                        ykdd = pojoList[i].ykdd,
                        ysfs = pojoList[i].ysfs,
                        pickupDiscount = pojoList[i].pickupDiscount?pojoList[i].pickupDiscount:0,
                        chukuliang = pojoList[i].chukuliang;



                    sum += oilAmot;

                    if (oilPrice == 0) {
                        oilAmot = '<span id="price' + i + '" class="mf-size1 ">已下架</span>';
                    } else {
                        oilAmot = '<span class="mf-size-s">' + '￥</span><span id="price' + i + '" class="mf-size1 ">' + oilAmot + '</span>';
                    }

                    var transType = "配送";
                    if (extractType == 0) {//配送
                        transType = "配送";
                    } else {
                        transType = "自提";
                    }

                    $("#listdetail")[0].innerHTML += '<div id="detailbox' + i + '" class="detailbox ubb bc-border">' + '<div id="intentionIds' + i + '" style="display:none">' + oilinfoName + '★' + oilNumber + '★' + oilPrice + '★' + extractType + '★' + ysfs + '★' + ykdd + '★' + gyfgs + '★' + chukuliang + '</div>' + '<div id="intentionId' + i + '" style="display:none">' + intentionId + '</div>' + '<div id="oilinfoId' + i + '" style="display:none">' + oilinfoId + '</div>' + '<div id="oilinfoName' + i + '" style="display:none">' + oilinfoName + '</div>' + '<div id="ykdd' + i + '" style="display:none">' + ykdd + '</div>' + '<div id="ysfs' + i + '" style="display:none">' + ysfs + '</div>' + '<div id="chukuliang' + i + '" style="display:none">' + chukuliang + '</div>' + '<div id="gyfgs' + i + '" style="display:none">' + gyfgs + '</div>' + '<div id="pickupDiscount' + i + '" style="display:none">' + pickupDiscount + '</div>' + '<div id="check' + i + '" class="bw0 ub ub-ac " onclick="cellbtnClick(id)"><div id="' + i + '" class="m-check"></div></div>' + '<div id="name' + i + '" class="bw1 ub ub-ver">' + '<div class="umar-a oil-name">' + oilinfoName + '</div>' + '<div class="umar-b"><span class="mf-color mf-size-s">￥</span>' + '<span class="mf-color mf-size1" id="oilPrices' + i + '">' + oilPrice + '</span>' + '<span class="mf-color2 mf-size-s">/吨</span>' + '<span class="umar-l m-border1" id="pz' + i + '">' + transType + '</span>' + '</div>' + '</div>' + '<div id="account' + i + '" class="bw2 ub ub-ac ub-pc amount" >x' + oilNumber + '</div>' + '<div id="priceA' + i + '" class="ub ub-ac bw3 ub-pc mf-color" onclick="showOrderDetail(id)">' + oilAmot + '</div>' + '</div>';
                }
                $("#listdetail")[0].innerHTML += '<div class="gap"></div><div id="paytype" class="pay-type"><div id="listview" class=""></div></div>' + '<div id="remark" class="ub ub-ver umar-t ub-beizhu">' + '<div id="" class="umar-a">备注信息</div><textarea placeholder="可以填写您指定的提油油库或开票时间等要求" name="remark" id="remark" class="m-textarea umar-a" oninput="beizhuChange()" onpropertychange="beizhuChange()"></textarea></div>' + '<div id="" class="umar-a">' + '<div class="ub"><div id="checkRed" class="umar-a oil-name" onclick="checkRed()" ><div id="checkRed2" class="m-check m-check-active"></div></div>' + '<div class="ulev-1" style="margin-bottom: 1em;">&nbsp;&nbsp;&nbsp;&nbsp;我已阅读并同意<span onclick="showPic();" class="red-font"><br>&nbsp;&nbsp;《中国石油上海销售分公司电子购油协议》</span></div></div>';

            } else {
                $("#listdetail")[0].innerHTML = "您还没有选购油品，去看看有没有您需要的油品吧。";

            }
            heji.innerHTML = 0;
        }

        //提交订单
        appcan.button("#confirmYXD", "ani-act", function() {
            if (this.id == "del") {
                return;
            }
            var oillist = [];

            for (var i = 0; i < listNum; i++) {
                //intentionId+'★'+oilinfoId+'★'+oilinfoSpec+'★0★'+oilinfoName+'★'+oilPrice+'★'+oilNumber+'★'+extractType
                if (!$("#detailbox" + i).is(":hidden") && $("#"+i)[0].className == "m-check m-check-active") {
                    var intentionId = $("#intentionId" + i)[0].innerText,
                        oilinfoId = $("#oilinfoId" + i)[0].innerText,
                        oilinfoName = $("#oilinfoName" + i)[0].innerText,
                        oilPrice = rmoney($("#oilPrices" + i)[0].innerText),

                        oilNumber = $("#account" + i)[0].innerText,
                        oilNumbers = oilNumber.substring(1, oilNumber.length),
                        ykdd = $("#ykdd"+i)[0].innerText,
                        ysfs = $("#ysfs"+i)[0].innerText,
                        gyfgs = $("#gyfgs"+i)[0].innerText,
                    // 出库量再此处
                        chukuliang = $("#chukuliang"+i)[0].innerText,

                        peiti = $("#pz"+i)[0].innerHTML,

                        extractType = 0;
                    if (peiti == "自提") {
                        extractType = "1";
                    }

                    var intentionIds = intentionId + '★' + oilinfoId + '★null★0★' + oilinfoName + '★' + oilPrice + '★' + oilNumbers + '★' + gyfgs + '★' + extractType + '★' + ykdd + '★' + ysfs + '★' + chukuliang + '★' + '★0';
                    //alert(intentionIds);

                    oillist.push(intentionIds);
                }
            }

            if (oillist.length == 0) {
                appcan.window.openToast('请选择要提交的意向单', '1000', '5', '0');
                return;
            }

            var oils = oillist.join(',');

            var ptype = appcan.locStorage.getVal("paytype");
            if (ptype == null) {
                ptype = 2;
            }
            if (oillist.length == 0) {
                uexWindow.alert("提示", "您没有需要提交的意向单！", "确定");
                return;
            }

            if ($("#checkRed2")[0].className == "m-check") {
                uexWindow.alert("提示", "请同意协议并勾选！", "确定");
                return;
            }
            var cusId = appcan.locStorage.getVal("cusId"),
                url = URL + "/app/bill/insertOrder",
                paramJsonStr = "cusId=" + cusId + "&oils=" + oils + "&payType=" + ptype + "&remark=" + remark,
                func =
                insertOrderCallBack,
                dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('正在提交订单...', '0', '5', '1');

        })
        function insertOrderCallBack(data) {
            appcan.window.publish("tiaoguo", true)

            appcan.window.closeToast();
            if (data == "ok") {
                appcan.locStorage.remove("fangshi");
                appcan.window.openToast({
                    msg : '您的意向单已提交，客户经理会尽快为您处理!<br>您可以到“我的意向单-处理中”中查看您的意向单。',
                    duration : 1000,
                    position : 5,
                    type : 0
                });

                reload();
            } else {
                uexWindow.alert("提示", "意向单提交失败，请重试！", "确定");
            }
        }

        var yesNo = 0;
        //全选
        appcan.button("#checkall", "ani-act", function() {
            if ($("#checkall")[0].className == "m-check") {

                $("#checkall")[0].className = "m-check m-check-active";

                for (var i = 0; i < listdata.length; i++) {
                    if ($("#" + i)[0]) {
                        $("#" + i)[0].className = "m-check m-check-active";
                    }
                }

            } else {
                $("#checkall")[0].className = "m-check";
                for (var i = 0; i < listdata.length; i++) {
                    if ($("#" + i)[0]) {
                        $("#" + i)[0].className = "m-check";
                    }
                }
            }
            heji();
            yesNo = 0;
        })
        function heji() {
            var sum = 0.00;
            ;

            for (var i = 0; i < listdata.length; i++) {
                if ($("#" + i)[0] && $("#" + i)[0].className == "m-check m-check-active") {
                    if ($("#price"+i)[0]) {
                        var pLast = $("#price"+i)[0].innerHTML;
                        var p = rmoney(pLast);
                        sum += Number(p);
                    }
                }
            }
            var money = fmoney(sum, 2);

            $("#heji").html(money);

        }

        // 查看订单详情

        function showOrderDetail(id) {

            queryOildepot();
            queryCompany();

            var index = id.slice(-1);
            var value = document.getElementById('intentionIds' + index).innerText;
            var order = value.split('★');
            var ysfs = order[4] == 'traffic_type_0' ? '公路' : '水路';
            var pszt = order[3] == 0 ? '配送' : '自提';
            var gyfgs = order[6];
            var ykdd = order[5];

            var chukuliang = order[7];
            if (chukuliang === "是") {
                document.getElementById("chukuliang").checked = true;
            } else {
                document.getElementById("chukuliang").checked = false;
            }
            depotList.map(function(v, index) {

                if (ykdd === v.oildepotId) {
                    document.getElementById('ykdd').innerText = v.depotName;
                }
            })
            for (var i = 0; i < GYFGS.length; i++) {
                if (gyfgs === GYFGS[i].basOrgId) {
                    document.getElementById('gyfgs').innerText = GYFGS[i].orgName;
                    break;
                }
            }

        }

        //油库列表
        function queryOildepot() {
            var url = URL + "/front/oildepot/selectXiaLaOildepot",
                paramJsonStr = "";
            $.ajax({
                type : 'post',
                url : url,
                data : paramJsonStr,
                async : false,
                success : function(data) {
                    if ( typeof data == "string") {
                        depotList = JSON.parse(data)
                    }
                }
            })

        }

        // 所属公司列表(同步查询)
        function queryCompany() {
            var url = URL + "/app/bill/checkCompany",
                sid = appcan.locStorage.getVal("sid");
            paramJsonStr = "sid=" + sid;

            $.ajax({
                type : 'post',
                url : url,
                data : paramJsonStr,
                async : false,
                success : function(data) {

                    if ( typeof data == "string") {
                        GYFGS = JSON.parse(data)
                    }

                }
            })

        }

        //列表中单选
        function cellbtnClick(id) {

            var index = id.substring(id.length - 1, id.length);

            if ($("#"+index)[0].className == "m-check") {
                $("#"+index)[0].className = "m-check m-check-active";
                yesNo++;

            } else {
                $("#"+index)[0].className = "m-check";
                yesNo--;

            }
            heji();
            if (yesNo == listdata.length) {
                $("#checkall")[0].className = "m-check m-check-active";
            } else {
                $("#checkall")[0].className = "m-check";
            }
        }

        //编辑意向单
        function editIntention() {
            for (var i = 0; i < listNum; i++) {
                $("#account" + i)[0].className = "edit-bw2 ub ub-ac ub-pc amount";
                var oldprice = $("#account" + i)[0].innerHTML;
                oldprice = oldprice.substring(1, oldprice.length);
                $("#account" + i)[0].innerHTML = "<input type='number' id='accounts" + i + "' class='m-input' value='" + oldprice + "' style='width:2em'/>";
                $("#priceA" + i)[0].className = "ub ub-pc ub-ac";
                var peisongziti = $("#pz" + i)[0].innerHTML;
                if (peisongziti == "配送") {

                    $("#priceA" + i)[0].innerHTML = "<div class='switch-wrapper m-switch' ><span id='peisong" + i + "' class='s-item focus l-radius'>配送</span><span id='ziti" + i + "' class='s-item nofocus r-radius'>自提</span></div>";

                } else {
                    $("#priceA" + i)[0].innerHTML = "<div class='switch-wrapper m-switch' ><span id='peisong" + i + "' class='s-item nofocus l-radius'>配送</span><span id='ziti" + i + "' class='s-item focus r-radius'>自提</span></div>";
                }

                $("#sum_price")[0].className = "uw-2 umar-r area-price hide";
                $("#priceA" + i).attr("id", "type" + i);

                $("#type" + i).unbind('click');
                $("#type" + i).bind('click', function() {
                    typeBtnClick($(this).attr("id"));
                })
            }
            $("#confirmYXD").attr("id", "del");
            $("#del")[0].innerHTML = "删除";
            $("#del").click(function() {
                deletecell($(this).attr("id"));
            });
        }

        //完成编辑
        function finishEditIntention() {
            var editsum = 0;
            for (var i = 0; i < listNum; i++) {

                $("#account" + i)[0].className = "bw2 ub ub-ac ub-pc amount";
                var number = $("#accounts" + i)[0].value;
                $("#account" + i)[0].innerHTML = "x" + number;

                var ps = rmoney($("#oilPrices" + i)[0].innerHTML);

                $("#type" + i)[0].className = "ub ub-ac ub-pc bw3 mf-color";
                $("#type" + i)[0].innerHTML = "<span class='mf-size-s'>￥</span><span id='price" + i + "' class='mf-size1'>" + fmoney(ps * number) + "</span>";
                $("#sum_price")[0].className = "uw-2 ub ub-pe  umar-r area-price";
                $("#type" + i).attr("id", "priceA" + i);

                if (!$("#detailbox" + i).is(":hidden") && $("#"+i)[0].className == "m-check m-check-active") {
                    editsum += ps * number;
                }
                if ($("#account"+i)[0].innerText.slice(1) < 0.001) {
                    $("#account"+i)[0].innerText = "x1";
                    appcan.window.alert({
                        title : "提示",
                        content : "购油数量最小为0.001吨",
                        buttons : ['确定'],
                        callback : function(err, data, dataType, optId) {

                            console.log(err, data, dataType, optId);
                        }
                    });
                    return;
                }
            }
            $("#del").attr("id", "confirmYXD");
            $("#confirmYXD")[0].innerHTML = "确认清单";
            appcan.locStorage.setVal("sumprice", editsum);

            heji();
        }

        //pszt
        function typeBtnClick(id) {
            //隐藏bug
            var index = id.substring(id.length - 1, id.length);
            if ($("#peisong"+index)[0].className == "s-item focus l-radius") {
                //自提

                $("#peisong"+index)[0].className = "s-item nofocus l-radius";
                $("#ziti"+index)[0].className = "s-item focus r-radius";
                $("#pz"+index)[0].innerHTML = "自提";
                var price_old = rmoney($("#oilPrices"+index)[0].innerHTML);

                var pickupDiscount = rmoney($("#pickupDiscount"+index)[0].innerHTML);
                var LastPrice = fmoney(Number(price_old) - Number(pickupDiscount), 2);
                $("#oilPrices"+index)[0].innerHTML = LastPrice;

            } else if ($("#peisong"+index)[0].className == "s-item nofocus l-radius") {

                $("#peisong"+index)[0].className = "s-item focus l-radius";
                $("#ziti"+index)[0].className = "s-item nofocus r-radius";
                $("#pz"+index)[0].innerHTML = "配送";
                var price_old = $("#oilPrices"+index)[0].innerHTML;
                var pickupDiscount = $("#pickupDiscount"+index)[0].innerHTML;
                var LastPrice = rmoney(price_old) + Number(pickupDiscount);
                $("#oilPrices"+index)[0].innerHTML = fmoney(LastPrice, 2);

            }
        }

        var ids = [];
        //删除该行数据
        function deletecell(id) {
            if (id == "confirmYXD") {
                return;
            }
            var delList = [];
            for (var i = 0; i < listdata.length; i++) {
                if ($("#"+i)[0].className == "m-check m-check-active") {
                    listdata["intentionId"] = $("#intentionId" + i)[0].innerText;
                    delList.push(listdata["intentionId"]);
                    ids.push(i);
                }
            }
            var idstr = delList.join(','),
                url = URL + "/app/bill/newDeleteBill",

                paramJsonStr = "id=" + idstr,

                func =
                newDeleteBillCallBack,

                dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
        }

        function newDeleteBillCallBack(data) {

            if (data == "ok") {
                //window.location.reload();
                //reload();
                for (var i = 0; i < ids.length; i++) {
                    $("#"+ids[i])[0].className = "m-check";
                    $("#detailbox" + ids[i]).slideUp(500, function() {
                        $("#detailbox" + ids[i]).remove();
                    });

                }

                ids = [];
            }
            heji();
            if ($("#listdetail")[0].innerHTML === "您还没有选购油品，去看看有没有您需要的油品吧。") {
                alert('没有数据了')
            }
        }

        function beizhuChange() {
            remark = $("textarea")[0].value;
        }

        //阅读选中
        function checkRed() {

            if ($("#checkRed2")[0].className == "m-check") {
                $("#checkRed2")[0].className = "m-check m-check-active";
            } else {
                $("#checkRed2")[0].className = "m-check";
            }

        }

        //打开协议页面
        function showPic() {
            //uexWindow.alert("提示","打开！","确定");
            appcan.window.open("managerEvaluate", "agreement.html", 10);
        }
    </script>
</html>