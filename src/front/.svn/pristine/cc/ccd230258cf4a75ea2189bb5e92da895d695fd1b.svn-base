<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../../build/css/ui-box.css">
        <link rel="stylesheet" href="../../build/css/ui-base.css">
        <link rel="stylesheet" href="../../build/css/ui-color.css">
        <link rel="stylesheet" href="../../build/css/appcan.icon.css">
        <link rel="stylesheet" href="../../build/css/appcan.control.css">
        <link rel="stylesheet" href="css/intentionList.css">
        <style type="text/css">
            ::-webkit-scrollbar {
                width: 0px;
            }

            ::-webkit-scrollbar {
                display: none;
                /*隐藏滚轮*/
            }
        </style>
    </head>

    <body class="um-vp bc-bg" ontouchstart>
        <div class="tx-c sc-bg-active" id="pullstatus0"></div>
        <div id="" class="listbox">
            <button id="loadMore">加载更多</button>
            <div id="listdetail" class="detail white-bg bc-border">

            </div>
        </div>
        <script src="../../build/js/appcan.js"></script>
        <script src="../../build/js/appcan.control.js"></script>
        <script type="text/javascript" src="../../common/comm.js"></script>
        <script src="../../common/jquery.min.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../common/numeral.min.js"></script>
    </body>
    <script>
        var orderlist = [],
            listdata = [],
            listParam = [],
            delivery,
            info,
            params,
            param,
            ifcheck = false,
            totalNum = 0;
        appcan.ready(function() {

            uexWindow.setWindowScrollbarVisible('false');

           appcan.frame.setBounce(1, function(type) {
                $("#pullstatus").html("");
            }, function(type) {
                $("#pullstatus").html("");
            }, function(type) {
                $("#pullstatus").html("松手了,产生事件了,开始更新数据！");
                // 下拉事件发生
                appcan.frame.resetBounce(1);
                // 当前总条数
                var num = Number(pageNo) * limit;


                $("#pullstatus").html("");
                // alert("totalRows=" + totalRows)

                if (Number(totalRows) <= num) {
                    appcan.window.openToast({
                        msg : '没有更多',
                        duration : 1000,
                        position : 5,
                        type : 0
                    });
                    return;
                }

                newPageNo = Number(pageNo) + 1;

                alert('准备加载第'+pageNo+'页')

               getOrder(newPageNo);
            });

            getOrder();
            appcan.window.subscribe("cancelYXD", function(cancelYXD) {
                if (cancelYXD == "true") {
                    reload();
                    appcan.locStorage.setVal('deleteOrder', 'true');
                    uexWindow.evaluateScript("intention3", 0, "reload()");
                    appcan.window.openToast({
                        msg : '意向单已取消',
                        duration : 1000,
                        position : 5,
                        type : 0
                    });
                }
            })
            appcan.window.subscribe("payPopOrderId", function(orderId) {
                appcan.locStorage.setVal("payorderId", orderId);
                appcan.window.open("intentionPay", "intentionPay.html", 10);
            })
            appcan.window.subscribe("tiaoguo", function(tiaoguo) {

                if (tiaoguo == "true") {
                    //window.location.reload();
                    reload();
                }
            })
        })

        document.getElementById('loadMore').onclick = function(){
          newPageNo = Number(pageNo) + 1;

                alert('准备加载第'+newPageNo+'页')

               getOrder(newPageNo);
        }


        function reload() {

            $("#listdetail").html("");
            getOrder();
        }

        // 0：未审核
        // 3：审核通过
        // 4：审核未通过
        // 5：已撤销

        function getOrder(newPageNo) {
           var pageNo = newPageNo?newPageNo:1;


            var url = URL + "/app/bill/getOrder",
                paramJsonStr = "pageNo=" + pageNo + "&pageSize=" + 15 + "&allState=0,1,2,3",
                func =
                getOrderCallBack,
                dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
        }


        function getOrderCallBack(data) {
            if ( typeof data == "string") {
                data = JSON.parse(data);
            }
            var orderList = data.list;
            totalNum = data.totalRows;
            var listHtml = "";
            if (orderList.length == 0) {
                $("#fuyou").html("");
                nodata('listdetail', '您没有符合条件的订单!')
                return;
            }

            for (var i = 0; i < orderList.length; i++) {
                var stateStr = "",
                    actHtml = "",

                    huodong = orderList[i].onsaleType;

                if (orderList[i].state == 0) {
                    stateStr = "<span class='state state1'>未审核</span>&nbsp;&nbsp;<div class='y-font'>" + ' ' + "</div>";
                    actHtml = "<div id='" + orderList[i]["orderId"] + "&0' class='ub ub-ac ub-pc' onclick='actBtnClick(id)'><span class='y-font'>取消意向单</span></div>"
                } else if (orderList[i].state === 3) {
                    stateStr = "<span class='state state2'>审核通过</span>&nbsp;&nbsp;<div class='y-font'>" + ' ' + "</div>";
                    actHtml = "<div id='" + orderList[i]["orderId"] + "&1' class='ub ub-ac ub-pc' onclick='actBtnClick(id)'><span class='y-font'>付款</span></div>"
                } else if (orderList[i].state === 4) {
                    stateStr = "<span class='state state2'>审核未通过</span>&nbsp;&nbsp;<div class='y-font'>" + ' ' + "</div>";
                    actHtml = "<div id='" + orderList[i]["orderId"] + "&1' class='ub ub-ac ub-pc' onclick='actBtnClick(id)'><span class='y-font'>付款</span></div>"
                } else {
                    stateStr = "<span class='state state3'>已撤销</span>&nbsp;&nbsp;<div class='y-font'>" + ' ' + "</div>";
                    actHtml = "<div id='" + orderList[i]["orderId"] + "' class='ub ub-ac ub-pc'></div>";
                }
                var sumpriceBefore = 0.00;
                listHtml += "<div id='list" + i + "' class='list-content white-bg'><div id='orderInfo" + i + "' class='ub ub-ac ub-pj m-row3'><div id='info" + i + "' class='ub ub-ac'><div id='check" + i + "' class='ub ub-ac'>" + stateStr + "</div></div>" + actHtml + "</div><div id='orderlist" + i + "'>"
                var intentionList = orderList[i].orderSub;
                if (intentionList && intentionList.length && intentionList.length >= 1) {
                    for (var j = 0; j < intentionList.length; j++) {

                        var oilinfoId = intentionList[j].oilinfoId,
                            oilinfoName = intentionList[j].oilinfoName,
                            extractType = intentionList[j].extractType,
                            oilAmot = intentionList[j].oilAmot,
                            oilNumber = intentionList[j].oilNumber,
                            oilPriceBefore = intentionList[j].oilPrice,
                            oilPrice = fmoney(oilPriceBefore, 2),

                        //油库地点，所属公司

                            ykdd = intentionList[j].ykdd,
                            gyfgs = intentionList[j].gyfgs,
                            ysfs = intentionList[j].ysfs,
                            delivery = "公路";
                        sumpriceBefore += oilAmot;

                        if (extractType == '0') {
                            delivery = "公路";
                        } else if (extractType == '1') {
                            delivery = "水路";
                        }
                        listHtml += "<div id='' class='ub ub-ac umar-a m-row3'><div id='' class='ub ub-ac t-col1'>" + oilinfoName + "</div><div id='' class='ub ub-ac ub-pc t-col2'><span class='umar-r mf-color umar-r'><span class='mf-size2'>￥</span>" + oilPrice + "<span class='gray-font mf-size2'>/吨</span></span><span class='umar-l'>x" + oilNumber + "</span></div><div id='type' class='ub ub-ac  ub-pc t-col4'><span class='s-state delivery'>" + ysfs + "</span></div></div>";
                    };
                } else {
                    $("#fuyou").html("");
                    nodata('listdetail', '您没有符合条件的订单!')
                    return;
                }

                var remark = orderList[i].remark;
                if (( typeof (remark) == "undefined")) {
                    remark = "";
                }

                sumprice = fmoney(sumpriceBefore, 2);

                listHtml += "<div id='pay' class='ub ub-ac umar-l umar-r m-row3'><div id='' class='col-left'><span class='gray-font'>运输方式&nbsp;&nbsp;</span><span>" + delivery + "</span></div><div id='total' class='col-right'><span class='gray-font'>合计&nbsp;&nbsp;</span><span class='mf-color'>" + "￥" + sumprice + "</span></div></div>" + "<div id='pay' class='ub ub-ac umar-l umar-r m-row3'><div id='' class='col-left'><span class='gray-font'>油库地点&nbsp;&nbsp;</span><span>" + ykdd + "</span></div><div id='total' class='col-right'><span class='gray-font'>销售单位&nbsp;&nbsp;</span><span class='mf-color'>" + gyfgs + "</span></div></div>" + "<div class='ub ub-pj ub-ac umar-l umar-r m-row4 border-bottom-line'><div class='b-width1 gray-font'> 备注信息&nbsp;&nbsp;</div><div class='b-width2 w-break' id='remark" + orderList[i]["orderId"] + "'>" + remark + "</div></div></div>" + "</div>";

                if (i < orderList.length - 1) {
                    listHtml += "<div class='gap'></div>";
                }
            }

            $("#listdetail").append(listHtml);
        }

        var orderId = "";
        function actBtnClick(id) {

            // alert(id)
            orderId = id.split("&")[0];
            var actType = id.split("&")[1];
            if (actType == 0) {
                //取消意向单

                appcan.locStorage.setVal("cancelReasonID", orderId);
                // alert('回调,调用弹出框');
                uexWindow.evaluateScript("intentionList", 0, "opencancelReason()");

                open2PopPage("cancelReason");

            } else {
                //付款
                oneAlert("本系统暂仅支持线下付款", "确定")
            }
        }

        function onClickItem(dateType) {
            if (dateType == 0) {
                appcan.window.open("intentionPay", "intentionPay.html", 10);
            } else if (dateType == 1) {
                var url = URL + "app/bill/newPayOrder",
                    paramJsonStr = "orderId=" + orderId,
                    func =
                    newPayOrderCallBack,
                    dataType = "text";
                ajaxPostQuery(url, paramJsonStr, func, dataType);
            } else {

            }
        }

        //提交数据回调
        function newPayOrderCallBack(data) {
            if (data == "ok") {
                //alert("ok");
            }
        }
    </script>

</html>