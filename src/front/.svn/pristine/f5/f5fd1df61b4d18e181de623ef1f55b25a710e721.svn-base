<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../../build/css/ui-box.css">
    <link rel="stylesheet" href="../../build/css/ui-base.css">
    <link rel="stylesheet" href="../../build/css/ui-color.css">
    <link rel="stylesheet" href="../../build/css/appcan.icon.css">
    <link rel="stylesheet" href="../../build/css/appcan.control.css">
    <link rel="stylesheet" href="./css/funds.css">
    <link rel="stylesheet" type="text/css" href="../../common/css/yue.css" />
    <script type="text/javascript" src="../../common/comm.js"></script>
</head>

<body class="um-vp bc-bg sc-bg" ontouchstart>
    <div id="content">
        <div class="margin-a content">
            <form action="" id="myFormId" class="judge-form">

                <p class="margin-t-2x">
                    <span class="gongsi">所属公司：</span>

                    <i></i>
                    <select id="companyList" name="fgs" class="mySelect" style="font-size:1em;width:10em;"></select>
                </p>

            </form>
        </div>
        <div id="bills_list" class="sc-bg b-border">

        </div>
        <!-- <button>
            点击加载更多
            </button> -->
        <div id="tishi">

        </div>

    </div>

    <script src="../../build/js/appcan.js"></script>
    <script src="../../build/js/appcan.control.js"></script>
    <script src="../../common/jquery.min.js"></script>
    <script src="../../common/comm.js"></script>
    <script src="../../common/template-web.js"></script>
    <script src="../../build/js/appcan.listview.js"></script>
    <script id="Company_tmpl" type="text/html">
            {{each list}}
            <option linId = {{$value.linkId}} value={{$value.linkId}}>{{$value.orgName}}</option>

            {{/each}}

        </script>
    <!--OPE_TYPE  0收入 1支出 2冻结-->
    <script id="bills_tmpl" type="text/html">
            {{each list}}
            <div class="ub ub-ac ub-pj mf-size1 my-row order upadd list-content" id={{$value.FUNDSUB_ID}} onclick = "Orders.openDetail(id);">
            <div class="">
            <p class="order--title">
            订单号-{{if $value.ORDERSALE_CODE}}
            {{$value.ORDERSALE_CODE}}
            {{else}}
            -------
            {{/if}}
            </p>
            <p class="orderTime">
            {{$value.CREATE_DATE}}
            </p>
            </div>

            <div class="">
            {{if $value.OPE_TYPE == '0'}}
            <span style="color:#78C44F">
            收入  {{$value.OPE_MONEY}}
            </span>

            {{else if $value.OPE_TYPE == '1'}}
            <span id="">
            支出   -{{$value.OPE_MONEY}}
            </span>
            {{else if $value.OPE_TYPE == '2'}}
            <span id="">
            冻结  {{$value.OPE_MONEY}}
            </span>

            {{else if $value.OPE_TYPE == '3'}}
            <span id="">
            授信  {{$value.OPE_MONEY}}
            </span>
            {{else if $value.OPE_TYPE == '4'}}
            <span id="">
            解冻  {{$value.OPE_MONEY}}
            </span>
            {{else if $value.OPE_TYPE == '5'}}
            <span id="">
            退款  {{$value.OPE_MONEY}}
            </span>
            {{else if $value.OPE_TYPE == '7'}}
            <span id="">
            授信还款 {{$value.OPE_MONEY}}
            </span>
            {{/if}}

            </div>
            </div>

            {{/each}}

        </script>

</body>

<script type="text/javascript" charset="utf-8">
    // 模板引擎补充
    template.defaults.imports.Balance = function (number) {
        return number.toFixed(2);
    }
    // 当所有组件准备好后执行内部回调方法
    appcan.ready(function () {

        uexWindow.setWindowScrollbarVisible('false');

        appcan.frame.setBounce(1, function (type) {
            $("#pullstatus").html("");
        }, function (type) {
            $("#pullstatus").html("");
        }, function (type) {
            $("#pullstatus").html("松手了,产生事件了,开始更新数据！");
            // 下拉事件发生
            appcan.frame.resetBounce(1);
            // 当前总条数
            var num = Number(pageNo) * limit;


            $("#pullstatus").html("");
            // alert("totalRows=" + totalRows)

            if (Number(totalRows) <= num) {
                appcan.window.openToast({
                    msg: '没有更多',
                    duration: 1000,
                    position: 5,
                    type: 0
                });
                return;
            }

            pageNo = Number(pageNo) + 1;

            alert('准备加载第' + pageNo + '页')

            Orders.addData(pageNo);
        });
        Orders.init();

    });

    var Orders = {
        init: function () {
            this.queryCusBasOrg();
            this.options().bind();
        },
        options: function () {
            var yue = this,
                options = {};
            yue.options.companyList = document.getElementById('companyList');
            yue.options.bills_list = document.getElementById("bills_list");
            yue.options.tishi = document.getElementById('tishi');
            return yue;
        },
        bind: function () {
            var yue = this;
            this.options.companyList.onchange = function () {
                yue.changeCompany();
            }
        },

        // 获取公司列表
        queryCusBasOrg: function () {
            var yue = this;
            var func = yue.showCompanyCallback.bind(yue);

            ajaxPostQuery(URL + "/app/cus/queryCusBasOrg", "", func, "text");

        },
        // 回调
        showCompanyCallback: function (data) {
            var yue = this;
            var tishi = yue.options.tishi;
            var companyList = yue.options.companyList;

            if (typeof data == "string") {
                data = JSON.parse(data);
            };

            var html = template('Company_tmpl', {
                list: data
            });

            $('#companyList').html(html);
            tishi.style.height = "5em"

            var linkId = companyList.value;

            Orders.queryBills(linkId);
        },
        // 获取订单数据
        queryBills: function (linkId) {
            var yue = this;
            var paramJsonStr = "&pager.pageNo=" + pageNo + "&pager.pageSize=" + pageSize + "&cusOrgLinkid=" + linkId;
            var func = yue.showBillsCallback.bind(yue);
            ajaxPostQuery(URL + "/app/cus/queryCusPayMoney", paramJsonStr, func, "text");
            appcan.window.openToast('正在加载...', '0', '5', '1');

        },
        // 获取订单数据回调
        showBillsCallback: function (data) {
            var yue = this;
            var tishi = yue.options.tishi;
            var bills_list = yue.options.bills_list;

            appcan.window.closeToast();

            if (typeof data == "string") {
                data = JSON.parse(data)
            };
            totalRows = data["pager.totalRows"];
            // alert(totalRows)

            var html = '';
            if (data === 0) {
                html = "<div id='' class='ub ub-pc pc time-wrapper''>" + "<span class='mf-size2 time'>暂无历史账单</span>" + "</div>";
                tishi.innerHTML = html;
            } else {
                html = template('bills_tmpl', {
                    list: data.rows
                });
                bills_list.innerHTML = html;
                tishi.innerHTML = "";
            }

        },
        // 下拉刷新添加数据
        addData: function (newPageNo) {
            var yue = this;
            var linkId = yue.options.companyList.value;
            alert("正在请求第" + newPageNo + "调的数据")
            var paramJsonStr = "&pager.pageNo=" + newPageNo + "&pager.pageSize=" + pageSize + "&cusOrgLinkid=" + linkId;
            var func = yue.addDataCallback.bind(yue);

            ajaxPostQuery(URL + "/app/cus/queryCusPayMoney", paramJsonStr, func, "text");
            appcan.window.openToast('正在加载...', '0', '5', '1');
        },
        // 下拉刷新添加数据回调
        addDataCallback: function (data) {
            var yue = this;
            var tishi = yue.options.tishi;
            appcan.window.closeToast();

            if (typeof data == "string") {
                data = JSON.parse(data)
            };
            totalRows = data["pager.totalRows"];
            // alert(totalRows)

            var html = '';
            if (data === 0) {
                html = "<div id='' class='ub ub-pc pc time-wrapper''>" + "<span class='mf-size2 time'>暂无历史账单</span>" + "</div>";
                tishi.innerHTML = html;
            } else {
                alert("正在插入新页面的数据")
                html = template('bills_tmpl', {
                    list: data.rows
                });

                $('#bills_list').append(html);
                tishi.innerHTML = '';
            }
        },
        // 城市名称改变
        changeCompany: function () {
            var yue = this;
            yue.options.bills_list.innerHTML = "";
            var linkId = yue.options.companyList.value;
            pageNo = 1;
            yue.queryBills(linkId)
        },
        // 打开详情页
        openDetail: function (id) {
            appcan.locStorage.setVal('FUNDSUB_ID', id);
            appcan.window.open("detail", 'order_detail.html', 10);
        }
    }

</script>

</html>