<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../../build/css/ui-box.css">
        <link rel="stylesheet" href="../../build/css/ui-base.css">
        <link rel="stylesheet" href="../../build/css/ui-color.css">
        <link rel="stylesheet" href="../../build/css/appcan.icon.css">
        <link rel="stylesheet" href="../../build/css/appcan.control.css">
        <link rel="stylesheet" href="css/intentionList.css"/>
    </head>
    <body class="um-vp white-bg" ontouchstart>
        <div id="carlist" class="listbox">
            <div id="listdetail" class="detail bc-border"></div>
            <div>合计：￥<span id="heji"></span></div>
            <div id="remark">
                
            </div>
        </div>
        <form id="myFormId" action="" method="post">
            <input class="uhide" type="text" name="orderId" id="orderId" value=""/>
            <div id="" class="m-row2 umar-l" >
                <div>
                    上传支付回执
                </div>
                <div id="paybackImg">
                    
                </div>
                <div class="">
                    <span class="img-item d-line m-icon-add" id="addPic"></span>
                </div>
            </div>
            
            <div class="margin-a ub ub-ver">
                <div id="" class="m-row2 umar-l">
                    备注信息
                </div>
                <div class="umar-l">
                    <textarea id="remark" name="remark" type="text" class="m-textarea" oninput="beizhuChange()" onpropertychange="beizhuChange()"></textarea>
                </div>
            </div>
        </form>
        
        
    <script src="../../build/js/appcan.js"></script>
    <script src="../../build/js/appcan.control.js"></script>
    <script src="../../common/comm.js"></script>
    </body>
    <script>
        var resourPath = "";
        var orderId = "";
        var remark = "";
        appcan.ready(function() {
		   getOrder();
		   uexUploaderMgr.cbCreateUploader = cbCreateUploader;
            uexUploaderMgr.onStatus = onStatus;
            //uexImageBrowser.cbPick = function(opCode, dataType, data) {
            //     $('<img  src="' + data + '" style="width: 98px; height: 98px;" class="uinn" >').appendTo($('#paybackImg'));
                 //resourPath = data;
            //     uploadFile(data);
            //};
            uexImage.onPickerClosed=function(info){
                
                // alert(info);
                
                var imgs = JSON.parse(info);
                
                if(!imgs.isCancelled){
                
                    var img = imgs.data;
                
                    for(var i=0;i<img.length;i++){
                
                        $('<img  src="' + img[i] + '" style="width: 98px; height: 98px;" class="uinn" >').appendTo($('#paybackImg'));
                        uploadFile(img[i]);
                    }
                }
            }
          
             
            
        });
        
        
        
        //添加付款回执图片
        appcan.button("#addPic" , "btn-act" , function(){
            
        var data = {
            min:1,
            max:5,
            quality:0.5,
            detailedInfo:false
        }
            var json = JSON.stringify(data);
            uexImage.openPicker(json);
            
            //uexImageBrowser.pick();
        })
        
        var i=0;
        
        var file_local_path= new Array();
        
        function uploadFile(filePath){
            
            i = i+1;
            file_local_path.push(filePath);
            uexUploaderMgr.createUploader(i, URL+"/api/oil/fileUpload");
            
            //var headJson = '{"Content-type":"application/json;charset=utf-8"}';
            //uexUploaderMgr.setHeaders(i, headJson);
        }
        
        
        function cbCreateUploader(id, dataType, data){
           // alert("创建成功id:"+id);
            var index = id-1;

            if (data == 0) {
                //alert("创建成功id:"+id+"path:"+file_local_path[index]);
                uexUploaderMgr.uploadFile(id, file_local_path[index], "inputName", 0);
            } else {
                alert("创建失败");
            }
        }

        function onStatus(id, fileSize, percent, serverPath, status){
            switch (status) {
            case 0:
                break;
            case 1:
                //alert("上传成功,服务器路径为"+serverPath);
                resourPath = resourPath+serverPath+"@";
                uexUploaderMgr.closeUploader(id);
                //alert(resourPath);
                break;
            case 2:
                alert("上传失败");
                uexUploaderMgr.closeUploader(id);
                break;
            }
        }
        
        function getOrder(){
            orderId = appcan.locStorage.getVal("payorderId");
            $("#orderId")[0].value=orderId;
            var url = URL + "/app/bill/getOrder";
            var paramJsonStr = "orderId=" + orderId;
            var func = getOrderCallBack;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('数据加载中...', '0', '5', '1');
        }
        
        function getOrderCallBack(data){
            appcan.window.closeToast();
            if(typeof data == "string"){
                data=eval("("+data+")");
            }
            var sum = 0.00;
            var datalist = data.list;
            var orderId = datalist[0].orderId;
            remark = datalist[0].remark;
            if(typeof(remark) == "undefined"){
                remark="";
            }
            var orderSub = datalist[0].orderSub;
            for (var i=0; i < orderSub.length; i++) {
                var oilinfoName = orderSub[i].oilinfoName;
                var oilPrice = orderSub[i].oilPrice;
                var oilNumber = orderSub[i].oilNumber;
                var oilAmot = orderSub[i].oilAmot;
                var extractType = orderSub[i].extractType;
                
                var transType = "配送";
                if(extractType==0){
                    transType = "配送";
                }else{
                    transType = "自提";
                }
                sum+=oilAmot;
                $("#listdetail")[0].innerHTML +='<div id="detailbox'+i+'" class="detailbox ubb bc-border">'+
                        '<div id="name'+i+'" class="bw1 ub ub-ver ">'+
                            '<div class="umar-a oil-name">'+oilinfoName+'</div>'+
                            '<div class="umar-b"><span class="mf-color">￥</span>'+
                                '<span class="mf-color" id="oilPrices'+i+'">'+oilPrice+'</span>'+
                                '<span class="mf-color2 mf-size2">/吨</span>'+
                                '<span class="umar-l m-border1" id="pz'+i+'">'+transType+'</span>'+
                            '</div>'+
                        '</div>'+
                        '<div id="account'+i+'" class="bw2 ub ub-ac ub-pc amount">x'+oilNumber+'</div>'+
                        '<div id="price'+i+'" class="ub ub-ac ub-pe bw3 mf-color ">'+
                            '￥'+oilAmot+''+
                        '</div>'+
                    '</div>';
            };
            $("#remark")[0].innerHTML = "备注信息："+remark;
            $("#heji")[0].innerHTML = Number(sum);
        }
        var beizhu="";
        function beizhuChange(){
             beizhu = $("textarea")[0].value;
             appcan.locStorage.remove("paybeizhu");
             appcan.locStorage.setVal("paybeizhu",beizhu);
        }
        
        function payOrder(){       
            
            if(resourPath.length==0){
                appcan.window.openToast({
                    msg:'请选择至少一张图片',
                    duration:1000,
                    position:5,
                    type:0
                });
                return;
            }
            
            var url = URL + "/app/bill/payOrder";
            var paramJsonStr = "orderId="+orderId+"&picList="+resourPath+"&remark="+remark;
            var func = payOrderCallback;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('正在提交数据...', '0', '5', '1');
        }
        function payOrderCallback(data){
            appcan.window.closeToast();
            uexWindow.alert("提示","提交成功","确定");
            uexWindow.evaluateScript("intentionPay", 0, "close()");
        }
    </script>
</html>
