<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../build/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../build/css/ui-box.css">
        <link rel="stylesheet" href="../build/css/ui-base.css">
        <link rel="stylesheet" href="../build/css/ui-color.css">
        <link rel="stylesheet" href="../build/css/appcan.icon.css">
        <link rel="stylesheet" href="../build/css/appcan.control.css">
        <link rel="stylesheet" type="text/css" href="css/delivery.css"/>
        <link rel="stylesheet" href="../build/mui/dist/css/mui.css">
        <link rel="stylesheet" type="text/css" href="../build/mui/date/css/mui.picker.min.css" />
        <link rel="stylesheet" type="text/css" href="../build/mui/date/css/app.css"/>
    </head>
    <body class="um-vp bc-bg mf-size1" ontouchstart>
        <div id="" class="">
            <div id="noticeInfo" class="bc-bg ub b-border padding-a">
                <div class="umar-l gray-font mf-size1">
                    订单详情
                </div>
            </div>

            <div id="" class="white-bg  ub ub-ac b-border">
                <div id="" class="m-row2 gray-font label-width">
                    付油通知单号
                </div>
                <div id="noticeCode"></div>
            </div>

            <div id="" class="white-bg  ub ub-ac b-border">
                <div id="" class="m-row2 gray-font label-width">
                    名称规格
                </div>
                <div id="oilname"></div>
            </div>

            <div id="" class="white-bg  ub ub-ac b-border">
                <div id="" class="m-row2 gray-font label-width">
                    通知单量
                </div>
                <div id="">
                    <span id="oilnum"></span><span class="umar-l gray-font mf-size2">吨</span>
                </div>
            </div>

            <div id="" class="white-bg  ub ub-ac b-border">
                <div id="" class="m-row2 gray-font label-width">
                    可预约用量
                </div>
                <div id="">
                    <span class="mf-color" id="num"></span><span class="umar-l gray-font mf-size2">吨</span>
                </div>
            </div>

            <div id="titlebar" class="bc-bg ub b-border padding-a">
                <div class="umar-l gray-font mf-size1">
                    配送信息
                </div>
            </div>
            <div class="white-bg  ub ub-ac b-border">
                <div class="m-row2 gray-font label-width">
                    计划数量
                </div>
                <div class="umar-r">
                    <input type="text" placeholder="请在此输入数量" class="no-border-input" id="count"/>
                    <!--
                    <input type="text" class="m-input amount-input input-size" name="count" id="count" value="10.111" />
                    -->
                </div>
            </div>

            <div id="" class="white-bg  ub ub-ac b-border">
                <div id="" class="m-row2 gray-font label-width">
                    送油网点
                </div>
                <div class="ub ub-pj ub-f1" onclick="siteChoose()">
                    <div id="sitelist"  class="ub ub-ac"></div>
                    <div class="umar-r fa fa-angle-right fa-2x gray-font"></div>
                </div>
            </div>

            <div id="" class="white-bg  ub ub-ac b-border">
                <div id="" class="m-row2 gray-font label-width">
                    配送时间
                </div>
                <div id="timeBtn" class="ub ub-pj ub-f1">
                    <div id="result" class="ub ub-ac"></div>
                    <div class="umar-r fa fa-angle-right gray-font fa-2x"></div>
                </div>
            </div>

            <div id="" class="white-bg b-border m-row4">
                <div id="" class="gray-font">
                    备注
                </div>
                <div class="umar-t">
                    <textarea class="m-textarea"></textarea>
                </div>
            </div>

    </body>
    <script src="../build/js/appcan.js"></script>
    <script src="../build/js/appcan.control.js"></script>
    <script src="../common/comm.js"></script>
    <script type="text/javascript" charset="utf-8" src="../build/js/appcan.listview.js"></script>

    </body>
    <script>
        var carId = "";
        var depotId = "-1";
        var siteId = "";
        var param = "";
        var num = 0;
        var sitelist = [];
        var num = 0;   
        appcan.ready(function() {
            var noticeSubId = appcan.locStorage.getVal("yuyuenoticeId");
            addBilSendInit(noticeSubId);

            appcan.window.subscribe("siteParam", function(siteParam) {

                siteParam = JSON.parse(siteParam);
                var para = siteParam.id;
                siteId = para.split("@")[0];
                var sitename = para.split("@")[1];
                $("#sitelist")[0].innerHTML = sitename;

                appcan.locStorage.remove("siteParam");
                appcan.locStorage.setVal("siteParam", siteParam);
            })
            showDeliveryName();
        });

        //订单详情
        function addBilSendInit(noticeSubId) {
            var url = URL + "/app/bill/addBilSendInit";
            var paramJsonStr = "noticesubId=" + noticeSubId;
            var func = addBilSendInitCallBack;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('加载中...', '0', '5', '1');
        }

        function addBilSendInitCallBack(data) {
            appcan.window.closeToast();
            if ( typeof data == "string") {
                data = JSON.parse(data)
            }
            console.log('订单详情')
            console.log(data);
            var noticeSubInfo = data.notincesubInfo;
            sitelist = data.stationList;

            var infoStr = "";
            //付油通知单号id  noticeCode
            //名称规格 id  oilname
            //通知单量  id  oilnum
            //可用量 id  num
            for (var i = 0; i < noticeSubInfo.length; i++) {
                param += noticeSubInfo[i].noticesubId + "★" + noticeSubInfo[i].oilinfoId + "★" + noticeSubInfo[i].oilinfoSpec + "★" + noticeSubInfo[i].oilNumber + "★" + noticeSubInfo[i].extractType + "★" + noticeSubInfo[i].oilinfoName;
                var noticeCode = noticeSubInfo[i].noticeCode;
                var oilinfoName = noticeSubInfo[i].oilinfoName;
                var oilNum = (noticeSubInfo[i].oilNumber).toFixed(2);
                num = (noticeSubInfo[i].oilNumber - noticeSubInfo[i].expectNum).toFixed(2);

                $("#noticeCode")[0].innerHTML = noticeCode;
                $("#oilname")[0].innerHTML = oilinfoName;
                $("#oilnum")[0].innerHTML = oilNum;
                $("#num")[0].innerHTML = num;
            }
        }

        //送油网点
        function showDeliveryName() {

            var DeliveryName = appcan.locStorage.getVal('siteStr');
            if (!DeliveryName) {
                return;
            }
            var siteParam = JSON.parse(DeliveryName);
            var para = siteParam.id;
            siteId = para.split("@")[0];
            var sitename = para.split("@")[1];
            $("#sitelist")[0].innerHTML = sitename;

            appcan.locStorage.remove("siteParam");
            appcan.locStorage.remove("siteStr");
            appcan.locStorage.setVal("siteParam", siteParam);

        }

        function siteChoose() {
            appcan.locStorage.setVal("sitelist", sitelist);
            appcan.window.open("sitelist", "sitelist.html", 10);
        }

        function subPSInfo() {

            var count = parseInt(document.getElementById('count').value);
            var chooseDate = appcan.locStorage.getVal("chooseDate");
            var chooseTime = appcan.locStorage.getVal("chooseTime")
            if (isNaN(count)) {
                appcan.window.alert("提示", "提油数量请输入数字！", "确定");
                return;
            }
            var typeString = toString.call(count);
            if (typeString !== "[object Number]") {
                appcan.window.alert("提示", "提油数量请输入数字！", "确定");
                return;
            }
            if (count == "") {
                appcan.window.alert("提示", "请输入计划数量！", "确定");
                return;
            }
            if (Number(num) < Number(count)) {
                appcan.window.alert("提示", "计划数量不得大于可预约量！", "确定");

                return;
            }
            if (Number(count) <= 0) {
                appcan.window.alert("提示", "计划数量不得为0或负数！", "确定");

                return;
            }

            if (chooseDate == "" || chooseDate == null || chooseTime == "" || chooseTime == null) {
                appcan.window.alert("提示", "请选择完整配送日期！", "确定");
                return;
            }

            if (siteId == "" || siteId == null) {
                appcan.window.alert("提示", "请选择送油网点！", "确定");
                return;
            }

            var remark = $("textarea")[0].value;
            //数量，地点，车辆，时间
            param += "★" + count + "★" + siteId + "★" + carId + chooseDate + "★" + chooseTime + "★" + remark;
            console.log(param)

            var id_array = [];
            id_array.push(param);
            var strtmp = id_array.join(',');

            var url = URL + "/app/bill/addBillSend";
            //访问路径
            var paramJsonStr = "oils=" + strtmp;
            //参数
            var func = addBillSendCallback;
            //返回的方法
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('正在提交提油申请...', '0', '5', '1');
        }

        function addBillSendCallback(data) {
            appcan.window.closeToast();
            if (data != "") {

                appcan.window.alert({
                    title : "提示",
                    content : "配送申请提交成功",
                    buttons : ['确定'],
                    callback : function(err, data, dataType, optId) {
                        if (data == '0') {
                            uexWindow.evaluateScript("delivery", 0, "closePage()");

                        }

                        console.log(err, data, dataType, optId);
                    }
                });

            } else {
                uexWindow.alert("提示", "配送申请提交失败，请重试", "确定");
            }
        }

    </script>
    <script src="../build/mui/dist/js/mui.min.js"></script>
    <script src="../build/mui/js/mui.picker.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        (function($) {
            $.init();
            var result = $('#result')[0];
            var btns = $('#timeBtn');
            btns.each(function(i, btn) {
                btn.addEventListener('tap', function() {
                    var _self = this;
                    if (_self.picker) {
                        _self.picker.show(function(rs) {
                            result.innerText = rs.text;
                            var chooseDate = (rs.text).split(" ")[0];
                            var chooseTime = (rs.text).split(" ")[1];
                            appcan.locStorage.setVal("chooseDate", chooseDate)
                            appcan.locStorage.setVal("chooseTime", chooseTime)
                            _self.picker = null;
                        });
                    } else {
                        var date = new Date().formate("yyyy-MM-dd"),
                            y = date.split("-")[0],
                            m = Number(date.split("-")[1]),
                            d = Number(date.split("-")[2]);

                        var thisMonthDay = mGetDate(y, m),
                            continuedDays = 7,
                            maxDay = d + continuedDays > thisMonthDay ? d + continuedDays - thisMonthDay : Number(d) + continuedDays,
                            minMonth = m - 1,
                            maxMonth = d+continuedDays>thisMonthDay?minMonth+1:minMonth;

                        var options = {
                            type : "hour", //设置日历初始视图模式
                            beginDate : new Date(y, minMonth, d), //设置开始日期
                            endDate : new Date(y, maxMonth, maxDay), //设置结束日期
                            labels : ["年", "月", "日", "时段", "分"], //设置默认标签区域提示语
                            customData : {
                                h : [{
                                    "text" : "上午",
                                    "value" : "上午"
                                }, {
                                    "text" : "下午",
                                    "value" : "下午"
                                }, {
                                    "text" : "晚上",
                                    "value" : "晚上"
                                }]
                            }//时间/日期别名
                        }
                        var id = this.getAttribute('id');

                        _self.picker = new $.DtPicker(options);
                        _self.picker.show(function(rs) {

                            result.innerText = rs.text;
                            var chooseDate = (rs.text).split(" ")[0];
                            var chooseTime = (rs.text).split(" ")[1];
                            appcan.locStorage.setVal("chooseDate", chooseDate)
                            appcan.locStorage.setVal("chooseTime", chooseTime)

                            _self.picker = null;
                        });
                    }

                }, false);
            });
        })(mui);
    </script>

</html>
