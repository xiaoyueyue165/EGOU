<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
        <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css"/>
        <link rel="stylesheet" href="../../build/css/ui-box.css"/>
        <link rel="stylesheet" href="../../build/css/ui-base.css"/>
        <link rel="stylesheet" href="../../build/css/ui-color.css"/>
        <link rel="stylesheet" href="../../build/css/appcan.icon.css"/>
        <link rel="stylesheet" href="../../build/css/appcan.control.css"/>
        <link rel="stylesheet" type="text/css" href="css/oil_list.css"/>
        <script src="../../common/comm.js"></script>
    </head>
    <body class="um-vp white-bg" ontouchstart>
        <div id="oilDataList" class="clearfix"></div>
        <script src="../../build/js/appcan.js"></script>
        <script src="../../build/js/appcan.control.js"></script>
        <script src="../../common/jquery.min.js"></script>
    </body>
    <script>
        var totalNum = 0;
        appcan.ready(function() {
            appcan.window.subscribe("listPageRefresh",function(param){
                if(param=="true"){
                    //window.location.reload();
                    reload();
                }
            })
            
      
            
            queryOilPriceList();
        });
        
        function reload(){
            $("#oilDataList").html("");
            $("#loginlabel").html("");
            queryOilPriceList();
        }
        
        function queryOilPriceList(){
            var url = URL + "/app/oil/queryOilPriceList";
            var paramJsonStr = "limit=" + limit + "&offset=" + offset;
            var func = showOilDetail;
            var dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('加载中...', '0', '5', '1');
        }

        function showOilDetail(data) {
            appcan.window.closeToast();
            if ( typeof data == "string") {
                data = eval("(" + data + ")");
            }
            var pojoList = data.pojoList;
            var cusState = data.cusState;
            var loginName = data.loginName;
            totalNum = data.total;
            //alert(cusState);
            var listData = [];
            if(loginName ==""){//未登录显示label提示用户登录
                $("#oilDataList").before('<div id="loginlabel" class="float-bar-wrapper"><div class="ub ub-pj float-bar"><div id="" class="mf-size2">登录后查看您的<span class="mf-size">会员专价</span></div><div class="mf-size2" onclick="gotoLoginPage()">去登录<div id="" class="fa fa-angle-right"></div></div></div></div>');
            }
            
            var htmlstr = "";
            for (var i = 1; i <= pojoList.length; i++) {

                var oilinfoId = pojoList[i - 1].oilinfoId;//油品ID
                var oilinfoName = pojoList[i - 1].oilinfoName;//油品名称
                var oilinfoNameShort = pojoList[i - 1].oilinfoNameShort
                var providePrice = pojoList[i - 1].providePrice;//国家定价
                var marketPrice = pojoList[i - 1].providePrice;//挂牌价
                var oilImage = pojoList[i - 1].oilImage;//图片位置
                var zhuanshu = pojoList[i - 1].zhuanshu;//图片位置
                var oilinfoSpec = pojoList[i - 1].oilinfoSpec;//汽油柴油
                
                var beizhu = pojoList[i - 1].remark;//汽油柴油
                
                if ( typeof (oilinfoSpec) == "undefined") {
                    oilinfoSpec = "";
                }
                //alert(oilinfoSpec);
                if ( typeof (providePrice) == "undefined") {
                    providePrice = "";
                }
                if ( typeof (marketPrice) == "undefined") {
                    marketPrice = "￥暂无价格";
                }
                if ( typeof (oilImage) == "undefined") {
                    oilImage = "";
                }
                if ( typeof (zhuanshu) == "undefined" || zhuanshu==0) {
                    zhuanshu = "￥暂无价格";
                }
                var oilInfoparam = "&quot;"+oilinfoId+"&quot;,&quot;"+zhuanshu+"&quot;,&quot;"+oilinfoName+"&quot;,&quot;"+oilinfoSpec+"&quot;";
                if(marketPrice != "￥暂无价格"){
                    marketPrice = '￥'+marketPrice+'/吨'
                }
                
                if(zhuanshu != "￥暂无价格" && zhuanshu !=0){
                    zhuanshu = '￥'+zhuanshu;
                }
                if ( typeof (beizhu) == "undefined") {
                    beizhu = "";
                }
                
                if (cusState == "1") {//激活用户（挂牌价、专属价）
                    var addStr="";
                    var viewpage = "";
                    if(zhuanshu == 0 || zhuanshu == "￥暂无价格"){
                        viewpage = "<span class='title'>" + oilinfoNameShort + "</span></div>";
                        addStr = "<div class='uc-a3 a-border2 uinn2 padding-l2 mf-size2 btn-cart-add-gray gray-font'>加入意向单</div>";
                    }else{
                        viewpage ="<span class='title'>" + oilinfoNameShort + "</span></div>";
                        addStr = "<div id='" + oilinfoId +"' class='uc-a3 a-border3 uinn2 padding-l2 mf-size2 btn-cart-add y-font' onclick='addShopping("+oilInfoparam+")'>加入意向单</div>";
                    }
                
                    htmlstr += "<div class='item-wrapper'>" 
                    + "<div class='ub ub-ver ub-ac item-content'>" 
                    + "<div id='name' class='ub ub-pc t-section mf-color2'>" 
                    +  viewpage;
                    
                    if(beizhu != ""){
                         htmlstr+="<div id='price' class='ub ub-pc uc-a3 c-block'>"+beizhu+"</div>" 
                                + "<div id='preprice' class='gray-font mf-size2 p-area'>销售价&nbsp;<span class='ptxt'>" 
                                + marketPrice + "</span> </div>" 
                                + "<div id='add' class='action-add'>" 
                                + addStr 
                                + "</div></div></div>";
                    }else{
                        htmlstr +="<div id='price' class='ub ub-pc uc-a3 c-block'>"
                                + zhuanshu + "</div>" 
                                + "<div id='preprice' class='gray-font mf-size2 p-area'>销售价&nbsp;<span class='ptxt'>" 
                                + marketPrice + "</span></div>" 
                                + "<div id='add' class='action-add'>" 
                                + addStr 
                                + "</div></div></div>";
                    }
                } else {//未激活用户（国家定价、挂牌价）
                    htmlstr += "<div class='item-wrapper'>" 
                    + "<div class='ub ub-ver ub-ac item-content'>" 
                    + "<div id='name' class='ub ub-pc t-section mf-color2'>" 
                    + "<span class='title'>"+ oilinfoNameShort + "</span></div>" 
                    + "<div id='price' class='ub ub-pc uc-a3 c-block'>" 
                    + "<span class=''>挂牌价</span></div>";
                    
                    if(beizhu!=""){
                        htmlstr +="<div id='preprice' class='gray-font mf-size2 p-area'>"+ beizhu + "</span></div>";
                    } else{
                        htmlstr +="<div id='preprice' class='gray-font mf-size2 p-area'>销售价&nbsp;<span class=''>" 
                                + marketPrice + "</span></div>";
                    }
                    
                    htmlstr+="<div id='add' class='action-add'>" 
                    + "<div class='uc-a3 a-border2 uinn2 padding-l2 mf-size2 btn-cart-add-gray gray-font'>加入意向单</div>" 
                    + "</div></div></div>";
                }
            }
            $("#oilDataList").css("opacity","0");//这句加在append前
            $("#oilDataList").append(htmlstr);
            $("#oilDataList").animate({opacity:1},500);//这句的作用是使DIV缓慢显示
            
        }
        
        appcan.button("#nav-left", "btn-act", function() {
            appcan.window.close(-1);
        });

        //查看油品详情
        // function viewDetailPage(oilId) {
            // appcan.locStorage.setVal("oilId", oilId);
            // appcan.window.open("oil_details", "../oil_content/oil_details.html", 10);
            // //alert(oilId);
            // //console.log("1111");
        // }
        
        //加入意向单
        function addShopping(oilinfoId, oilPrice, oilinfoName, oilinfoSpec) {
            var cusId = appcan.locStorage.getVal("cusId");
            var extractType = 0;
            var oilNumber = 1;
            //alert(oilinfoId);
            appcan.locStorage.setVal("oilinfoIdOne", oilinfoId);
            appcan.locStorage.setVal("oilPriceOne", oilPrice);
            appcan.locStorage.setVal("oilinfoNameOne", oilinfoName);
            appcan.locStorage.setVal("oilinfoSpecOne", oilinfoSpec);
            
            var url = URL + "/app/bill/newInsertBill";//访问路径
            var paramJsonStr = "oilinfoId=" + oilinfoId + "&oilPrice=" + oilPrice + "&extractType=" + extractType + "&oilNumber=" + oilNumber + "&oilinfoName=" + oilinfoName + "&oilinfoSpec=" + oilinfoSpec;//参数
            var func = addyxdCallback;//返回的方法
            var dataType = "text";
            appcan.window.openToast('意向单提交中...', '0', '5', '1');
            ajaxPostQuery(url, paramJsonStr, func, dataType);
        }
        
        function addyxdCallback(data){
            appcan.window.closeToast();
            if(data=="ok"){
                appcan.window.openToast({
                    msg:'该油品已加入意向单',
                    duration:1000,
                    position:5,
                    type:0
                });
            }
            
             appcan.window.open("intentionList", "../intentionList/intentionList.html", 10);
        }

        //未登录用户，去登录
        function gotoLoginPage(){
            appcan.locStorage.setVal("tag", "listpage");
            appcan.window.open("login", "../userpage/login.html", 10);
        }
        
       
       
    </script>
</html>
