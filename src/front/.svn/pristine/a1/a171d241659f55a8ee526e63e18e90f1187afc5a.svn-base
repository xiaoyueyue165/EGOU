<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="../../build/css/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../../build/css/ui-box.css">
    <link rel="stylesheet" href="../../build/css/ui-base.css">
    <link rel="stylesheet" href="../../build/css/ui-color.css">
    <link rel="stylesheet" href="../../build/css/appcan.icon.css">
    <link rel="stylesheet" href="../../build/css/appcan.control.css">
    <link rel="stylesheet" href="css/intentionList.css">
    <style type="text/css">
        table {
            width: 100%;
        }

        tr {
            width: 100%;
        }

        td {
            width: 50%;
            padding: 0.4em;
            text-align: center;
        }

        table td:last-child {
            text-align: left;
        }

        .layui-m-layerchild {
            padding: 0.4em;
        }

        .chuku {
            position: absolute;
            left: 5.2em;
            top: 0;
            line-height: 1.8em;
        }

        .um3 {
            margin-left: 3em;
        }
    </style>
</head>

<body class="um-vp bc-bg" ontouchstart>
    <div id="carlist" class="listbox">
        <div id="listdetail" class="pd4 bc-border white-bg"></div>
    </div>
    <div style="height:3em"></div>

    <!--footer-->
    <div id="footer" class="ub ubt bc-border uf tab-foot">
        <div id="" class="ub uw-a">
            <div id="" class="ub ub-pc ub-ac uw-1">
                <div id="" class="umar-l">
                    <div class="m-check" name="" id="checkall"></div>
                </div>
                <div id="" class="umar-l">
                    <span class="mf-size2">全选</span>
                </div>
            </div>

            <div id="sum_price" class="uw-2 ub ub-pe area-price">
                <span class="umar-r">
                    <span class="mf-size2 gray-font">合计：</span>
                    <span class="mf-color">￥
                        <span id="heji"></span>
                    </span>
                </span>
            </div>

            <div id="confirmYXD" class="uw-3 ub ub-ac ub-pc sec-btn1">
                提交订单
            </div>
        </div>
    </div>

    <script type="text/html" charset="utf-8" id="orderList">
        {{each list}}
        <div id="detailbox{{$index}}" class="detailbox ubb bc-border">

            <div id="intentionIds{{$index}}" style="display:none"></div>
            <div id="intentionId{{$index}}" style="display:none">{{$value.intentionId}}</div>
            <div id="oilinfoId{{$index}}" style="display:none">{{$value.oilinfoId}} </div>
            <div id="oilinfoName{{$index}}" style="display:none">{{$value.oilinfoName}}</div>
            <div id="extractType{{$index}}" style="display:none">{{$value.extractType}}</div>
            <div id="youhui{{$index}}" style="display:none"> {{if $value.youhui=="是"}} 是 {{else}} 否 {{/if}}
            </div>
            <div id="ykdd{{$index}}" style="display:none">{{$value.ykdd}}</div>
            <div id="ysfs{{$index}}" style="display:none">{{$value.ysfs}}</div>
            <div id="chukuliang{{$index}}" style="display:none">{{$value.chukuliang}}</div>
            <div id="gyfgs{{$index}}" style="display:none">{{$value.gyfgs}}</div>
            <div id="pickupDiscount{{$index}}" style="display:none">{{$value.pickupDiscount}}</div>

            <div id="check{{$index}}" class="bw0 ub ub-ac " onclick="cellbtnClick(id)">
                <div id={{$index}} class="m-check"></div>
            </div>
            <div id="name{{$index}}" class="bw1 ub ub-ver">
                <div class="umar-a fs09">{{$value.oilinfoName}}</div>
                <div class="umar-b">
                    <span class="mf-color mf-size-s">￥</span>
                    <span class="mf-color mf-size1" id="oilPrices{{$index}}"> {{$value.oilPrice}}</span>
                    <span class="mf-color2 mf-size-s">/吨</span>
                    <span class="umar-l m-border1" id="pz{{$index}}">
                        {{if $value.extractType==0}} 配送 {{else}} 自提 {{/if}}
                    </span>
                </div>
            </div>
            <div id="account{{$index}}" class="bw2 ub ub-ac ub-pc fs08">x{{$value.oilNumber}}</div>
            <div id="priceA{{$index}}" class="ub ub-ac bw3 ub-pc mf-color">
                {{if $value.oilPrice ===0}}
                <span id="price{{$index}}" class="mf-size1 ">已下架</span>
                {{else}}
                <span class="mf-size-s">￥</span>
                <span id="price{{$index}}" class="mf-size1 ">
                    {{$value.oilAmot | fmoney}}
                </span>
                {{/if}}

            </div>
        </div>
        {{/each}}

    </script>

    <script type="text/html" id="beizhu">

        <div class="gap"></div>
        <div id="remark" class="ub ub-ver umar-t ub-beizhu">
            <div id="" class="umar-a">
                备注信息
            </div>
            <textarea placeholder="可以填写您指定的提油油库或开票时间等要求" name="remark" id="remark" class="m-textarea umar-a" oninput="beizhuChange()"
                onpropertychange="beizhuChange()"></textarea>
        </div>
        <div id="" class="umar-a">
            <div class="ub">
                <div id="checkRed" class="umar-a oil-name" onclick="checkRed()">
                    <div id="checkRed2" class="m-check m-check-active"></div>
                </div>
                <div class="ulev-1" style="margin-bottom: 1em;">
                    &nbsp;&nbsp;&nbsp;&nbsp;我已阅读并同意
                    <span onclick="showPic();" class="red-font">
                        <br />&nbsp;&nbsp;《中国石油上海销售分公司电子购油协议》</span>
                </div>
            </div>
        </div>
    </script>

    <script src="../../build/js/appcan.js"></script>
    <script src="../../build/js/appcan.control.js"></script>
    <script src="../../build/js/appcan.tab.js"></script>
    <script src="../../build/js/appcan.listview.js"></script>
    <script type="text/javascript" src="../../common/comm.js"></script>
    <script src="../../common/jquery.min.js"></script>
    <script src="../../common/template-web.js"></script>

</body>
<script>
    template.defaults.imports.changeMoney = function (value) {
        return fmoney(value)
    }
    var LISTDATA = {},
        sumPrice = 0.00,
        listNum = 0,
        remark = null,
        paytype = "账面余额支付",
        depotList = [],
        isOnce = true;
    appcan.ready(function () {

        uexWindow.setWindowScrollbarVisible('false');

        appcan.window.subscribe("ifEdit", function (editTag) {
            if (editTag == "true") {
                editIntention();
            } else if (editTag == "false") {
                finishEditIntention();
            }
        })
        Order.init();

    })

    function reload() {

        $("#listdetail")[0].innerHTML = "";
        Order.init();
    }
    var Order = {
        init: function () {
            var y = this;
            y.queryOrderList();
        },
        // 查询待提交的意向单
        queryOrderList: function () {
            var y = this;
            var url = URL + "/app/bill/newGetBill",
                paramJsonStr = "limit=" + limit + "&offset=" + offset,
                func =
                y.getOrderListCallback.bind(this),
                dataType = "text";
            ajaxPostQuery(url, paramJsonStr, func, dataType);
            appcan.window.openToast('加载中...', '0', '5', '1');
        },
        getOrderListCallback: function (data) {

            if (typeof data == "string") {
                data = JSON.parse(data)
            }
            var sum = 0;
            var pojoList = data.pojo;
            listNum = pojoList.length;
            LISTDATA = pojoList;
            appcan.window.closeToast();
            if (pojoList.length > 0) {
                var orderListStr = template('orderList', {
                    list: pojoList
                })
                for (var i = 0; i < pojoList.length; i++) {
                    var oilAmot = pojoList.oilAmot;
                    sum += oilAmot;
                }

                $('#listdetail').append(orderListStr);
                var beizhuStr = template('beizhu', {});
                $('#listdetail').append(beizhuStr);

            } else {
                $("#listdetail")[0].innerHTML = "您还没有选购油品，去看看有没有您需要的油品吧。";

            }
            heji.innerHTML = 0;
        }
    }

    //编辑意向单
    function editIntention() {
        for (var i = 0; i < listNum; i++) {
            $("#account" + i)[0].className = "edit-bw2 ub ub-ac ub-pc amount";
            var oldprice = $("#account" + i)[0].innerHTML;
            oldprice = oldprice.substring(1, oldprice.length);
            $("#account" + i)[0].innerHTML = "<input type='number' id='accounts" + i + "' class='m-input' value='" +
                oldprice + "' style='width:2em'/>";
            $("#priceA" + i)[0].className = "ub ub-pc ub-ac";
            var peisongziti = $("#pz" + i)[0].innerHTML;
            if (peisongziti == "配送") {

                $("#priceA" + i)[0].innerHTML = "<div class='switch-wrapper m-switch' ><span id='peisong" + i +
                    "' class='s-item focus l-radius'>配送</span><span id='ziti" + i +
                    "' class='s-item nofocus r-radius'>自提</span></div>";

            } else {
                $("#priceA" + i)[0].innerHTML = "<div class='switch-wrapper m-switch' ><span id='peisong" + i +
                    "' class='s-item nofocus l-radius'>配送</span><span id='ziti" + i +
                    "' class='s-item focus r-radius'>自提</span></div>";
            }

            $("#sum_price")[0].className = "uw-2 umar-r area-price hide";
            $("#priceA" + i).attr("id", "type" + i);

            $("#type" + i).unbind('click');
            $("#type" + i).bind('click', function () {
                typeBtnClick($(this).attr("id"));
            })
        }
        $("#confirmYXD").attr("id", "del");
        $("#del")[0].innerHTML = "删除";
        $("#del").click(function () {
            deletecell($(this).attr("id"));
        });
    }

    //完成编辑
    function finishEditIntention() {
        var editsum = 0;
        for (var i = 0; i < listNum; i++) {

            $("#account" + i)[0].className = "bw2 ub ub-ac ub-pc amount";
            var number = $("#accounts" + i)[0].value;
            $("#account" + i)[0].innerHTML = "x" + number;

            var ps = rmoney($("#oilPrices" + i)[0].innerHTML);

            $("#type" + i)[0].className = "ub ub-ac ub-pc bw3 mf-color";
            $("#type" + i)[0].innerHTML = "<span class='mf-size-s'>￥</span><span id='price" + i + "' class='mf-size1'>" +
                fmoney(ps * number) + "</span>";
            $("#sum_price")[0].className = "uw-2 ub ub-pe  umar-r area-price";
            $("#type" + i).attr("id", "priceA" + i);

            if (!$("#detailbox" + i).is(":hidden") && $("#" + i)[0].className == "m-check m-check-active") {
                editsum += ps * number;
            }
            if ($("#account" + i)[0].innerText.slice(1) < 0.001) {
                $("#account" + i)[0].innerText = "x1";
                oneAlert("购油数量最小为0.001吨", "确定");

                return;
            }
        }
        $("#del").attr("id", "confirmYXD");
        $("#confirmYXD")[0].innerHTML = "确认清单";
        appcan.locStorage.setVal("sumprice", editsum);

        heji();
    }

    //提交订单
    appcan.button("#confirmYXD", "ani-act", function () {
        if (this.id == "del") {
            return;
        }
        var oillist = [];

        for (var i = 0; i < listNum; i++) {
            //intentionId+'★'+oilinfoId+'★'+oilinfoSpec+'★0★'+oilinfoName+'★'+oilPrice+'★'+oilNumber+'★'+extractType
            if (!$("#detailbox" + i).is(":hidden") && $("#" + i)[0].className == "m-check m-check-active") {
                var intentionId = $("#intentionId" + i)[0].innerText,
                    oilinfoId = $("#oilinfoId" + i)[0].innerText,
                    oilinfoName = $("#oilinfoName" + i)[0].innerText,
                    oilPrice = rmoney($("#oilPrices" + i)[0].innerText),

                    oilNumber = $("#account" + i)[0].innerText,
                    oilNumbers = oilNumber.substring(1, oilNumber.length),
                    ykdd = $("#ykdd" + i)[0].innerText,
                    ysfs = $("#ysfs" + i)[0].innerText,
                    gyfgs = $("#gyfgs" + i)[0].innerText,
                    extractType = $("#extractType" + i)[0].innerText,
                    youhui = $("#youhui" + i)[0].innerText.trim(),
                    // 出库量再此处
                    chukuliang = $("#chukuliang" + i)[0].innerText;

                var intentionIds = intentionId + '★' + oilinfoId + '★null★0★' + oilinfoName + '★' + oilPrice +
                    '★' + oilNumbers + '★' + gyfgs + '★' + extractType + '★' + ykdd + '★' + ysfs + '★' +
                    chukuliang + '★' + '★0★★' + youhui;
                //alert(intentionIds);

                oillist.push(intentionIds);
            }
        }

        if (oillist.length == 0) {
            appcan.window.openToast('请选择要提交的意向单', '1000', '5', '0');
            return;
        }

        var oils = oillist.join(',');

        var ptype = appcan.locStorage.getVal("paytype");
        if (ptype == null) {
            ptype = 2;
        }
        if (oillist.length == 0) {
            uexWindow.alert("提示", "您没有需要提交的意向单！", "确定");
            return;
        }

        if ($("#checkRed2")[0].className == "m-check") {
            uexWindow.alert("提示", "请同意协议并勾选！", "确定");
            return;
        }

        var cusId = appcan.locStorage.getVal("cusId"),
            url = URL + "/app/bill/insertOrder",
            paramJsonStr = "cusId=" + cusId + "&oils=" + oils + "&payType=" + ptype + "&remark=" + remark,
            func =
            insertOrderCallBack,
            dataType = "text";
        $("#heji").html('');
        ajaxPostQuery(url, paramJsonStr, func, dataType);
        appcan.window.openToast('正在提交订单...', '0', '5', '1');
    })

    function insertOrderCallBack(data) {
        appcan.window.publish("tiaoguo", true);

        appcan.window.closeToast();
        if (data == "ok") {
            appcan.locStorage.remove("fangshi");
            oneAlert("您的意向单已提交，客户经理会尽快为您处理!", "确定");
            reload();

        } else {
            oneAlert("意向单提交失败，请稍后重试！!", "确定");
        }
    }

    var yesNo = 0;
    //全选
    appcan.button("#checkall", "ani-act", function () {
        if ($("#checkall")[0].className == "m-check") {

            $("#checkall")[0].className = "m-check m-check-active";

            for (var i = 0; i < LISTDATA.length; i++) {
                if ($("#" + i)[0]) {
                    $("#" + i)[0].className = "m-check m-check-active";
                }
            }

        } else {
            $("#checkall")[0].className = "m-check";
            for (var i = 0; i < LISTDATA.length; i++) {
                if ($("#" + i)[0]) {
                    $("#" + i)[0].className = "m-check";
                }
            }
        }
        heji();
        yesNo = 0;
    })

    function heji() {
        var sum = 0.00;
        for (var i = 0; i < LISTDATA.length; i++) {
            if ($("#" + i)[0] && $("#" + i)[0].className == "m-check m-check-active") {
                if ($("#price" + i)[0]) {
                    var pLast = $("#price" + i)[0].innerHTML;
                    var p = rmoney(pLast);
                    sum += Number(p);
                }
            }
        }
        var money = fmoney(sum, 2);

        $("#heji").html(money);

    }


    //列表中单选
    function cellbtnClick(id) {

        var index = id.substring(id.length - 1, id.length);

        if ($("#" + index)[0].className == "m-check") {
            $("#" + index)[0].className = "m-check m-check-active";
            yesNo++;

        } else {
            $("#" + index)[0].className = "m-check";
            yesNo--;

        }
        heji();
        if (yesNo == LISTDATA.length) {
            $("#checkall")[0].className = "m-check m-check-active";
        } else {
            $("#checkall")[0].className = "m-check";
        }
    }


    //配送自提
    function typeBtnClick(id) {
        //隐藏bug
        var index = id.substring(id.length - 1, id.length);
        if ($("#peisong" + index)[0].classList.contains('focus')) {
            //自提
            $("#peisong" + index)[0].className = "s-item nofocus l-radius";
            $("#ziti" + index)[0].className = "s-item focus r-radius";
            $("#pz" + index)[0].innerHTML = "自提";
            var price_old = rmoney($("#oilPrices" + index)[0].innerHTML);

            var pickupDiscount = rmoney($("#pickupDiscount" + index)[0].innerHTML);
            var LastPrice = fmoney(Number(price_old) - Number(pickupDiscount), 2);
            $("#oilPrices" + index)[0].innerHTML = LastPrice;

        } else if ($("#peisong" + index)[0].classList.contains('nofocus')) {

            $("#peisong" + index)[0].className = "s-item focus l-radius";
            $("#ziti" + index)[0].className = "s-item nofocus r-radius";
            $("#pz" + index)[0].innerHTML = "配送";
            var price_old = $("#oilPrices" + index)[0].innerHTML;
            var pickupDiscount = $("#pickupDiscount" + index)[0].innerHTML;
            var LastPrice = rmoney(price_old) + Number(pickupDiscount);
            $("#oilPrices" + index)[0].innerHTML = fmoney(LastPrice, 2);

        }
    }

    var ids = [];
    //删除该行数据
    function deletecell(id) {
        if (id == "confirmYXD") {
            return;
        }
        var delList = [];
        for (var i = 0; i < LISTDATA.length; i++) {
            if ($("#" + i)[0].className == "m-check m-check-active") {
                LISTDATA["intentionId"] = $("#intentionId" + i)[0].innerText;
                delList.push(LISTDATA["intentionId"]);
                ids.push(i);
            }
        }
        var idstr = delList.join(','),
            url = URL + "/app/bill/newDeleteBill",
            paramJsonStr = "id=" + idstr,
            func = newDeleteBillCallBack,
            dataType = "text";
        ajaxPostQuery(url, paramJsonStr, func, dataType);
        openToast("正在删除订单数据");
    }

    function newDeleteBillCallBack(data) {
        closeToast();
        if (data == "ok") {
            for (var i = 0; i < ids.length; i++) {
                $("#" + ids[i])[0].className = "m-check";
                $("#detailbox" + ids[i]).slideUp(500, function () {
                    $("#detailbox" + ids[i]).remove();
                });
            }
            ids = [];
        }
        heji();

    }

    // 备注文字改变
    function beizhuChange() {
        remark = $("textarea")[0].value;
    }

    //阅读选中
    function checkRed() {

        if ($("#checkRed2")[0].className == "m-check") {
            $("#checkRed2")[0].className = "m-check m-check-active";
        } else {
            $("#checkRed2")[0].className = "m-check";
        }
    }
    //打开协议页面
    function showPic() {
        appcan.window.open("managerEvaluate", "agreement.html", 10);
    }
</script>

</html>